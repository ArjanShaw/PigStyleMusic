<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PigStyle Music</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <script src="/static/js/app-config.js"></script>
    <style>
        /* Status Badge Styles */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }
        .status-badge.active { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-badge.new { background: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        .status-badge.sold { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .status-badge.removed { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        /* Price Input Step Styling */
        input[type="number"][step="1"] {
            -moz-appearance: textfield;
        }
        input[type="number"][step="1"]::-webkit-inner-spin-button,
        input[type="number"][step="1"]::-webkit-outer-spin-button {
            opacity: 1;
            height: 24px;
        }

        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 0;
            border-top: 1px solid #ddd;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pagination-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            color: #333;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            min-width: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #ccc;
        }

        .pagination-btn.active {
            background: #007bff;
            border-color: #0056b3;
            color: white;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-ellipsis {
            color: #666;
            padding: 0 5px;
        }

        .pagination-size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 14px;
        }

        .pagination-size-selector select {
            background: white;
            border: 1px solid #ddd;
            color: #333;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .pagination-size-selector select:hover {
            background: #f8f9fa;
        }

        .pagination-size-selector select:focus {
            outline: none;
            border-color: #007bff;
        }

        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .pagination-controls {
                width: 100%;
                justify-content: center;
            }
        }

        /* New Layout Styles */
        .dashboard-main {
            display: flex;
            flex-direction: column;
            gap: 30px;
            padding: 20px;
            background: white;
            color: #333;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .filters-section {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .filters-row {
            display: flex;
            gap: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .filter-group select {
            background: white;
            border: 1px solid #ddd;
            color: #333;
            padding: 8px 12px;
            border-radius: 4px;
            min-width: 180px;
            cursor: pointer;
        }

        .status-filters {
            display: flex;
            gap: 15px;
        }

        .status-filter-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #333;
            cursor: pointer;
        }

        .status-filter-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .search-section {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .search-options-row {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .search-field-select {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
        }

        .search-field-select select {
            background: white;
            border: 1px solid #ddd;
            color: #333;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .search-form {
            display: flex;
            gap: 10px;
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #333;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #bd2130;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }

        .inventory-table-container {
            overflow-x: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
        }

        .inventory-table th {
            text-align: left;
            padding: 12px;
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }

        .inventory-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            color: #333;
        }

        .inventory-table tr:hover {
            background: #f8f9fa;
        }

        .record-image-small {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .table-action-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
        }

        .table-action-btn:hover {
            color: #0056b3;
        }

        .table-action-btn.delete-btn {
            color: #dc3545;
        }

        .table-action-btn.delete-btn:hover {
            color: #bd2130;
        }

        .commission-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .barcode-value {
            font-family: monospace;
            font-size: 12px;
            background: #f8f9fa;
            padding: 3px 6px;
            border-radius: 3px;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #007bff;
        }

        .no-records {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .no-records i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #999;
        }

        .guest-message {
            display: none;
            text-align: center;
            padding: 60px 20px;
            background: white;
        }

        .login-prompt {
            max-width: 500px;
            margin: 0 auto;
            padding: 40px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .login-prompt h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .login-prompt p {
            color: #666;
            margin-bottom: 30px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* Search active indicator */
        .search-active {
            background-color: #e8f0fe;
            border-left: 3px solid #007bff;
        }
        
        .clear-search-btn {
            margin-left: 10px;
            font-size: 12px;
            padding: 2px 8px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="/">PigStyle Music</a>
        </div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/catalog">Catalog</a>
            <a href="/streaming">Streaming</a>
            <a href="/consignment">Consignment</a>
            <div id="auth-section">DASHBOARD</div>
        </div>
    </nav>

    <div id="guest-message" class="guest-message">
        <div class="login-prompt">
            <h1>Welcome to PigStyle Music</h1>
            <p>This dashboard is for registered users only. Please log in to access inventory management.</p>
            <a href="/login-page" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i> Log In to Continue
            </a>
        </div>
    </div>

    <div id="dashboard-content" class="dashboard-main" style="display: none;">
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="total-records">0</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="commission-rate">20.0%</div>
                <div class="stat-label">Commission Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="store-fill">0%</div>
                <div class="stat-label">Store Fill</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="last-added">--</div>
                <div class="stat-label">Last Added</div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section" id="filters-section">
            <div class="filters-row">
                <!-- Consignor Filter (Admin Only) -->
                <div id="consignor-filter-container" class="filter-group" style="display: none;">
                    <label for="consignor-filter"><i class="fas fa-user"></i> Consignor:</label>
                    <select id="consignor-filter">
                        <option value="all">All Consignors</option>
                    </select>
                </div>
                
                <!-- Status Filters -->
                <div class="filter-group">
                    <label><i class="fas fa-filter"></i> Status:</label>
                    <div class="status-filters">
                        <label class="status-filter-checkbox">
                            <input type="checkbox" value="new" checked> New
                        </label>
                        <label class="status-filter-checkbox">
                            <input type="checkbox" value="active" checked> Active
                        </label>
                        <label class="status-filter-checkbox">
                            <input type="checkbox" value="sold" checked> Sold
                        </label>
                        <label class="status-filter-checkbox">
                            <input type="checkbox" value="removed" checked> Removed
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="search-options-row">
                <div class="search-field-select">
                    <label for="searchField"><i class="fas fa-search"></i> Search by:</label>
                    <select id="searchField" class="search-field-select">
                        <option value="all">Barcode, Artist, or Title</option>
                        <option value="barcode">Barcode</option>
                        <option value="artist">Artist</option>
                        <option value="title">Title</option>
                    </select>
                </div>
                
                <form class="search-form" id="searchForm">
                    <input type="text" 
                           class="search-input" 
                           id="searchInput" 
                           placeholder="Enter barcode, artist, or title to filter table...">
                    <div class="action-buttons">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Filter
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearSearch">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </form>
            </div>
            <div id="search-status" style="margin-top: 10px; font-size: 13px; color: #666; display: none;"></div>
        </div>

        <!-- Inventory Table -->
        <div class="inventory-table-container">
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Artist</th>
                        <th>Title</th>
                        <th>Genre</th>
                        <th>Condition</th>
                        <th>Price</th>
                        <th>Commission</th>
                        <th>Status</th>
                        <th>Catalog #</th>
                        <th>Barcode</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-table-body"></tbody>
            </table>

            <!-- Loading State -->
            <div id="inventory-loading" class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading inventory...</p>
            </div>

            <!-- Empty State -->
            <div id="inventory-empty" class="no-records" style="display: none;">
                <i class="fas fa-box-open"></i>
                <p>No records found in inventory</p>
            </div>
        </div>

        <!-- Pagination Controls for Inventory -->
        <div id="inventory-pagination" class="pagination-container" style="display: none;">
            <div class="pagination-info" id="pagination-info">
                Showing 0-0 of 0 records
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn" id="page-first" title="First Page">
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button class="pagination-btn" id="page-prev" title="Previous Page">
                    <i class="fas fa-angle-left"></i>
                </button>
                <div id="page-numbers" style="display: flex; gap: 5px; align-items: center;"></div>
                <button class="pagination-btn" id="page-next" title="Next Page">
                    <i class="fas fa-angle-right"></i>
                </button>
                <button class="pagination-btn" id="page-last" title="Last Page">
                    <i class="fas fa-angle-double-right"></i>
                </button>
            </div>
            <div class="pagination-size-selector">
                <label for="page-size">Records per page:</label>
                <select id="page-size">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="250">250</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // API UTILITY FUNCTIONS
        // ============================================================================
        
        const APIUtils = {
            baseUrl: AppConfig.baseUrl,
            
            getHeaders() {
                const headers = {
                    'Content-Type': 'application/json',
                };
                
                const token = localStorage.getItem('auth_token');
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                return headers;
            },
            
            async request(method, endpoint, data = null, queryParams = null) {
                let url = `${this.baseUrl}${endpoint}`;
                
                if (queryParams) {
                    const params = new URLSearchParams(queryParams).toString();
                    url += `?${params}`;
                }
                
                const options = {
                    method: method,
                    headers: this.getHeaders(),
                    credentials: 'include'
                };
                
                if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(url, options);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'error') {
                    throw new Error(result.error || 'API returned error status');
                }
                
                return result;
            },
            
            async get(endpoint, queryParams = null) {
                return this.request('GET', endpoint, null, queryParams);
            },
            
            async post(endpoint, data) {
                return this.request('POST', endpoint, data);
            },
            
            async put(endpoint, data) {
                return this.request('PUT', endpoint, data);
            },
            
            async delete(endpoint) {
                return this.request('DELETE', endpoint);
            }
        };

        // ============================================================================
        // AUTH HELPER
        // ============================================================================
        
        // Check if Auth already exists to prevent redeclaration
        if (typeof window.Auth === 'undefined') {
            window.Auth = {
                isLoggedIn: true,
                user: { id: 1, role: 'admin', name: 'Admin User' },
                
                async checkSession() {
                    // In a real app, this would verify the token with the server
                    const token = localStorage.getItem('auth_token');
                    if (token) {
                        this.isLoggedIn = true;
                        try {
                            const response = await APIUtils.get('/auth/me');
                            if (response.status === 'success' && response.user) {
                                this.user = response.user;
                            }
                        } catch (error) {
                            console.error('Auth check failed:', error);
                        }
                    }
                    return this.isLoggedIn;
                },
                
                getUser() {
                    return this.user;
                },
                
                isAdmin() {
                    return this.user && this.user.role === 'admin';
                }
            };
        }

        // ============================================================================
        // PAGINATION MANAGER CLASS
        // ============================================================================
        
        class PaginationManager {
            constructor(containerId, onPageChange) {
                this.container = document.getElementById(containerId);
                this.onPageChange = onPageChange;
                this.currentPage = 1;
                this.pageSize = 50;
                this.totalItems = 0;
                this.totalPages = 0;
                this.items = [];
                
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('page-first')?.addEventListener('click', () => {
                    if (this.currentPage !== 1) {
                        this.goToPage(1);
                    }
                });

                document.getElementById('page-prev')?.addEventListener('click', () => {
                    if (this.currentPage > 1) {
                        this.goToPage(this.currentPage - 1);
                    }
                });

                document.getElementById('page-next')?.addEventListener('click', () => {
                    if (this.currentPage < this.totalPages) {
                        this.goToPage(this.currentPage + 1);
                    }
                });

                document.getElementById('page-last')?.addEventListener('click', () => {
                    if (this.currentPage !== this.totalPages) {
                        this.goToPage(this.totalPages);
                    }
                });

                document.getElementById('page-size')?.addEventListener('change', (e) => {
                    this.pageSize = parseInt(e.target.value);
                    this.currentPage = 1;
                    if (this.onPageChange) {
                        this.onPageChange(this.currentPage, this.pageSize);
                    }
                });
            }

            setItems(items) {
                this.items = items || [];
                this.totalItems = this.items.length;
                this.totalPages = Math.ceil(this.totalItems / this.pageSize);
                
                if (this.currentPage > this.totalPages) {
                    this.currentPage = Math.max(1, this.totalPages);
                }
                
                this.render();
                return this.getCurrentPageItems();
            }

            getCurrentPageItems() {
                const start = (this.currentPage - 1) * this.pageSize;
                const end = start + this.pageSize;
                return this.items.slice(start, end);
            }

            goToPage(page) {
                if (page < 1 || page > this.totalPages) return;
                
                this.currentPage = page;
                const pageItems = this.getCurrentPageItems();
                
                if (this.onPageChange) {
                    this.onPageChange(this.currentPage, this.pageSize, pageItems);
                }
                
                this.render();
            }

            render() {
                if (!this.container) return;
                
                if (this.totalItems === 0) {
                    this.container.style.display = 'none';
                    return;
                }

                this.container.style.display = 'flex';
                
                // Update info text
                const start = (this.currentPage - 1) * this.pageSize + 1;
                const end = Math.min(this.currentPage * this.pageSize, this.totalItems);
                document.getElementById('pagination-info').textContent = 
                    `Showing ${start}-${end} of ${this.totalItems} records`;

                // Update button states
                document.getElementById('page-first').disabled = this.currentPage === 1;
                document.getElementById('page-prev').disabled = this.currentPage === 1;
                document.getElementById('page-next').disabled = this.currentPage === this.totalPages;
                document.getElementById('page-last').disabled = this.currentPage === this.totalPages;

                // Render page numbers
                this.renderPageNumbers();
            }

            renderPageNumbers() {
                const pageNumbersContainer = document.getElementById('page-numbers');
                if (!pageNumbersContainer) return;

                let html = '';
                const maxVisiblePages = 5;
                
                if (this.totalPages <= maxVisiblePages + 2) {
                    // Show all pages
                    for (let i = 1; i <= this.totalPages; i++) {
                        html += this.getPageButtonHtml(i);
                    }
                } else {
                    // Show first page
                    html += this.getPageButtonHtml(1);
                    
                    if (this.currentPage > 3) {
                        html += '<span class="pagination-ellipsis">...</span>';
                    }
                    
                    // Show pages around current page
                    let start = Math.max(2, this.currentPage - 1);
                    let end = Math.min(this.totalPages - 1, this.currentPage + 1);
                    
                    for (let i = start; i <= end; i++) {
                        html += this.getPageButtonHtml(i);
                    }
                    
                    if (this.currentPage < this.totalPages - 2) {
                        html += '<span class="pagination-ellipsis">...</span>';
                    }
                    
                    // Show last page
                    if (this.totalPages > 1) {
                        html += this.getPageButtonHtml(this.totalPages);
                    }
                }
                
                pageNumbersContainer.innerHTML = html;
                
                // Add click handlers to page buttons
                document.querySelectorAll('.page-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const page = parseInt(btn.getAttribute('data-page'));
                        this.goToPage(page);
                    });
                });
            }

            getPageButtonHtml(page) {
                const isActive = page === this.currentPage;
                return `<button class="pagination-btn page-btn ${isActive ? 'active' : ''}" data-page="${page}">${page}</button>`;
            }
        }

        // ============================================================================
        // INVENTORY MANAGER CLASS
        // ============================================================================
        
        class InventoryManager {
            constructor() {
                this.currentSearchField = 'all';
                this.currentSearchTerm = '';
                this.currentResults = [];
                this.genres = [];
                this.conditions = [];
                this.statuses = ['new', 'active', 'sold', 'removed'];
                this.selectedStatuses = ['new', 'active', 'sold', 'removed'];
                this.commissionRate = 0.20;
                this.consignors = [];
                this.selectedConsignorId = 'all';
                this.minimumPrice = 1.99;
                this.allInventoryRecords = [];
                this.filteredInventoryRecords = [];
                
                // Initialize pagination for inventory
                this.inventoryPagination = new PaginationManager('inventory-pagination', 
                    (page, pageSize, pageItems) => {
                        this.renderInventoryPage(pageItems);
                    }
                );
                
                this.init();
            }

            async init() {
                await window.Auth.checkSession();
                
                if (window.Auth.isLoggedIn) {
                    console.log('INIT: User authenticated, showing dashboard');
                    await this.loadMinimumPrice();
                    this.showDashboard();
                    await this.loadStats();
                    await this.loadGenres();
                    this.loadConditions();
                    this.setupEventListeners();
                    await this.loadConsignors();
                    await this.loadInventory();
                } else {
                    console.log('INIT: User not authenticated, showing guest message');
                    this.showGuestMessage();
                }
            }

            async loadMinimumPrice() {
                try {
                    const response = await APIUtils.get('/config/MIN_STORE_PRICE');
                    this.minimumPrice = parseFloat(response.config_value) || 1.99;
                    console.log(`MIN_PRICE: Minimum store price loaded: $${this.minimumPrice.toFixed(2)}`);
                } catch (error) {
                    console.warn('MIN_PRICE: Could not load MIN_STORE_PRICE, using default:', error);
                    this.minimumPrice = 1.99;
                }
            }

            showDashboard() {
                document.getElementById('guest-message').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
            }

            showGuestMessage() {
                document.getElementById('guest-message').style.display = 'block';
                document.getElementById('dashboard-content').style.display = 'none';
            }

            setupEventListeners() {
                document.getElementById('searchField').addEventListener('change', (e) => {
                    this.currentSearchField = e.target.value;
                    this.updateSearchPlaceholder();
                });

                document.getElementById('searchForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const searchTerm = document.getElementById('searchInput').value.trim();
                    
                    if (!searchTerm) {
                        this.showMessage('Please enter a search term', 'error');
                        return;
                    }

                    await this.filterTableBySearch(searchTerm);
                });

                document.getElementById('clearSearch').addEventListener('click', () => {
                    document.getElementById('searchInput').value = '';
                    this.clearSearch();
                });

                const consignorFilter = document.getElementById('consignor-filter');
                if (consignorFilter) {
                    consignorFilter.addEventListener('change', (e) => {
                        this.selectedConsignorId = e.target.value;
                        this.loadInventory();
                    });
                }

                // Status filter checkboxes
                document.querySelectorAll('.status-filter-checkbox input').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const status = e.target.value;
                        if (e.target.checked) {
                            this.selectedStatuses.push(status);
                        } else {
                            this.selectedStatuses = this.selectedStatuses.filter(s => s !== status);
                        }
                        this.filterInventoryByStatus();
                    });
                });

                this.updateSearchPlaceholder();
            }

            filterInventoryByStatus() {
                if (this.selectedStatuses.length === 0) {
                    // If no statuses selected, show empty
                    document.getElementById('inventory-table-body').innerHTML = '';
                    document.getElementById('inventory-empty').style.display = 'block';
                    document.getElementById('inventory-pagination').style.display = 'none';
                    return;
                }

                // Start with all records
                let filtered = this.allInventoryRecords;
                
                // Apply status filter
                filtered = filtered.filter(record => {
                    const status = (record.status_name || 'active').toLowerCase();
                    return this.selectedStatuses.includes(status);
                });
                
                // Store filtered records
                this.filteredInventoryRecords = filtered;

                if (filtered.length === 0) {
                    document.getElementById('inventory-table-body').innerHTML = '';
                    document.getElementById('inventory-empty').style.display = 'block';
                    document.getElementById('inventory-pagination').style.display = 'none';
                } else {
                    const pageItems = this.inventoryPagination.setItems(filtered);
                    this.renderInventoryPage(pageItems);
                }
            }

            updateSearchPlaceholder() {
                const searchInput = document.getElementById('searchInput');
                const searchField = this.currentSearchField;
                
                switch(searchField) {
                    case 'barcode':
                        searchInput.placeholder = 'Enter barcode to filter...';
                        break;
                    case 'artist':
                        searchInput.placeholder = 'Enter artist name to filter...';
                        break;
                    case 'title':
                        searchInput.placeholder = 'Enter album title to filter...';
                        break;
                    case 'all':
                    default:
                        searchInput.placeholder = 'Enter barcode, artist, or title to filter...';
                        break;
                }
            }

            async loadConsignors() {
                const user = window.Auth.getUser();
                if (user.role === 'admin') {
                    try {
                        const response = await APIUtils.get('/api/consignor/records');
                        console.log('LOAD_CONSIGNORS: Response from /api/consignor/records:', response);
                        
                        if (response && response.records) {
                            const consignorMap = {};
                            response.records.forEach(record => {
                                if (record.consignor_id && record.consignor_name) {
                                    if (!consignorMap[record.consignor_id]) {
                                        consignorMap[record.consignor_id] = {
                                            id: record.consignor_id,
                                            name: record.consignor_name,
                                            email: record.consignor_email || ''
                                        };
                                    }
                                }
                            });
                            
                            this.consignors = Object.values(consignorMap);
                            
                            const filterContainer = document.getElementById('consignor-filter-container');
                            const filterSelect = document.getElementById('consignor-filter');
                            
                            if (this.consignors.length > 0) {
                                filterContainer.style.display = 'flex';
                                filterSelect.innerHTML = '<option value="all">All Consignors</option>' +
                                    this.consignors.map(consignor => 
                                        `<option value="${consignor.id}">${consignor.name}</option>`
                                    ).join('');
                            } else {
                                filterContainer.style.display = 'none';
                            }
                        }
                    } catch (error) {
                        console.error('LOAD_CONSIGNORS: Error loading consignors:', error);
                        document.getElementById('consignor-filter-container').style.display = 'none';
                    }
                } else {
                    // Hide consignor filter for non-admin users
                    document.getElementById('consignor-filter-container').style.display = 'none';
                }
            }

            async loadInventory() {
                const user = window.Auth.getUser();
                const loadingDiv = document.getElementById('inventory-loading');
                const emptyDiv = document.getElementById('inventory-empty');
                const tableBody = document.getElementById('inventory-table-body');
                const searchStatus = document.getElementById('search-status');
                
                loadingDiv.style.display = 'block';
                emptyDiv.style.display = 'none';
                tableBody.innerHTML = '';
                if (searchStatus) searchStatus.style.display = 'none';
                
                try {
                    if (user.role === 'admin') {
                        if (this.selectedConsignorId !== 'all') {
                            const allRecords = await APIUtils.get('/records', { 
                                order_by: 'created_at', 
                                order: 'desc' 
                            });
                            this.allInventoryRecords = allRecords.records ? allRecords.records.filter(record => 
                                record.consignor_id == this.selectedConsignorId
                            ) : [];
                        } else {
                            const response = await APIUtils.get('/records', { 
                                order_by: 'created_at', 
                                order: 'desc' 
                            });
                            this.allInventoryRecords = response.records || [];
                        }
                    } else {
                        const response = await APIUtils.get(`/records/user/${user.id}`, {
                            order_by: 'created_at',
                            order: 'desc'
                        });
                        this.allInventoryRecords = response.records || [];
                    }
                    
                    loadingDiv.style.display = 'none';
                    
                    if (this.allInventoryRecords.length === 0) {
                        emptyDiv.style.display = 'block';
                        document.getElementById('inventory-pagination').style.display = 'none';
                        return;
                    }
                    
                    // Initialize filtered records with all records
                    this.filteredInventoryRecords = [...this.allInventoryRecords];
                    
                    // Apply status filter
                    this.filterInventoryByStatus();
                    
                    console.log('INVENTORY: Loaded', this.allInventoryRecords.length, 'records');
                } catch (error) {
                    console.error('LOAD_INVENTORY: Error loading inventory:', error);
                    loadingDiv.style.display = 'none';
                    emptyDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 15px; color: #dc3545;"></i>
                        <p>Error loading inventory: ${error.message}</p>
                    `;
                    emptyDiv.style.display = 'block';
                    document.getElementById('inventory-pagination').style.display = 'none';
                }
            }

            async filterTableBySearch(searchTerm) {
                const loadingDiv = document.getElementById('inventory-loading');
                const emptyDiv = document.getElementById('inventory-empty');
                const tableBody = document.getElementById('inventory-table-body');
                const searchStatus = document.getElementById('search-status');
                
                this.currentSearchTerm = searchTerm;
                
                console.log('FILTER_SEARCH: Starting filter for:', searchTerm);
                console.log('FILTER_SEARCH: Search field:', this.currentSearchField);

                // Show loading
                loadingDiv.style.display = 'block';
                tableBody.innerHTML = '';
                emptyDiv.style.display = 'none';
                
                try {
                    const user = window.Auth.getUser();
                    let params = { 
                        q: searchTerm,
                        search_field: this.currentSearchField
                    };
                    
                    if (user.role === 'consignor') {
                        params.user_id = user.id;
                    }
                    
                    const response = await APIUtils.get('/records/search', params);
                    
                    loadingDiv.style.display = 'none';
                    
                    if (response.status === 'success' && response.records && response.records.length > 0) {
                        // Get the search result IDs
                        const searchResultIds = new Set(response.records.map(r => r.id));
                        
                        // Filter the inventory records to only show those that match the search
                        const filteredRecords = this.allInventoryRecords.filter(record => 
                            searchResultIds.has(record.id)
                        );
                        
                        // Further filter by status
                        const statusFiltered = filteredRecords.filter(record => {
                            const status = (record.status_name || 'active').toLowerCase();
                            return this.selectedStatuses.includes(status);
                        });
                        
                        // Update filtered records
                        this.filteredInventoryRecords = statusFiltered;
                        
                        if (statusFiltered.length === 0) {
                            emptyDiv.style.display = 'block';
                            emptyDiv.innerHTML = `
                                <i class="fas fa-search"></i>
                                <p>No records match your search: "${searchTerm}"</p>
                                <p><small>Try different search terms or clear the search</small></p>
                                <button class="btn btn-secondary btn-small clear-search-btn" onclick="window.inventoryManager.clearSearch()">
                                    <i class="fas fa-times"></i> Clear Search
                                </button>
                            `;
                            document.getElementById('inventory-pagination').style.display = 'none';
                        } else {
                            // Update pagination with filtered records
                            const pageItems = this.inventoryPagination.setItems(statusFiltered);
                            this.renderInventoryPage(pageItems);
                            
                            // Show search status
                            if (searchStatus) {
                                searchStatus.innerHTML = `
                                    <i class="fas fa-filter"></i> 
                                    Showing ${statusFiltered.length} records matching "${searchTerm}" 
                                    <button class="btn btn-secondary btn-small" onclick="window.inventoryManager.clearSearch()">
                                        <i class="fas fa-times"></i> Clear
                                    </button>
                                `;
                                searchStatus.style.display = 'block';
                            }
                        }
                    } else {
                        // No results from API
                        emptyDiv.style.display = 'block';
                        emptyDiv.innerHTML = `
                            <i class="fas fa-search"></i>
                            <p>No records match your search: "${searchTerm}"</p>
                            <p><small>Try different search terms or clear the search</small></p>
                            <button class="btn btn-secondary btn-small clear-search-btn" onclick="window.inventoryManager.clearSearch()">
                                <i class="fas fa-times"></i> Clear Search
                            </button>
                        `;
                        document.getElementById('inventory-pagination').style.display = 'none';
                        this.filteredInventoryRecords = [];
                    }
                } catch (error) {
                    console.error('FILTER_SEARCH: Error filtering table:', error);
                    loadingDiv.style.display = 'none';
                    emptyDiv.style.display = 'block';
                    emptyDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                        <p>Error searching: ${error.message}</p>
                        <button class="btn btn-secondary btn-small" onclick="window.inventoryManager.clearSearch()">
                            <i class="fas fa-times"></i> Clear Search
                        </button>
                    `;
                }
            }

            clearSearch() {
                // Clear search input
                document.getElementById('searchInput').value = '';
                this.currentSearchTerm = '';
                
                // Hide search status
                const searchStatus = document.getElementById('search-status');
                if (searchStatus) {
                    searchStatus.style.display = 'none';
                    searchStatus.innerHTML = '';
                }
                
                // Restore status-filtered view
                this.filterInventoryByStatus();
                
                this.showMessage('Search cleared', 'info');
            }

            renderInventoryPage(records) {
                const tableBody = document.getElementById('inventory-table-body');
                const emptyDiv = document.getElementById('inventory-empty');
                
                if (records.length === 0) {
                    tableBody.innerHTML = '';
                    emptyDiv.style.display = 'block';
                    return;
                }
                
                emptyDiv.style.display = 'none';
                
                // Get commission rate for display
                const commissionRate = this.commissionRate;
                
                tableBody.innerHTML = records.map(record => {
                    const barcodeDisplay = record.barcode ? 
                        `<span class="barcode-value" title="${record.barcode}">${record.barcode}</span>` : 
                        'N/A';
                    
                    const statusName = (record.status_name || 'active').toLowerCase();
                    const statusClass = statusName.replace(/\s+/g, '-');
                    const displayStatus = record.status_name || 'Active';
                    
                    return `
                    <tr>
                        <td>
                            ${record.image_url ? 
                                `<img src="${record.image_url}" alt="${record.artist}" class="record-image-small" 
                                      onerror="this.src='https://via.placeholder.com/60x60/eee/ccc?text=No+Image'">` : 
                                `<div class="record-image-small" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-record-vinyl" style="font-size: 24px; color: #999;"></i>
                                </div>`
                            }
                        </td>
                        <td>${record.artist || 'N/A'}</td>
                        <td>${record.title || 'N/A'}</td>
                        <td>${record.genre_name || 'N/A'}</td>
                        <td>${record.condition || 'N/A'}</td>
                        <td>$${(record.store_price || 0).toFixed(2)}</td>
                        <td>
                            <span class="commission-badge">${(commissionRate * 100).toFixed(1)}%</span>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">${displayStatus}</span>
                        </td>
                        <td>${record.catalog_number || 'N/A'}</td>
                        <td>${barcodeDisplay}</td>
                        <td>
                            <div class="table-actions">
                                <button class="table-action-btn" onclick="window.inventoryManager.editRecord(${record.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="table-action-btn delete-btn" onclick="window.inventoryManager.deleteRecord(${record.id}, true)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `}).join('');
            }

            async loadStats() {
                const user = window.Auth.getUser();
                
                let recordsCount = 0;
                if (user.role === 'admin') {
                    const response = await APIUtils.get('/records/count');
                    recordsCount = response.count || 0;
                } else {
                    const response = await APIUtils.get(`/records/user/${user.id}`);
                    recordsCount = response.records ? response.records.length : 0;
                }
                
                document.getElementById('total-records').textContent = recordsCount;

                const commissionResponse = await APIUtils.get('/api/commission-rate');
                this.commissionRate = commissionResponse.commission_rate / 100;
                document.getElementById('commission-rate').textContent = 
                    `${commissionResponse.commission_rate }%`;

                if (user.role === 'admin') {
                    const configResponse = await APIUtils.get('/config/STORE_CAPACITY');
                    const capacity = parseInt(configResponse.config_value);
                    const fillPercentage = (recordsCount / capacity * 100).toFixed(1);
                    document.getElementById('store-fill').textContent = `${fillPercentage}%`;
                } else {
                    document.getElementById('store-fill').textContent = 'N/A';
                }

                await this.loadLastAddedRecord();
            }

            async loadLastAddedRecord() {
                const user = window.Auth.getUser();
                let lastAdded = '--';
                
                if (user.role === 'admin') {
                    const response = await APIUtils.get('/records', { 
                        limit: 1, 
                        order_by: 'created_at', 
                        order: 'desc' 
                    });
                    
                    if (response.records && response.records.length > 0) {
                        const record = response.records[0];
                        lastAdded = `${record.artist.substring(0, 15)}...`;
                    }
                } else {
                    const response = await APIUtils.get(`/records/user/${user.id}`, {
                        limit: 1,
                        order_by: 'created_at',
                        order: 'desc'
                    });
                    
                    if (response.records && response.records.length > 0) {
                        const record = response.records[0];
                        lastAdded = `${record.artist.substring(0, 15)}...`;
                    }
                }
                
                document.getElementById('last-added').textContent = lastAdded;
            }

            async loadGenres() {
                console.log('LOAD_GENRES: Starting to load genres from /genres endpoint');
                const response = await APIUtils.get('/genres');
                console.log('LOAD_GENRES: Raw API response:', response);
                
                if (response && response.genres) {
                    this.genres = response.genres;
                    console.log('LOAD_GENRES: Genres loaded successfully:', this.genres);
                } else {
                    console.error('LOAD_GENRES: Invalid response format:', response);
                    this.genres = [];
                }
            }

            loadConditions() {
                const user = window.Auth.getUser();
                console.log('LOAD_CONDITIONS: User role:', user.role);
                
                const allConditions = [
                    'Mint (M)',
                    'Near Mint (NM or M-)',
                    'Very Good Plus (VG+)',
                    'Very Good (VG)',
                    'Good Plus (G+)',
                    'Good (G)',
                    'Fair (F)',
                    'Poor (P)'
                ];
                
                if (user.role === 'consignor') {
                    this.conditions = allConditions.slice(0, 4);
                } else {
                    this.conditions = allConditions;
                }
                
                console.log('LOAD_CONDITIONS: Conditions loaded:', this.conditions);
            }

            async editRecord(recordId) {
                // Perform search for the record
                await this.filterTableBySearch(recordId.toString());
                
                // Scroll to the record
                setTimeout(() => {
                    const recordRow = document.querySelector(`tr:has(.table-action-btn[onclick*="${recordId}"])`);
                    if (recordRow) {
                        recordRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        recordRow.style.backgroundColor = '#fff3cd';
                        setTimeout(() => {
                            recordRow.style.backgroundColor = '';
                        }, 2000);
                    }
                }, 500);
            }

            async deleteRecord(recordId, fromTable = false) {
                const response = await APIUtils.delete(`/records/${recordId}`);
                
                if (response.status === 'success') {
                    this.showMessage('Record deleted successfully!', 'success');
                    
                    // Remove from allInventoryRecords
                    this.allInventoryRecords = this.allInventoryRecords.filter(r => r.id != recordId);
                    
                    if (this.allInventoryRecords.length === 0) {
                        document.getElementById('inventory-table-body').innerHTML = '';
                        document.getElementById('inventory-empty').style.display = 'block';
                        document.getElementById('inventory-pagination').style.display = 'none';
                    } else {
                        // If there's an active search, reapply it
                        if (this.currentSearchTerm) {
                            await this.filterTableBySearch(this.currentSearchTerm);
                        } else {
                            // Otherwise just update status filter
                            this.filterInventoryByStatus();
                        }
                    }
                    
                    await this.loadStats();
                } else {
                    this.showMessage(`Error: ${response.error || 'Failed to delete record'}`, 'error');
                }
            }

            showMessage(message, type = 'info') {
                document.querySelectorAll('.message-popup').forEach(el => el.remove());
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message-popup message-${type}`;
                
                const colors = {
                    success: '#28a745',
                    error: '#dc3545',
                    warning: '#ffc107',
                    info: '#007bff'
                };
                
                messageDiv.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 100px;
                        right: 20px;
                        background: ${colors[type] || '#007bff'};
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                        z-index: 2000;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        max-width: 400px;
                        animation: slideIn 0.3s ease;
                    ">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}" 
                           style="font-size: 20px;"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(messageDiv);
                
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
        }

        // ============================================================================
        // INITIALIZE DASHBOARD
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM_LOADED: Initializing dashboard');
            window.inventoryManager = new InventoryManager();
            
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
                
                if (e.key === 'Escape') {
                    document.getElementById('searchInput').value = '';
                    window.inventoryManager.clearSearch();
                }
            });
        });
    </script>
</body>
</html>