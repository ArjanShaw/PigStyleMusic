<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PigStyle Music</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f7;
            color: #333;
            line-height: 1.6;
        }

        /* Navbar */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-brand {
            font-size: 24px;
            font-weight: bold;
        }

        .nav-brand a {
            color: white;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: opacity 0.3s;
        }

        .nav-links a:hover {
            opacity: 0.9;
        }

        #auth-section {
            margin-left: 20px;
        }

        /* Dashboard Container */
        .dashboard-container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Welcome Section */
        .welcome-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }

        .welcome-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .welcome-header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .welcome-header p {
            color: #666;
            font-size: 16px;
        }

        .role-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            color: white;
            font-size: 20px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        /* Action Cards */
        .action-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .action-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
            border-top: 3px solid #667eea;
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        }

        .action-card h3 {
            color: #333;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-card h3 i {
            color: #667eea;
        }

        .action-card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .action-button {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            transition: transform 0.2s, opacity 0.2s;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .action-button:hover {
            transform: translateY(-2px);
            opacity: 0.95;
        }

        .action-button:active {
            transform: translateY(0);
        }

        /* Admin Only Section */
        .admin-section {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
        }

        .admin-section h2 {
            color: white;
            font-size: 24px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .admin-action {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 20px;
            transition: background 0.3s;
        }

        .admin-action:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Recent Activity */
        .recent-activity {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 40px;
        }

        .recent-activity h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .activity-list {
            list-style: none;
        }

        .activity-item {
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background: #f8f9ff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #667eea;
        }

        .activity-content h4 {
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .activity-content p {
            color: #666;
            font-size: 14px;
        }

        .activity-time {
            color: #999;
            font-size: 12px;
            margin-left: auto;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .loading i {
            font-size: 40px;
            color: #667eea;
            margin-bottom: 20px;
        }

        /* Guest Message */
        .guest-message {
            text-align: center;
            padding: 80px 20px;
            max-width: 600px;
            margin: 50px auto;
        }

        .guest-message h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .guest-message p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
            font-size: 16px;
        }

        .login-prompt {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            border-top: 4px solid #667eea;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .navbar {
                padding: 0 15px;
                height: 60px;
            }

            .nav-links {
                gap: 15px;
                font-size: 14px;
            }

            .dashboard-container {
                padding: 0 15px;
                margin: 20px auto;
            }

            .welcome-section {
                padding: 20px;
            }

            .welcome-header h1 {
                font-size: 24px;
            }

            .quick-stats,
            .action-cards {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar will be populated by auth.js -->
    <nav class="navbar">
        <div class="nav-brand">
            <a href="/">PigStyle Music</a>
        </div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/catalog">Catalog</a>
            <a href="/streaming">Streaming</a>
            <a href="/consignment">Consignment</a>
            <div id="auth-section">
                <!-- Will be populated by auth.js -->
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- Guest Message (shown when not logged in) -->
        <div id="guest-message" class="guest-message" style="display: none;">
            <div class="login-prompt">
                <h1>Welcome to PigStyle Music</h1>
                <p>This dashboard is for registered users only. Please log in to access your personal dashboard, manage your consigned records, and view your store credit.</p>
                <p>If you don't have an account, please contact the store to get started with consignment.</p>
                <a href="/login" class="action-button">
                    <i class="fas fa-sign-in-alt"></i> Log In to Continue
                </a>
                <p style="margin-top: 30px; font-size: 14px;">
                    <a href="/" style="color: #667eea; text-decoration: none;">
                        <i class="fas fa-arrow-left"></i> Return to Home Page
                    </a>
                </p>
            </div>
        </div>

        <!-- Dashboard Content (shown when logged in) -->
        <div id="dashboard-content" class="dashboard-container" style="display: none;">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <div class="welcome-header">
                    <div>
                        <h1 id="welcome-title">Welcome!</h1>
                        <p id="welcome-subtitle">Manage your account and consignments</p>
                    </div>
                    <div id="role-badge" class="role-badge">Loading...</div>
                </div>
                <div id="user-stats" class="quick-stats">
                    <!-- Stats will be loaded here -->
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading your stats...</p>
                    </div>
                </div>
            </div>

            <!-- Action Cards -->
            <div class="action-cards">
                <!-- Consignor Actions -->
                <div class="action-card" data-require-role="consignor,admin">
                    <h3><i class="fas fa-record-vinyl"></i> My Records</h3>
                    <p>View and manage your consigned vinyl records, check their status, and see sales history.</p>
                    <a href="/consignment" class="action-button">
                        <i class="fas fa-eye"></i> View Records
                    </a>
                </div>

                <div class="action-card" data-require-role="consignor,admin">
                    <h3><i class="fas fa-plus-circle"></i> Add New Record</h3>
                    <p>Add a new vinyl record to your consignment collection. We'll handle the barcode and pricing.</p>
                    <button class="action-button" id="add-record-btn">
                        <i class="fas fa-plus"></i> Add Record
                    </button>
                </div>

                <div class="action-card" data-require-role="consignor,admin">
                    <h3><i class="fas fa-wallet"></i> Store Credit</h3>
                    <p>Check your current store credit balance and request payouts when ready.</p>
                    <div id="credit-balance">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading balance...</p>
                        </div>
                    </div>
                    <button class="action-button" id="payout-btn" style="margin-top: 10px;">
                        <i class="fas fa-money-check-alt"></i> Request Payout
                    </button>
                </div>

                <div class="action-card" data-require-role="consignor,admin">
                    <h3><i class="fas fa-chart-line"></i> Sales Reports</h3>
                    <p>View detailed reports of your sales performance and consignment history.</p>
                    <button class="action-button" id="reports-btn">
                        <i class="fas fa-chart-bar"></i> View Reports
                    </button>
                </div>
            </div>

            <!-- Admin Section -->
            <div id="admin-section" class="admin-section" data-require-role="admin" style="display: none;">
                <h2><i class="fas fa-crown"></i> Admin Controls</h2>
                <div class="admin-actions">
                    <div class="admin-action">
                        <h4><i class="fas fa-users"></i> User Management</h4>
                        <p>Manage all user accounts, roles, and permissions.</p>
                        <button class="action-button" id="manage-users-btn">
                            Manage Users
                        </button>
                    </div>

                    <div class="admin-action">
                        <h4><i class="fas fa-barcode"></i> Process Barcodes</h4>
                        <p>Assign barcodes to new records and update inventory status.</p>
                        <button class="action-button" id="process-barcodes-btn">
                            Process Barcodes
                        </button>
                    </div>

                    <div class="admin-action">
                        <h4><i class="fas fa-cog"></i> System Settings</h4>
                        <p>Configure store settings, commission rates, and other options.</p>
                        <button class="action-button" id="system-settings-btn">
                            System Settings
                        </button>
                    </div>

                    <div class="admin-action">
                        <h4><i class="fas fa-file-invoice-dollar"></i> Financial Reports</h4>
                        <p>Generate financial reports and process consignor payouts.</p>
                        <button class="action-button" id="financial-reports-btn">
                            Financial Reports
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="recent-activity" data-require-auth="true">
                <h2><i class="fas fa-history"></i> Recent Activity</h2>
                <div id="activity-list">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Record Modal -->
    <div id="add-record-modal" class="modal" style="display: none;">
        <!-- Modal content will be added by JavaScript -->
    </div>

    <script src="/static/js/auth.js"></script>
    <script>
        // Dashboard functionality
        const Dashboard = {
            async init() {
                await Auth.checkSession();
                
                if (Auth.isLoggedIn) {
                    this.showDashboard();
                    await this.loadUserData();
                    await this.loadUserStats();
                    await this.loadRecentActivity();
                    this.setupEventListeners();
                } else {
                    this.showGuestMessage();
                }
            },
            
            showDashboard() {
                document.getElementById('guest-message').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                
                // Update welcome message
                const user = Auth.getUser();
                document.getElementById('welcome-title').textContent = `Welcome, ${user.full_name || user.username}!`;
                document.getElementById('role-badge').textContent = user.role.toUpperCase();
            },
            
            showGuestMessage() {
                document.getElementById('guest-message').style.display = 'block';
                document.getElementById('dashboard-content').style.display = 'none';
            },
            
            async loadUserData() {
                try {
                    const response = await fetch('http://localhost:5000/api/protected/user-info', {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load user data');
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                }
            },
            
            async loadUserStats() {
                try {
                    const user = Auth.getUser();
                    
                    // Load user records count
                    const recordsResponse = await fetch(`http://localhost:5000/api/consignor/records`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    let activeRecords = 0;
                    let totalValue = 0;
                    
                    if (recordsResponse.ok) {
                        const recordsData = await recordsResponse.json();
                        activeRecords = recordsData.records.filter(r => r.status_id === 2).length;
                        totalValue = recordsData.records
                            .filter(r => r.status_id === 2)
                            .reduce((sum, r) => sum + (parseFloat(r.store_price) || 0), 0);
                    }
                    
                    // Update stats section
                    const statsHTML = `
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-record-vinyl"></i>
                            </div>
                            <div class="stat-value">${activeRecords}</div>
                            <div class="stat-label">Active Records</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-value">$${totalValue.toFixed(2)}</div>
                            <div class="stat-label">Total Value</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="stat-value">$${user.store_credit_balance.toFixed(2)}</div>
                            <div class="stat-label">Store Credit</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="stat-value">${await this.getCommissionRate()}%</div>
                            <div class="stat-label">Commission Rate</div>
                        </div>
                    `;
                    
                    document.getElementById('user-stats').innerHTML = statsHTML;
                    document.getElementById('credit-balance').innerHTML = `
                        <div class="stat-value" style="font-size: 28px; margin-bottom: 5px;">
                            $${user.store_credit_balance.toFixed(2)}
                        </div>
                        <div class="stat-label">Available Credit</div>
                    `;
                    
                } catch (error) {
                    console.error('Error loading user stats:', error);
                    document.getElementById('user-stats').innerHTML = `
                        <div class="stat-card">
                            <div class="stat-value">Error</div>
                            <div class="stat-label">Failed to load stats</div>
                        </div>
                    `;
                }
            },
            
            async getCommissionRate() {
                try {
                    const response = await fetch('http://localhost:5000/api/commission-rate', {
                        method: 'GET'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.commission_rate;
                    }
                } catch (error) {
                    console.error('Error getting commission rate:', error);
                }
                return '20.0';
            },
            
            async loadRecentActivity() {
                try {
                    const user = Auth.getUser();
                    
                    // In a real app, you would fetch actual activity data
                    // For now, we'll show sample data
                    const sampleActivities = [
                        {
                            icon: 'fas fa-plus-circle',
                            title: 'New Record Added',
                            description: 'Added "Dark Side of the Moon" to your consignment',
                            time: '2 hours ago'
                        },
                        {
                            icon: 'fas fa-dollar-sign',
                            title: 'Store Credit Updated',
                            description: 'Credit increased by $24.50 from a sale',
                            time: '1 day ago'
                        },
                        {
                            icon: 'fas fa-check-circle',
                            title: 'Record Activated',
                            description: 'Record #1045 is now available for sale',
                            time: '3 days ago'
                        },
                        {
                            icon: 'fas fa-file-signature',
                            title: 'Agreement Signed',
                            description: 'Master consignment agreement signed',
                            time: '1 week ago'
                        }
                    ];
                    
                    const activityHTML = sampleActivities.map(activity => `
                        <li class="activity-item">
                            <div class="activity-icon">
                                <i class="${activity.icon}"></i>
                            </div>
                            <div class="activity-content">
                                <h4>${activity.title}</h4>
                                <p>${activity.description}</p>
                            </div>
                            <div class="activity-time">${activity.time}</div>
                        </li>
                    `).join('');
                    
                    document.getElementById('activity-list').innerHTML = `
                        <ul class="activity-list">${activityHTML}</ul>
                    `;
                    
                } catch (error) {
                    console.error('Error loading activity:', error);
                }
            },
            
            setupEventListeners() {
                // Add Record Button
                document.getElementById('add-record-btn')?.addEventListener('click', () => {
                    if (Auth.canAccess('add_records')) {
                        this.showAddRecordModal();
                    } else {
                        alert('Please log in as a consignor to add records.');
                    }
                });
                
                // Payout Button
                document.getElementById('payout-btn')?.addEventListener('click', () => {
                    const user = Auth.getUser();
                    if (user.store_credit_balance > 0) {
                        if (confirm(`Request payout for $${user.store_credit_balance.toFixed(2)}?`)) {
                            this.requestPayout();
                        }
                    } else {
                        alert('You have no store credit available for payout.');
                    }
                });
                
                // Reports Button
                document.getElementById('reports-btn')?.addEventListener('click', () => {
                    alert('Sales reports feature coming soon!');
                });
                
                // Admin buttons
                document.getElementById('manage-users-btn')?.addEventListener('click', () => {
                    alert('User management feature coming soon!');
                });
                
                document.getElementById('process-barcodes-btn')?.addEventListener('click', () => {
                    alert('Barcode processing feature coming soon!');
                });
                
                document.getElementById('system-settings-btn')?.addEventListener('click', () => {
                    alert('System settings feature coming soon!');
                });
                
                document.getElementById('financial-reports-btn')?.addEventListener('click', () => {
                    alert('Financial reports feature coming soon!');
                });
            },
            
            showAddRecordModal() {
                // Create modal HTML
                const modalHTML = `
                    <div class="modal-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000;">
                        <div class="modal-content" style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="color: #333; font-size: 24px;">
                                    <i class="fas fa-plus-circle"></i> Add New Record
                                </h2>
                                <button class="modal-close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                            </div>
                            
                            <form id="record-form">
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">Artist *</label>
                                    <input type="text" id="artist" required style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 16px;">
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">Album Title *</label>
                                    <input type="text" id="title" required style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 16px;">
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">Store Price ($) *</label>
                                    <input type="number" id="price" step="0.01" min="1" max="1000" required style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 16px;">
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">Condition</label>
                                    <select id="condition" style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 16px;">
                                        <option value="5">Mint</option>
                                        <option value="4" selected>Near Mint</option>
                                        <option value="3">Very Good</option>
                                        <option value="2">Good</option>
                                        <option value="1">Fair</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 25px;">
                                    <label style="display: block; margin-bottom: 5px; color: #555; font-weight: 500;">Notes (Optional)</label>
                                    <textarea id="notes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 16px; resize: vertical;"></textarea>
                                </div>
                                
                                <div style="display: flex; gap: 10px;">
                                    <button type="submit" class="action-button" style="flex: 1;">
                                        <i class="fas fa-save"></i> Submit Record
                                    </button>
                                    <button type="button" class="modal-cancel" style="flex: 1; background: #f0f0f0; color: #666; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                const modalDiv = document.createElement('div');
                modalDiv.innerHTML = modalHTML;
                document.body.appendChild(modalDiv);
                
                // Setup modal event listeners
                modalDiv.querySelector('.modal-close').addEventListener('click', () => {
                    modalDiv.remove();
                });
                
                modalDiv.querySelector('.modal-cancel').addEventListener('click', () => {
                    modalDiv.remove();
                });
                
                modalDiv.querySelector('.modal-overlay').addEventListener('click', (e) => {
                    if (e.target === modalDiv.querySelector('.modal-overlay')) {
                        modalDiv.remove();
                    }
                });
                
                // Handle form submission
                modalDiv.querySelector('#record-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const artist = document.getElementById('artist').value.trim();
                    const title = document.getElementById('title').value.trim();
                    const price = parseFloat(document.getElementById('price').value);
                    const condition = document.getElementById('condition').value;
                    const notes = document.getElementById('notes').value.trim();
                    
                    if (!artist || !title || !price) {
                        alert('Please fill in all required fields.');
                        return;
                    }
                    
                    try {
                        const response = await fetch('http://localhost:5000/api/consignor/add-record', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                artist: artist,
                                title: title,
                                store_price: price,
                                condition: condition,
                                notes: notes
                            }),
                            credentials: 'include'
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            alert(`Record added successfully! Record ID: ${data.record_id}\nCommission rate: ${data.commission_rate}%`);
                            modalDiv.remove();
                            await this.loadUserStats(); // Refresh stats
                        } else {
                            const errorData = await response.json();
                            alert(`Error: ${errorData.error || 'Failed to add record'}`);
                        }
                    } catch (error) {
                        console.error('Error adding record:', error);
                        alert('Network error. Please try again.');
                    }
                });
            },
            
            async requestPayout() {
                try {
                    const user = Auth.getUser();
                    const response = await fetch(`http://localhost:5000/users/${user.id}/request-payout`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({}),
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        alert('Payout request submitted successfully! The store will process your request soon.');
                        await this.loadUserStats(); // Refresh stats
                    } else {
                        alert('Failed to submit payout request. Please try again.');
                    }
                } catch (error) {
                    console.error('Error requesting payout:', error);
                    alert('Network error. Please try again.');
                }
            }
        };
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            Dashboard.init();
        });
    </script>
</body>
</html>