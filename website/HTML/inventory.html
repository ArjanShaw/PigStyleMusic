<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel="icon" href="/static/images/PigStyle.ico">
    <title>Record Gallery - PigStyle Records</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-03HFDR9PV7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-03HFDR9PV7');
    </script>
    
    <link rel="stylesheet" href="/static/css/catalog.css">
    <script src="/static/js/app-config.js"></script>
    
    <style>
        /* Additional styles for copy count and price range */
        .copy-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0 5px 0;
            font-size: 13px;
            color: #666;
        }
        
        .copy-count {
            background: #ff6b6b;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .price-range {
            font-weight: 600;
            color: #28a745;
            font-size: 13px;
        }
        
        .condition-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 4px;
        }
        
        .condition-mint { background: #d4edda; color: #155724; }
        .condition-near-mint { background: #cce5ff; color: #004085; }
        .condition-very-good-plus { background: #d1ecf1; color: #0c5460; }
        .condition-very-good { background: #fff3cd; color: #856404; }
        .condition-good-plus { background: #f8d7da; color: #721c24; }
        .condition-good { background: #f8d7da; color: #721c24; }
        .condition-fair { background: #e2e3e5; color: #383d41; }
        .condition-poor { background: #e2e3e5; color: #383d41; }
        
        .conditions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 5px;
        }
        
        .card:hover .conditions-list {
            opacity: 1;
        }
        
        /* Tooltip for additional copies */
        .more-copies {
            font-size: 11px;
            color: #999;
            margin-left: 4px;
        }

        /* Popup/Modal styles */
        .copies-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .copies-modal {
            background: white;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .copies-modal-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #ff6b6b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copies-modal-header h3 {
            margin: 0;
            color: #000000;
            font-size: 16px;
            font-weight: 600;
        }

        .copies-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #000000;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .copies-modal-close:hover {
            opacity: 1;
            color: #ff6b6b;
        }

        .copies-list {
            padding: 20px;
            max-height: calc(80vh - 120px);
            overflow-y: auto;
            background: white;
        }

        .copy-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .copy-item:last-child {
            border-bottom: none;
        }

        .copy-condition {
            flex: 2;
        }

        .copy-price {
            flex: 1;
            text-align: right;
            font-weight: 600;
            color: #000000;
            font-size: 16px;
        }

        .copies-modal-footer {
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-total {
            color: #000000;
            font-weight: 500;
        }

        .footer-range {
            color: #000000;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav style="background: #000; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; border-bottom: 2px solid #ff6b6b;">
        <a href="/" style="color: white; text-decoration: none; font-size: 20px; font-weight: bold; display: flex; align-items: center; gap: 10px;">
            <img src="/static/images/PigStyle.ico" alt="PigStyle" style="height: 30px; width: 30px;">
        </a>
        <div style="display: flex; gap: 20px; align-items: center;">
            <a href="/inventory" style="color: white; text-decoration: none;">Inventory</a>
            <a href="/streaming" style="color: white; text-decoration: none;">Streaming</a>
            <a href="/consignment" style="color: white; text-decoration: none;">Consignment</a>
            <div id="auth-section">
            </div>
        </div>
    </nav>

    <!-- Add padding to account for fixed navbar -->
    <div style="padding-top: 60px;"></div>

    <!-- Background Image -->
    <div class="background-container">
        <img src="/static/images/background.png" alt="Background" class="background-image">
        <div class="background-overlay"></div>
    </div>

    <div class="header-section">
        <div class='search-container'>
            <input type='text' id='searchBox' placeholder='Search artist or record...'>
        </div>
        
        <div class="filters-container">
            <div class="filter-group">
                <select id="artistFilter" class="filter-select">
                    <option value="">All Artists</option>
                </select>
                
                <select id="conditionFilter" class="filter-select">
                    <option value="">All Conditions</option>
                    <option value="Mint (M)">Mint (M)</option>
                    <option value="Near Mint (NM or M-)">Near Mint (NM or M-)</option>
                    <option value="Very Good Plus (VG+)">Very Good Plus (VG+)</option>
                    <option value="Very Good (VG)">Very Good (VG)</option>
                    <option value="Good Plus (G+)">Good Plus (G+)</option>
                    <option value="Good (G)">Good (G)</option>
                    <option value="Fair (F)">Fair (F)</option>
                    <option value="Poor (P)">Poor (P)</option>
                </select>
                
                <div class="price-filter-group">
                    <div class="price-inputs">
                        <input type="number" id="minPrice" class="price-input" placeholder="Min Price" min="0" value="">
                        <span class="price-separator">-</span>
                        <input type="number" id="maxPrice" class="price-input" placeholder="Max Price" min="0" value="">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class='catalog-container' id='catalogContainer'>
        <div id='loading'>
            <div class="loading-dots">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
            <p>Loading catalog...</p>
        </div>
    </div>

    <script>
        // Store all releases globally
        let allReleases = [];

        // Load data from new grouped API endpoint
        async function loadCatalogData() {
            try {
                console.log('Loading grouped catalog data from API...');
                const response = await fetch(`${AppConfig.baseUrl}/catalog/grouped-by-release`);
                const data = await response.json();
                
                console.log('API Response:', data);
                
                if (data.status === 'success') {
                    allReleases = data.groups || [];
                    console.log(`Loaded ${allReleases.length} unique releases with ${data.total_copies} total copies`);
                    displayReleases(allReleases);
                    populateArtistFilter();
                } else {
                    throw new Error('Invalid response from server');
                }
                
            } catch (error) {
                console.error('Error loading catalog data:', error);
                // Fallback to original endpoint if new one fails
                loadCatalogDataFallback();
            }
        }

        // Fallback to original endpoint
        async function loadCatalogDataFallback() {
            try {
                console.log('Falling back to original catalog endpoint...');
                const response = await pigstyleAPI.loadCatalogGroupedRecords();
                
                let catalogData;
                if (Array.isArray(response)) {
                    catalogData = {
                        groups: [{
                            label: 'All Records',
                            records: response
                        }]
                    };
                } else if (response && response.groups) {
                    catalogData = response;
                } else {
                    throw new Error('Invalid response format');
                }
                
                // Convert flat records to grouped format
                const records = catalogData.groups.flatMap(g => g.records || []);
                const grouped = groupRecordsByRelease(records);
                allReleases = grouped;
                
                displayReleases(grouped);
                populateArtistFilter();
                
            } catch (error) {
                console.error('Error loading fallback data:', error);
                document.getElementById('catalogContainer').innerHTML = 
                    '<div class="error-message">Error loading catalog. Please try again later.<br>' + 
                    error.message + '</div>';
            }
        }

        // Helper function to group flat records by release
        function groupRecordsByRelease(records) {
            const groups = {};
            const conditionOrder = {
                'Mint (M)': 1,
                'Near Mint (NM or M-)': 2,
                'Very Good Plus (VG+)': 3,
                'Very Good (VG)': 4,
                'Good Plus (G+)': 5,
                'Good (G)': 6,
                'Fair (F)': 7,
                'Poor (P)': 8
            };
            
            records.forEach(record => {
                const artist = (record.artist || '').trim();
                const title = (record.title || '').trim();
                const key = `${artist.toLowerCase()}|${title.toLowerCase()}`;
                
                if (!groups[key]) {
                    groups[key] = {
                        artist: artist,
                        title: title,
                        genre_name: record.genre_name,
                        image_url: record.image_url,
                        total_copies: 0,
                        price_range: { min: Infinity, max: 0 },
                        copies: []
                    };
                }
                
                const copy = {
                    id: record.id,
                    condition: record.condition,
                    condition_rank: conditionOrder[record.condition] || 99,
                    store_price: parseFloat(record.store_price) || 0,
                    barcode: record.barcode,
                    catalog_number: record.catalog_number,
                    youtube_url: record.youtube_url
                };
                
                groups[key].copies.push(copy);
                groups[key].total_copies++;
                
                if (copy.store_price > 0) {
                    groups[key].price_range.min = Math.min(groups[key].price_range.min, copy.store_price);
                    groups[key].price_range.max = Math.max(groups[key].price_range.max, copy.store_price);
                }
            });
            
            // Clean up price ranges
            Object.values(groups).forEach(group => {
                if (group.price_range.min === Infinity) {
                    group.price_range = { min: 0, max: 0 };
                }
            });
            
            return Object.values(groups).sort((a, b) => 
                (a.artist || '').localeCompare(b.artist || '')
            );
        }

        // Display releases (keeps same tile layout)
        function displayReleases(releases) {
            const container = document.getElementById('catalogContainer');
            container.innerHTML = ''; // Clear loading message

            if (!releases || releases.length === 0) {
                container.innerHTML = '<div class="no-records">No records found in the database.</div>';
                return;
            }

            console.log(`Displaying ${releases.length} releases`);

            // Create a gallery container to maintain same layout
            const gallery = document.createElement('div');
            gallery.className = 'group-gallery';
            gallery.style.display = 'grid';
            gallery.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
            gallery.style.gap = '20px';
            gallery.style.padding = '20px';

            releases.forEach(release => {
                const card = createReleaseCard(release);
                gallery.appendChild(card);
            });

            container.appendChild(gallery);
        }

        // Create a card for a release (keeps same visual style as original)
        function createReleaseCard(release) {
            const card = document.createElement('div');
            card.className = 'card';
            
            // Set data attributes for filtering
            card.setAttribute('data-artist', (release.artist || '').toLowerCase());
            card.setAttribute('data-title', (release.title || '').toLowerCase());
            
            // Get the best image (first copy with image, or default)
            const imageUrl = release.image_url || '/static/images/default-record.jpg';
            
            // Get genre
            const genre = release.genre_name || 'Unknown Genre';
            
            // Calculate price range display
            const priceRange = release.price_range;
            let priceDisplay = '';
            if (priceRange.min > 0 && priceRange.max > 0) {
                if (priceRange.min === priceRange.max) {
                    priceDisplay = `$${priceRange.min.toFixed(2)}`;
                } else {
                    priceDisplay = `$${priceRange.min.toFixed(2)} - $${priceRange.max.toFixed(2)}`;
                }
            } else if (priceRange.min > 0) {
                priceDisplay = `$${priceRange.min.toFixed(2)}`;
            } else {
                priceDisplay = 'Price varies';
            }
            
            // Get all unique conditions from copies
            const conditions = [...new Set(release.copies.map(c => c.condition).filter(Boolean))];
            const conditionCounts = {};
            release.copies.forEach(copy => {
                if (copy.condition) {
                    conditionCounts[copy.condition] = (conditionCounts[copy.condition] || 0) + 1;
                }
            });
            
            // Sort conditions by grade
            const conditionOrder = {
                'Mint (M)': 1,
                'Near Mint (NM or M-)': 2,
                'Very Good Plus (VG+)': 3,
                'Very Good (VG)': 4,
                'Good Plus (G+)': 5,
                'Good (G)': 6,
                'Fair (F)': 7,
                'Poor (P)': 8
            };
            
            const sortedConditions = conditions.sort((a, b) => 
                (conditionOrder[a] || 99) - (conditionOrder[b] || 99)
            );
            
            // Build conditions HTML
            let conditionsHtml = '';
            if (sortedConditions.length > 0) {
                conditionsHtml = '<div class="conditions-list">';
                sortedConditions.slice(0, 3).forEach(condition => {
                    if (!condition) return;
                    const conditionClass = getConditionClass(condition);
                    const count = conditionCounts[condition] || '';
                    const countDisplay = count > 1 ? ` (${count})` : '';
                    conditionsHtml += `<span class="condition-indicator ${conditionClass}">${condition}${countDisplay}</span>`;
                });
                if (sortedConditions.length > 3) {
                    conditionsHtml += `<span class="more-copies">+${sortedConditions.length - 3} more</span>`;
                }
                conditionsHtml += '</div>';
            }
            
            // Copy count display
            const copyCountText = release.total_copies === 1 
                ? '1 copy' 
                : `${release.total_copies} copies`;
            
            card.innerHTML = `
                <div class="card-image">
                    <img src="${imageUrl}" alt="${release.title}" onerror="this.src='/static/images/default-record.jpg'">
                </div>
                <div class="card-info">
                    <h3>${pigstyleAPI.escapeHtml(release.title)}</h3>
                    <p class="artist">${pigstyleAPI.escapeHtml(release.artist)}</p>
                    
                    <div class="copy-info">
                        <span class="copy-count">${copyCountText}</span>
                        <span class="price-range">${priceDisplay}</span>
                    </div>
                    
                    <p class="genre">${pigstyleAPI.escapeHtml(genre)}</p>
                    
                    ${conditionsHtml}
                    
                    ${release.copies.some(c => c.youtube_url) ? `
                        <a href="#" class="youtube-link" onclick="handleYouTubeClick('${release.copies.find(c => c.youtube_url)?.youtube_url || ''}', '${pigstyleAPI.escapeHtml(release.artist)} - ${pigstyleAPI.escapeHtml(release.title)}'); return false;">
                            ðŸŽµ Watch Video
                        </a>
                    ` : ''}
                </div>
            `;
            
            // Add click handler to show all copies popup
            card.addEventListener('click', function(e) {
                // Don't trigger if clicking on YouTube link
                if (e.target.closest('.youtube-link')) return;
                
                // Show popup with all copies
                showCopiesPopup(release);
            });
            
            return card;
        }

        // Helper function to get CSS class for condition
        function getConditionClass(condition) {
            const conditionLower = (condition || '').toLowerCase();
            if (conditionLower.includes('mint') && !conditionLower.includes('near')) {
                return 'condition-mint';
            } else if (conditionLower.includes('near mint')) {
                return 'condition-near-mint';
            } else if (conditionLower.includes('very good plus')) {
                return 'condition-very-good-plus';
            } else if (conditionLower.includes('very good')) {
                return 'condition-very-good';
            } else if (conditionLower.includes('good plus')) {
                return 'condition-good-plus';
            } else if (conditionLower.includes('good')) {
                return 'condition-good';
            } else if (conditionLower.includes('fair')) {
                return 'condition-fair';
            } else if (conditionLower.includes('poor')) {
                return 'condition-poor';
            }
            return '';
        }

        // Show popup with all copies (all text black)
        function showCopiesPopup(release) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'copies-modal-overlay';
            
            // Sort copies by condition (best first)
            const conditionOrder = {
                'Mint (M)': 1,
                'Near Mint (NM or M-)': 2,
                'Very Good Plus (VG+)': 3,
                'Very Good (VG)': 4,
                'Good Plus (G+)': 5,
                'Good (G)': 6,
                'Fair (F)': 7,
                'Poor (P)': 8
            };
            
            const sortedCopies = [...release.copies].sort((a, b) => {
                const orderA = conditionOrder[a.condition] || 99;
                const orderB = conditionOrder[b.condition] || 99;
                if (orderA !== orderB) return orderA - orderB;
                return b.store_price - a.store_price; // Higher price first for same condition
            });
            
            // Create modal content
            modal.innerHTML = `
                <div class="copies-modal">
                    <div class="copies-modal-header">
                        <h3>${pigstyleAPI.escapeHtml(release.artist)} - ${pigstyleAPI.escapeHtml(release.title)}</h3>
                        <button class="copies-modal-close">&times;</button>
                    </div>
                    <div class="copies-list">
                        ${sortedCopies.map(copy => {
                            const conditionClass = getConditionClass(copy.condition);
                            return `
                                <div class="copy-item">
                                    <span class="copy-condition">
                                        <span class="condition-indicator ${conditionClass}">${copy.condition || 'Unknown'}</span>
                                    </span>
                                    <span class="copy-price">$${copy.store_price.toFixed(2)}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="copies-modal-footer">
                        <span class="footer-total">Total Copies: ${release.total_copies}</span>
                        <span class="footer-range">Price Range: $${release.price_range.min.toFixed(2)} - $${release.price_range.max.toFixed(2)}</span>
                    </div>
                </div>
            `;
            
            // Add click handler to close button
            const closeBtn = modal.querySelector('.copies-modal-close');
            closeBtn.addEventListener('click', () => {
                modal.remove();
            });
            
            // Add click outside to close
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // Handle YouTube click
        function handleYouTubeClick(youtubeUrl, title) {
            const videoId = extractYouTubeId(youtubeUrl);
            if (!videoId) {
                alert('Invalid YouTube URL');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'youtube-modal-overlay';
            
            modal.innerHTML = `
                <div class="youtube-modal">
                    <div class="youtube-modal-header">
                        <h3>${title}</h3>
                        <button class="youtube-modal-close" onclick="this.closest('.youtube-modal-overlay').remove()">Ã—</button>
                    </div>
                    <div class="youtube-video-container">
                        <iframe 
                            src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen>
                        </iframe>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // Extract YouTube ID
        function extractYouTubeId(url) {
            if (!url) return null;
            
            const patterns = [
                /youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,
                /youtu\.be\/([a-zA-Z0-9_-]{11})/,
                /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
                /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        // Populate artist filter dropdown
        function populateArtistFilter() {
            const artistFilter = document.getElementById('artistFilter');
            
            const artists = new Set();
            allReleases.forEach(release => {
                if (release.artist && release.artist.trim() !== '') {
                    artists.add(release.artist.trim());
                }
            });
            
            const sortedArtists = Array.from(artists).sort();
            
            // Clear existing options (keeping "All Artists")
            while (artistFilter.options.length > 1) {
                artistFilter.remove(1);
            }
            
            sortedArtists.forEach(artist => {
                const option = document.createElement('option');
                option.value = artist;
                option.textContent = artist;
                artistFilter.appendChild(option);
            });
        }

        // Initialize search and filter functionality
        function initializeFilters() {
            const searchBox = document.getElementById('searchBox');
            const artistFilter = document.getElementById('artistFilter');
            const conditionFilter = document.getElementById('conditionFilter');
            const minPrice = document.getElementById('minPrice');
            const maxPrice = document.getElementById('maxPrice');
            
            [searchBox, artistFilter, conditionFilter, minPrice, maxPrice].forEach(element => {
                if (element) {
                    element.addEventListener('input', applyFilters);
                    element.addEventListener('change', applyFilters);
                }
            });
        }

        // Apply all filters
        function applyFilters() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase().trim();
            const selectedArtist = document.getElementById('artistFilter').value;
            const selectedCondition = document.getElementById('conditionFilter').value;
            const minPriceValue = parseFloat(document.getElementById('minPrice').value) || 0;
            const maxPriceValue = parseFloat(document.getElementById('maxPrice').value) || 99999;
            
            const container = document.getElementById('catalogContainer');
            const cards = container.querySelectorAll('.card');
            
            let visibleCount = 0;
            
            cards.forEach(card => {
                const artist = card.getAttribute('data-artist') || '';
                const title = card.getAttribute('data-title') || '';
                
                // Get condition indicators from card
                const conditionSpans = card.querySelectorAll('.condition-indicator');
                const cardConditions = Array.from(conditionSpans).map(span => span.textContent.trim().replace(/ \(\d+\)$/, '')); // Remove count for filtering
                
                // Get price range from card
                const priceRangeText = card.querySelector('.price-range')?.textContent || '';
                let cardMinPrice = 0;
                let cardMaxPrice = 99999;
                
                if (priceRangeText.includes('-')) {
                    const matches = priceRangeText.match(/\$([\d.]+)/g);
                    if (matches && matches.length >= 2) {
                        cardMinPrice = parseFloat(matches[0].replace('$', ''));
                        cardMaxPrice = parseFloat(matches[1].replace('$', ''));
                    }
                } else if (priceRangeText.includes('$')) {
                    const match = priceRangeText.match(/\$([\d.]+)/);
                    if (match) {
                        cardMinPrice = cardMaxPrice = parseFloat(match[1]);
                    }
                }
                
                // Check search term match
                const searchMatch = !searchTerm || 
                    artist.includes(searchTerm) || 
                    title.includes(searchTerm);
                
                // Check artist filter match
                const artistMatch = !selectedArtist || 
                    artist === selectedArtist.toLowerCase();
                
                // Check condition filter match
                const conditionMatch = !selectedCondition || 
                    cardConditions.some(c => c.includes(selectedCondition));
                
                // Check price range overlap
                const priceMatch = !(cardMaxPrice < minPriceValue || cardMinPrice > maxPriceValue);
                
                // Show card if it matches all active filters
                const shouldShow = searchMatch && artistMatch && conditionMatch && priceMatch;
                
                card.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            // Show no results message if needed
            const existingNoResults = container.querySelector('.no-records');
            if (visibleCount === 0) {
                if (!existingNoResults) {
                    const noResultsDiv = document.createElement('div');
                    noResultsDiv.className = 'no-records';
                    noResultsDiv.textContent = 'No records match your search criteria.';
                    container.appendChild(noResultsDiv);
                }
            } else if (existingNoResults) {
                existingNoResults.remove();
            }
        }

        // Load the catalog data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadCatalogData();
            initializeFilters();
        });
    </script>
</body>
</html>