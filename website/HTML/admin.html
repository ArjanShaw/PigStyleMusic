<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - PigStyle Music</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/admin.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="/static/js/app-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <style>
        /* Additional styles for accessories tab */
        .accessory-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .accessory-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .accessory-form input,
        .accessory-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .accessory-form input:focus,
        .accessory-form select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .accessories-table-container {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .accessories-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .accessories-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
        }
        
        .accessories-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .accessories-table tr:hover {
            background: #f8f9fa;
        }
        
        .low-stock {
            background-color: #fff3cd;
        }
        
        .out-of-stock {
            background-color: #f8d7da;
        }
        
        .barcode-cell {
            font-family: monospace;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .accessory-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        /* Modal styles for accessories */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .barcode-preview {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .barcode-preview svg {
            max-width: 100%;
            height: auto;
        }
        
        .confirmation-check {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .confirmation-check input[type="checkbox"] {
            margin-right: 10px;
        }

        /* Styles for accessories in search results */
        .accessory-badge {
            background: #9b59b6;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 8px;
            text-transform: uppercase;
        }
        
        .negative-stock {
            color: #dc3545;
            font-weight: bold;
        }
        
        .stock-indicator {
            font-size: 0.8rem;
            margin-left: 8px;
        }
        
        .stock-positive {
            color: #28a745;
        }
        
        .stock-negative {
            color: #dc3545;
        }

        /* Barcode print styles */
        @media print {
            .barcode-print-page {
                padding: 20px;
                font-family: Arial, sans-serif;
            }
            .barcode-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                page-break-inside: avoid;
            }
            .barcode-item {
                text-align: center;
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 8px;
                page-break-inside: avoid;
            }
            .barcode-item svg {
                max-width: 100%;
                height: auto;
            }
            .barcode-description {
                font-weight: bold;
                margin: 10px 0 5px;
            }
            .barcode-price {
                color: #27ae60;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="/">PigStyle Music</a>
        </div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/catalog">Catalog</a>
            <a href="/streaming">Streaming</a>
            <a href="/consignment">Consignment</a>
            <a href="/dashboard">Dashboard</a>
            <div id="auth-section">
                <!-- Populated by app-config.js -->
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <h1><i class="fas fa-cogs"></i> Admin Panel</h1>
        
        <div class="tab-container">
            <div class="tab" onclick="switchTab('check-out')">
                <i class="fas fa-shopping-cart"></i> Check Out
            </div>
            <div class="tab" onclick="switchTab('receipts')">
                <i class="fas fa-receipt"></i> Receipts
            </div>
            <div class="tab" onclick="switchTab('consignors')">
                <i class="fas fa-users"></i> Consignors
            </div>
            <div class="tab" onclick="switchTab('artists')">
                <i class="fas fa-music"></i> Artists
            </div>
            <div class="tab" onclick="switchTab('genres')">
                <i class="fas fa-tags"></i> Genres
            </div>
            <div class="tab" onclick="switchTab('accessories')">
                <i class="fas fa-headphones"></i> Accessories
            </div>
            <div class="tab" onclick="switchTab('admin-config')">
                <i class="fas fa-sliders-h"></i> Admin Config
            </div>
            <div class="tab active" onclick="switchTab('price-tags')">
                <i class="fas fa-tags"></i> Print Price Tags
            </div>
        </div>
        
        <!-- Price Tags Tab -->
        <div id="price-tags-tab" class="tab-content active">
            <h2><i class="fas fa-tags"></i> Print Price Tags</h2>
            
            <!-- Filter Controls -->
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="user-select"><i class="fas fa-user"></i> Select User:</label>
                    <select id="user-select" class="select2 filter-select" style="width: 250px;">
                        <option value="all">All Users</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="status-filter"><i class="fas fa-filter"></i> Filter by Status:</label>
                    <select id="status-filter" class="filter-select" onchange="filterRecords()">
                        <option value="all">All Statuses</option>
                        <option value="inactive">Inactive Only</option>
                        <option value="active">Active Only</option>
                        <option value="sold">Sold Only</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="loadRecords()" style="height: 38px;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <!-- Records Section -->
            <div id="records-section">
                <h3><i class="fas fa-list"></i> Records</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Records</h3>
                        <p class="stat-number" id="total-records">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Inactive Records</h3>
                        <p class="stat-number" id="inactive-records">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Active Records</h3>
                        <p class="stat-number" id="active-records">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Sold Records</h3>
                        <p class="stat-number" id="sold-records">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Selected Tags</h3>
                        <p class="stat-number" id="selected-tags">0</p>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="batch-size"><i class="fas fa-sort-numeric-down"></i> Number of tags to print:</label>
                    <input type="number" id="batch-size" min="1" value="10" onchange="selectRecentInactiveRecords()">
                    <small>Most recent inactive records will be selected (sorted by creation date descending)</small>
                </div>
                
                <div class="pagination" id="pagination-controls">
                    <button class="page-btn" onclick="goToFirstPage()" id="first-page-btn" disabled>
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button class="page-btn" onclick="goToPreviousPage()" id="prev-page-btn" disabled>
                        <i class="fas fa-angle-left"></i>
                    </button>
                    
                    <span class="pagination-info">
                        Page <input type="number" class="page-input" id="current-page" min="1" value="1" 
                               onchange="goToPage(parseInt(this.value))" onblur="goToPage(parseInt(this.value))"> 
                        of <span id="total-pages">1</span>
                    </span>
                    
                    <button class="page-btn" onclick="goToNextPage()" id="next-page-btn" disabled>
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button class="page-btn" onclick="goToLastPage()" id="last-page-btn" disabled>
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                    
                    <div class="records-per-page">
                        <span>Show:</span>
                        <select id="page-size" onchange="changePageSize(parseInt(this.value))">
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                        <span>records per page</span>
                    </div>
                </div>
                
                <div class="records-table-container">
                    <table class="records-table" id="records-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all"></th>
                                <th>#</th>
                                <th>Created Date <i class="fas fa-sort-down"></i></th>
                                <th>Artist</th>
                                <th>Title</th>
                                <th>Price</th>
                                <th>Catalog #</th>
                                <th>Genre</th>
                                <th>Barcode</th>
                                <th>Consignor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="records-body">
                            <!-- Records will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="pagination-footer">
                    <span class="pagination-info">
                        Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> 
                        of <span id="total-filtered">0</span> records
                        (<span id="selected-count">0</span> selected)
                    </span>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadRecords()">
                        <i class="fas fa-sync-alt"></i> Refresh Records
                    </button>
                    <button class="btn btn-success" onclick="showPrintConfirmation()" id="print-btn" disabled>
                        <i class="fas fa-print"></i> Print Price Tags
                    </button>
                    <button class="btn btn-warning" onclick="showMarkActiveConfirmation()" id="mark-active-btn" disabled>
                        <i class="fas fa-check-circle"></i> Mark as Active
                    </button>
                    <button class="btn btn-secondary" onclick="selectRecentInactiveRecords()" id="select-inactive-btn">
                        <i class="fas fa-check-square"></i> Select Recent Inactive
                    </button>
                    <button class="btn btn-secondary" onclick="selectAllOnPage()">
                        <i class="fas fa-check-double"></i> Select All on Page
                    </button>
                    <button class="btn btn-secondary" onclick="clearSelection()">
                        <i class="fas fa-times-circle"></i> Clear Selection
                    </button>
                </div>
                
                <div id="status-message" class="status-message"></div>
                
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p>Processing...</p>
                </div>
            </div>
        </div>
        
        <!-- Check Out Tab -->
        <div id="check-out-tab" class="tab-content">
            <h2><i class="fas fa-shopping-cart"></i> Check Out</h2>
            
            <div class="terminal-management">
                <div class="terminal-header">
                    <h3><i class="fas fa-square"></i> Square Terminal Status</h3>
                    <button class="btn btn-secondary" onclick="refreshTerminals()">
                        <i class="fas fa-sync-alt"></i> Refresh Terminals
                    </button>
                </div>
                <div id="terminal-list" class="terminal-list">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <i class="fas fa-square" style="font-size: 24px; margin-bottom: 10px; color: #ccc;"></i>
                        <p>Click refresh to load available terminals</p>
                    </div>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-query" class="search-input" 
                           placeholder="Search by barcode, title, artist, catalog number, or accessory description..." 
                           onkeypress="if(event.key === 'Enter') searchRecordsAndAccessories()">
                    <button class="btn btn-primary" onclick="searchRecordsAndAccessories()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                
                <div class="search-filters">
                    <label class="search-filter-checkbox">
                        <input type="checkbox" id="filter-active" checked> 
                        <i class="fas fa-check-circle" style="color: #28a745;"></i> Active Only
                    </label>
                    <label class="search-filter-checkbox">
                        <input type="checkbox" id="filter-barcode"> 
                        <i class="fas fa-barcode"></i> Search Barcode Only
                    </label>
                    <span style="color: #666; margin-left: auto; display: flex; align-items: center;">
                        <i class="fas fa-info-circle"></i> 
                        <span style="margin-left: 5px;">Found <span id="search-result-count">0</span> results</span>
                    </span>
                </div>
            </div>
            
            <div id="checkout-status-message" class="status-message"></div>
            
            <div id="search-results-container">
                <div class="results-count" id="results-count-header">
                    Showing <span id="displayed-results">0</span> items
                </div>
                <div id="search-results" class="search-results">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 20px; color: #ccc;"></i>
                        <p>Enter a search term to find records or accessories</p>
                    </div>
                </div>
            </div>
            
            <div id="shopping-cart-section" class="cart-section" style="display: none;">
                <div class="cart-header">
                    <h3><i class="fas fa-shopping-cart"></i> Shopping Cart</h3>
                    <span id="cart-item-count" class="badge" style="background: #3498db; color: white; padding: 5px 10px; border-radius: 20px;">0 items</span>
                </div>
                
                <div id="cart-items" class="cart-items"></div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="cart-subtotal">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax (<span id="tax-rate-display">0</span>%):</span>
                        <span id="cart-tax">$0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="cart-total">$0.00</span>
                    </div>
                </div>
                
                <div class="cart-actions">
                    <button class="btn btn-secondary" onclick="clearCart()">
                        <i class="fas fa-times"></i> Clear Cart
                    </button>
                    <button class="btn btn-cash" onclick="showTenderModal()" id="checkout-cash-btn">
                        <i class="fas fa-money-bill-wave"></i> Cash
                    </button>
                    <button class="btn btn-square" onclick="processSquarePayment()" id="checkout-square-btn">
                        <i class="fas fa-square"></i> Square
                    </button>
                </div>
            </div>
            
            <div class="loading" id="checkout-loading">
                <div class="loading-spinner"></div>
                <p>Searching...</p>
            </div>
        </div>
        
        <!-- Receipts Tab -->
        <div id="receipts-tab" class="tab-content">
            <h2><i class="fas fa-receipt"></i> Receipt History</h2>
            
            <div class="receipt-stats" id="receipt-stats">
                <div class="receipt-stat-card">
                    <div class="receipt-stat-number" id="total-receipts">0</div>
                    <div class="receipt-stat-label">Total Receipts</div>
                </div>
                <div class="receipt-stat-card">
                    <div class="receipt-stat-number" id="total-receipts-sales">$0.00</div>
                    <div class="receipt-stat-label">Total Sales</div>
                </div>
                <div class="receipt-stat-card">
                    <div class="receipt-stat-number" id="total-receipts-tax">$0.00</div>
                    <div class="receipt-stat-label">Total Tax Collected</div>
                </div>
                <div class="receipt-stat-card">
                    <div class="receipt-stat-number" id="total-receipts-items">0</div>
                    <div class="receipt-stat-label">Items Sold</div>
                </div>
            </div>
            
            <div class="receipts-search">
                <h3><i class="fas fa-search"></i> Search Receipts</h3>
                <div class="date-range">
                    <div class="date-field">
                        <label for="receipt-start-date">From Date:</label>
                        <input type="date" id="receipt-start-date" class="date-input">
                    </div>
                    <div class="date-field">
                        <label for="receipt-end-date">To Date:</label>
                        <input type="date" id="receipt-end-date" class="date-input">
                    </div>
                    <div class="date-field">
                        <label for="receipt-search-query">Receipt # or Item:</label>
                        <input type="text" id="receipt-search-query" class="filter-select" placeholder="Search...">
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="searchReceipts()">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <button class="btn btn-secondary" onclick="resetReceiptSearch()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="receipts-grid" class="receipts-grid">
                <div style="text-align: center; padding: 40px; color: #666; grid-column: 1/-1;">
                    <i class="fas fa-receipt" style="font-size: 48px; margin-bottom: 20px; color: #ccc;"></i>
                    <p>No receipts found</p>
                </div>
            </div>
            
            <div class="loading" id="receipts-loading">
                <div class="loading-spinner"></div>
                <p>Loading receipts...</p>
            </div>
        </div>
        
        <!-- Consignors Tab -->
        <div id="consignors-tab" class="tab-content">
            <h2><i class="fas fa-users"></i> Consignor Management</h2>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p><strong>Commission Rate:</strong> <span id="commission-rate-display">Per Record</span>% (Admin gets <span id="admin-commission-display">Per Record</span>% of sale, Consignor gets <span id="consignor-commission-display">Per Record</span>%)</p>
            </div>
            
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <h3>Total Consignors</h3>
                    <p class="stat-number" id="total-consignors">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Owed to Consignors</h3>
                    <p class="stat-number" id="total-credit">$0.00</p>
                </div>
                <div class="stat-card">
                    <h3>Total Admin Commission</h3>
                    <p class="stat-number" id="admin-total-commission">$0.00</p>
                </div>
            </div>
            
            <div class="records-table-container">
                <table class="records-table" id="consignors-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Initials</th>
                            <th>Owed Amount</th>
                            <th>Records Sold</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="consignors-body">
                        <tr><td colspan="6" style="text-align:center; padding:20px;">Loading consignors...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div id="payment-modal" class="modal-overlay" style="display:none;">
                <div class="modal-content" style="max-width:400px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Pay Consignor</h3>
                        <button class="modal-close" onclick="closePaymentModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Consignor: <strong id="payment-consignor-name"></strong></p>
                        <p>Amount Owed: <strong id="payment-amount">$0.00</strong></p>
                        <p>Are you sure you want to mark this amount as paid? This will clear their balance.</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                        <button class="btn btn-success" onclick="processPayment()">Confirm Payment</button>
                    </div>
                </div>
            </div>
            
            <div class="loading" id="consignors-loading" style="display:none;">
                <div class="loading-spinner"></div>
                <p>Processing...</p>
            </div>
        </div>
        
        <!-- Artists Tab -->
        <div id="artists-tab" class="tab-content">
            <h2><i class="fas fa-music"></i> Artists by Record Count</h2>
            
            <div class="filter-controls" style="margin-bottom: 20px;">
                <div class="filter-group">
                    <label for="artist-search"><i class="fas fa-search"></i> Search Artist:</label>
                    <input type="text" id="artist-search" class="filter-select" placeholder="Type to filter..." onkeyup="filterArtists()" style="width: 250px;">
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="loadArtists()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="filter-group" style="margin-left: auto;">
                    <span class="pagination-info">
                        Total Artists: <strong id="total-artists-count">0</strong>
                    </span>
                </div>
            </div>
            
            <div class="input-group" style="margin-bottom: 20px;">
                <label for="artist-batch-size"><i class="fas fa-sort-numeric-down"></i> Number of artists to print:</label>
                <input type="number" id="artist-batch-size" min="1" value="10">
                <small>Select the top artists by record count to print on price tag sheets</small>
            </div>
            
            <div class="records-table-container">
                <table class="records-table" id="artists-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-artists"></th>
                            <th>#</th>
                            <th>Artist Name</th>
                            <th>Record Count</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="artists-body">
                        <tr><td colspan="5" style="text-align:center; padding:40px;">
                            <i class="fas fa-music" style="font-size: 48px; margin-bottom: 20px; color: #ccc; display: block;"></i>
                            Loading artists...
                        </td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="artists-pagination" style="margin-top: 20px;">
                <button class="page-btn" onclick="goToArtistsPage('first')" id="artists-first-btn" disabled>
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button class="page-btn" onclick="goToArtistsPage('prev')" id="artists-prev-btn" disabled>
                    <i class="fas fa-angle-left"></i>
                </button>
                
                <span class="pagination-info">
                    Page <span id="artists-current-page">1</span> of <span id="artists-total-pages">1</span>
                </span>
                
                <button class="page-btn" onclick="goToArtistsPage('next')" id="artists-next-btn" disabled>
                    <i class="fas fa-angle-right"></i>
                </button>
                <button class="page-btn" onclick="goToArtistsPage('last')" id="artists-last-btn" disabled>
                    <i class="fas fa-angle-double-right"></i>
                </button>
                
                <div class="records-per-page">
                    <span>Show:</span>
                    <select id="artists-page-size" onchange="changeArtistsPageSize(parseInt(this.value))">
                        <option value="20">20</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="loadArtists()">
                    <i class="fas fa-sync-alt"></i> Refresh Artists
                </button>
                <button class="btn btn-success" onclick="showPrintArtistsConfirmation()" id="print-artists-btn" disabled>
                    <i class="fas fa-print"></i> Print Selected Artists
                </button>
                <button class="btn btn-secondary" onclick="selectTopArtists()">
                    <i class="fas fa-check-square"></i> Select Top Artists
                </button>
                <button class="btn btn-secondary" onclick="selectAllArtistsOnPage()">
                    <i class="fas fa-check-double"></i> Select All on Page
                </button>
                <button class="btn btn-secondary" onclick="clearArtistSelection()">
                    <i class="fas fa-times-circle"></i> Clear Selection
                </button>
            </div>
            
            <div class="loading" id="artists-loading" style="display:none;">
                <div class="loading-spinner"></div>
                <p>Loading artists...</p>
            </div>
        </div>
        
        <!-- Genres Tab -->
        <div id="genres-tab" class="tab-content">
            <h2><i class="fas fa-tags"></i> Genre Mismatches</h2>
            
            <div class="info-message" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i> This tab shows artists where the genre in the artist_genre table doesn't match the genre in individual records. Click the edit button to update the expected genre.
            </div>
            
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <h3>Total Artists with Mismatches</h3>
                    <p class="stat-number" id="total-mismatch-artists">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Mismatched Records</h3>
                    <p class="stat-number" id="total-mismatch-records">0</p>
                </div>
            </div>
            
            <div class="filter-controls" style="margin-bottom: 20px;">
                <div class="filter-group">
                    <label for="genre-mismatch-search"><i class="fas fa-search"></i> Search Artist:</label>
                    <input type="text" id="genre-mismatch-search" class="filter-select" placeholder="Type to filter..." onkeyup="filterGenreMismatches()" style="width: 250px;">
                </div>
                <div class="filter-group">
                    <label for="genre-filter-select"><i class="fas fa-filter"></i> Filter by Expected Genre:</label>
                    <select id="genre-filter-select" class="filter-select" onchange="filterGenreMismatches()" style="width: 200px;">
                        <option value="all">All Genres</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="loadGenreMismatches()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div id="genre-edit-modal" class="modal-overlay" style="display:none;">
                <div class="modal-content" style="max-width:500px;">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-edit"></i> Edit Expected Genre</h3>
                        <button class="modal-close" onclick="closeGenreEditModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Artist: <strong id="edit-artist-name"></strong></p>
                        <div class="filter-group" style="margin-bottom: 15px;">
                            <label for="edit-genre-select">Expected Genre:</label>
                            <select id="edit-genre-select" class="filter-select" style="width: 100%;">
                                <!-- Genres will be populated here -->
                            </select>
                        </div>
                        <p class="info-message" style="background:#f8f9fa; padding:10px; border-radius:4px;">
                            <i class="fas fa-info-circle"></i> This will update the genre in the artist_genre table for all records by this artist.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeGenreEditModal()">Cancel</button>
                        <button class="btn btn-success" onclick="saveGenreEdit()" id="save-genre-btn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="records-table-container">
                <table class="records-table" id="genre-mismatches-table">
                    <thead>
                        <tr>
                            <th>Artist</th>
                            <th>Expected Genre (from artist_genre)</th>
                            <th>Records with Different Genres</th>
                            <th>Count</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="genre-mismatches-body">
                        <tr><td colspan="5" style="text-align:center; padding:40px;">
                            <i class="fas fa-tags" style="font-size: 48px; margin-bottom: 20px; color: #ccc; display: block;"></i>
                            Loading genre mismatches...
                        </td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="pagination" id="mismatches-pagination" style="margin-top: 20px;">
                <button class="page-btn" onclick="goToMismatchesPage('first')" id="mismatches-first-btn" disabled>
                    <i class="fas fa-angle-double-left"></i>
                </button>
                <button class="page-btn" onclick="goToMismatchesPage('prev')" id="mismatches-prev-btn" disabled>
                    <i class="fas fa-angle-left"></i>
                </button>
                
                <span class="pagination-info">
                    Page <span id="mismatches-current-page">1</span> of <span id="mismatches-total-pages">1</span>
                </span>
                
                <button class="page-btn" onclick="goToMismatchesPage('next')" id="mismatches-next-btn" disabled>
                    <i class="fas fa-angle-right"></i>
                </button>
                <button class="page-btn" onclick="goToMismatchesPage('last')" id="mismatches-last-btn" disabled>
                    <i class="fas fa-angle-double-right"></i>
                </button>
                
                <div class="records-per-page">
                    <span>Show:</span>
                    <select id="mismatches-page-size" onchange="changeMismatchesPageSize(parseInt(this.value))">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
            
            <div class="loading" id="genres-loading" style="display:none;">
                <div class="loading-spinner"></div>
                <p>Loading genre mismatches...</p>
            </div>
        </div>

        <!-- Accessories Tab -->
        <div id="accessories-tab" class="tab-content">
            <h2><i class="fas fa-headphones"></i> Accessories Management</h2>
            
            <div class="accessory-form" id="accessory-form" style="display: none;">
                <h3 id="form-title"><i class="fas fa-plus-circle"></i> Add New Accessory</h3>
                <div class="accessory-form-grid">
                    <div>
                        <label for="accessory-description">Description *</label>
                        <input type="text" id="accessory-description" placeholder="e.g., Turntable Belt, RCA Cables" required>
                    </div>
                    <div>
                        <label for="accessory-price">Store Price *</label>
                        <input type="number" id="accessory-price" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    <div>
                        <label for="accessory-count">Initial Count (optional)</label>
                        <input type="number" id="accessory-count" min="0" value="0" placeholder="0">
                    </div>
                </div>
                <div class="action-buttons" style="justify-content: flex-start; margin-top: 10px;">
                    <button class="btn btn-success" onclick="saveAccessory()">
                        <i class="fas fa-save"></i> Save Accessory
                    </button>
                    <button class="btn btn-secondary" onclick="cancelAccessoryForm()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-bottom: 20px;" id="add-new-btn-container">
                <button class="btn btn-primary" onclick="showAddAccessoryForm()">
                    <i class="fas fa-plus"></i> Add New Accessory
                </button>
                <button class="btn btn-secondary" onclick="loadAccessories()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-success" onclick="printAccessoryBarcodes()">
                    <i class="fas fa-print"></i> Print Barcodes
                </button>
            </div>
            
            <div class="filter-controls" style="margin-bottom: 20px;">
                <div class="filter-group" style="flex: 1;">
                    <input type="text" id="accessory-search" class="filter-select" placeholder="Search by description or barcode..." onkeyup="filterAccessories()" style="width: 100%;">
                </div>
                <div class="filter-group">
                    <select id="stock-filter" class="filter-select" onchange="filterAccessories()">
                        <option value="all">All Stock</option>
                        <option value="low">Low Stock (&lt;=5)</option>
                        <option value="negative">Negative Stock</option>
                        <option value="in">In Stock (&gt;0)</option>
                    </select>
                </div>
            </div>
            
            <div class="accessories-table-container">
                <table class="accessories-table" id="accessories-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-accessories"></th>
                            <th>ID</th>
                            <th>Description</th>
                            <th>Barcode</th>
                            <th>Price</th>
                            <th>Count</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="accessories-body">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <i class="fas fa-headphones" style="font-size: 48px; margin-bottom: 20px; color: #ccc; display: block;"></i>
                                Click "Add New Accessory" to get started
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="loadAccessories()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-success" onclick="printAccessoryBarcodes()" id="print-accessories-btn" disabled>
                    <i class="fas fa-print"></i> Print Selected Barcodes
                </button>
                <button class="btn btn-secondary" onclick="selectAllAccessoriesOnPage()">
                    <i class="fas fa-check-double"></i> Select All on Page
                </button>
                <button class="btn btn-secondary" onclick="clearAccessorySelection()">
                    <i class="fas fa-times-circle"></i> Clear Selection
                </button>
            </div>
            
            <div class="loading" id="accessories-loading" style="display: none;">
                <div class="loading-spinner"></div>
                <p>Loading accessories...</p>
            </div>
        </div>
        
        <!-- Admin Config Tab -->
        <div id="admin-config-tab" class="tab-content">
            <h2><i class="fas fa-sliders-h"></i> Admin Configuration</h2>
            
            <div class="admin-config-section">
                <h3><i class="fas fa-print"></i> Print Settings</h3>
                <p>Configuration values related to price tag printing.</p>
                
                <div class="records-table-container">
                    <table class="records-table" id="print-config-table">
                        <thead>
                            <tr>
                                <th>Configuration Key</th>
                                <th>Value</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="print-config-body">
                            <!-- Print config values will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-config-section" style="margin-top: 30px;">
                <h3><i class="fas fa-cog"></i> General Settings</h3>
                <p>Other system configuration values.</p>
                
                <div class="records-table-container">
                    <table class="records-table" id="general-config-table">
                        <thead>
                            <tr>
                                <th>Configuration Key</th>
                                <th>Value</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="general-config-body">
                            <!-- General config values will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-config-section" style="margin-top: 30px;">
                <h3><i class="fas fa-plus-circle"></i> Add New Configuration</h3>
                
                <div class="add-config-form">
                    <div class="filter-group">
                        <label for="new-config-key">Key:</label>
                        <input type="text" id="new-config-key" class="config-value-input" placeholder="e.g., NEW_SETTING">
                    </div>
                    <div class="filter-group">
                        <label for="new-config-value">Value:</label>
                        <input type="text" id="new-config-value" class="config-value-input" placeholder="Enter value">
                    </div>
                    <div class="filter-group">
                        <label for="new-config-description">Description:</label>
                        <input type="text" id="new-config-description" class="config-value-input" placeholder="What does this setting do?">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-success" onclick="addNewConfig()">
                            <i class="fas fa-plus"></i> Add Configuration
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="loadConfigTables()">
                    <i class="fas fa-sync-alt"></i> Refresh Config
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="print-confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-print"></i> Print Price Tags</h3>
                <button class="modal-close" onclick="closePrintConfirmation()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="print-summary">
                    <h4>Print Summary</h4>
                    <p>You are about to print price tags for <strong id="print-count">0</strong> selected records.</p>
                    <ul id="print-summary-list">
                        <!-- Will be populated dynamically -->
                    </ul>
                    <p>After printing successfully, you should mark these records as <strong>Active</strong> using the "Mark as Active" button.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePrintConfirmation()">Cancel</button>
                <button class="btn btn-success" onclick="confirmPrint()" id="confirm-print-btn">
                    <i class="fas fa-print"></i> Print Now
                </button>
            </div>
        </div>
    </div>

    <div id="mark-active-confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-check-circle"></i> Mark as Active</h3>
                <button class="modal-close" onclick="closeMarkActiveConfirmation()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="print-summary">
                    <h4>Confirmation Required</h4>
                    <p>You are about to mark <strong id="mark-active-count">0</strong> selected records as <strong>Active</strong>.</p>
                    <ul id="mark-active-summary-list">
                        <!-- Will be populated dynamically -->
                    </ul>
                    <p><strong>Important:</strong> Only mark records as Active <em>after</em> you have successfully printed their price tags.</p>
                    <p>This will change their status from "Inactive" to "Active" in the system.</p>
                </div>
                <div class="confirmation-check">
                    <input type="checkbox" id="mark-active-confirmation-check">
                    <label for="mark-active-confirmation-check">I have successfully printed price tags for these records</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMarkActiveConfirmation()">Cancel</button>
                <button class="btn btn-warning" onclick="confirmMarkActive()" id="confirm-mark-active-btn" disabled>
                    <i class="fas fa-check-circle"></i> Mark as Active
                </button>
            </div>
        </div>
    </div>

    <div id="terminal-checkout-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-square"></i> Square Terminal Checkout</h3>
                <button class="modal-close" onclick="closeTerminalCheckoutModal()">&times;</button>
            </div>
            <div class="modal-body" id="terminal-checkout-body">
                <!-- Content will be dynamically populated -->
            </div>
        </div>
    </div>

    <div id="terminal-selection-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-square"></i> Select Terminal</h3>
                <button class="modal-close" onclick="closeTerminalSelectionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="terminal-selection-list" class="terminal-device-selector">
                    <!-- Terminal selection will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTerminalSelectionModal()">Cancel</button>
                <button class="btn btn-success" onclick="initiateCartTerminalCheckout()" id="confirm-terminal-btn" disabled>
                    <i class="fas fa-check-circle"></i> Start Checkout
                </button>
            </div>
        </div>
    </div>

    <div id="tender-modal" class="tender-modal">
        <div class="tender-content">
            <h3 style="text-align: center; margin-bottom: 20px;"><i class="fas fa-money-bill-wave"></i> Cash Payment</h3>
            
            <div style="text-align: center; margin-bottom: 10px;">Total Due:</div>
            <div class="tender-amount" id="tender-total-due">$0.00</div>
            
            <input type="number" id="tender-amount" class="tender-input" placeholder="Enter amount received" min="0" step="0.01" autofocus>
            
            <div id="change-display-container" style="display: none;">
                <div style="text-align: center; margin-bottom: 5px;">Change:</div>
                <div class="change-display" id="change-amount">$0.00</div>
            </div>
            
            <div class="action-buttons" style="justify-content: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeTenderModal()">Cancel</button>
                <button class="btn btn-success" onclick="processCashPayment()" id="complete-payment-btn" disabled>
                    <i class="fas fa-check"></i> Complete Payment
                </button>
            </div>
        </div>
    </div>

    <div id="receipt-modal" class="receipt-modal">
        <div class="receipt-content" id="receipt-content">
            <!-- Receipt will be dynamically generated here -->
        </div>
    </div>

    <div id="print-artists-confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-print"></i> Print Artist Names</h3>
                <button class="modal-close" onclick="closePrintArtistsConfirmation()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="print-summary">
                    <h4>Print Summary</h4>
                    <p>You are about to print artist names for <strong id="print-artists-count">0</strong> selected artists.</p>
                    <ul id="print-artists-summary-list">
                        <!-- Will be populated dynamically -->
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePrintArtistsConfirmation()">Cancel</button>
                <button class="btn btn-success" onclick="confirmPrintArtists()" id="confirm-print-artists-btn">
                    <i class="fas fa-print"></i> Print Now
                </button>
            </div>
        </div>
    </div>

    <div id="accessory-edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> Edit Accessory</h3>
                <button class="modal-close" onclick="closeAccessoryEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="accessory-form-grid">
                    <div style="grid-column: 1/-1;">
                        <label for="edit-accessory-description">Description *</label>
                        <input type="text" id="edit-accessory-description" class="filter-select" style="width: 100%;">
                    </div>
                    <div>
                        <label for="edit-accessory-price">Store Price *</label>
                        <input type="number" id="edit-accessory-price" step="0.01" min="0" class="filter-select">
                    </div>
                    <div>
                        <label for="edit-accessory-count">Count</label>
                        <input type="number" id="edit-accessory-count" min="0" class="filter-select">
                    </div>
                </div>
                
                <div class="barcode-preview" id="edit-barcode-preview">
                    <!-- Barcode will be shown here -->
                </div>
                
                <div class="info-message" style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-top: 10px;">
                    <i class="fas fa-info-circle"></i> Barcode is automatically generated and can't be edited directly. Click "Regenerate Barcode" to create a new one.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="regenerateAccessoryBarcode()" id="regenerate-barcode-btn">
                    <i class="fas fa-sync-alt"></i> Regenerate Barcode
                </button>
                <button class="btn btn-secondary" onclick="closeAccessoryEditModal()">Cancel</button>
                <button class="btn btn-success" onclick="updateAccessory()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <div id="accessory-delete-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i> Confirm Delete</h3>
                <button class="modal-close" onclick="closeAccessoryDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this accessory?</p>
                <p><strong id="delete-accessory-description"></strong></p>
                <p class="info-message" style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px;">
                    <i class="fas fa-exclamation-circle"></i> This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAccessoryDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteAccessory()">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <div id="barcode-print-container" style="display: none;"></div>

    <script>
        // Global variables
        let consignorCache = {};
        let allRecords = [];
        let filteredRecords = [];
        let currentPage = 1;
        let pageSize = 100;
        let totalPages = 1;
        let dbConfigValues = {};
        let recentlyPrintedIds = new Set();
        let currentSearchResults = [];
        let availableTerminals = [];
        let selectedTerminalId = null;
        let activeCheckoutId = null;
        let checkoutPollInterval = null;
        
        // Shopping Cart Variables
        let checkoutCart = [];
        let pendingCartCheckout = null;
        
        // Receipts Storage
        let savedReceipts = [];
        
        // Consignors list with owed amounts
        let consignorsList = [];
        let consignorOwedAmounts = {};
        
        // Artists variables
        let allArtists = [];
        let filteredArtists = [];
        let artistsCurrentPage = 1;
        let artistsPageSize = 50;
        let artistsTotalPages = 1;
        let selectedArtists = new Set();
        
        // Genre mismatches variables
        let allMismatches = [];
        let filteredMismatches = [];
        let mismatchesCurrentPage = 1;
        let mismatchesPageSize = 25;
        let mismatchesTotalPages = 1;
        
        // Genre edit variables
        let currentEditArtist = null;
        let currentEditGenreId = null;

        // Accessories variables
        let allAccessories = [];
        let filteredAccessories = [];
        let currentEditAccessoryId = null;
        let currentDeleteAccessoryId = null;
        let selectedAccessories = new Set();

         
        // Function to send text directly to your thermal printer
        async function printToThermalPrinter(text) {
            try {
                // Use AppConfig to get the base URL
                const baseUrl = window.AppConfig ? AppConfig.baseUrl : 'http://localhost:5000';
                const url = `${baseUrl}/print-receipt`;
                
                console.log('Sending print job to:', url);
                console.log('Text length:', text.length);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include', // Include cookies if needed
                    body: JSON.stringify({
                        printer: '/dev/usb/lp2',  // Your printer path
                        data: text
                    })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Print failed:', errorText);
                } else {
                    const result = await response.json();
                    console.log('Print job sent successfully:', result);
                }
            } catch (error) {
                console.error('Error printing:', error);
            }
        }

        // Function to format receipt for thermal printer
        function formatReceiptForPrinter(transaction) {
            const storeName = transaction.storeName || 'PigStyle Music';
            const storeAddress = transaction.storeAddress || '';
            const storePhone = transaction.storePhone || '';
            const dateStr = transaction.date.toLocaleString();
            
            let receipt = [];
            
            // Header - Initialize printer and center align
            receipt.push('\x1B\x40'); // Initialize printer
            receipt.push('\x1B\x61\x01'); // Center align
            receipt.push(storeName + '\n');
            if (storeAddress) receipt.push(storeAddress + '\n');
            if (storePhone) receipt.push(storePhone + '\n');
            receipt.push(''.padEnd(32, '-') + '\n');
            
            // Receipt info - Left align
            receipt.push('\x1B\x61\x00'); // Left align
            receipt.push(`Receipt #: ${transaction.id}\n`);
            receipt.push(`Date: ${dateStr}\n`);
            receipt.push(`Cashier: ${transaction.cashier || 'Admin'}\n`);
            receipt.push(''.padEnd(32, '-') + '\n');
            
            // Items header - Bold on
            receipt.push('\x1B\x45\x01'); // Bold on
            receipt.push('Item'.padEnd(24) + 'Price\n');
            receipt.push('\x1B\x45\x00'); // Bold off
            receipt.push(''.padEnd(32, '-') + '\n');
            
            // Items
            transaction.items.forEach(item => {
                let line;
                if (item.type === 'accessory') {
                    const desc = (item.description || '').substring(0, 18);
                    line = `[ACC] ${desc}`.padEnd(24) + `$${item.store_price.toFixed(2)}`.padStart(8) + '\n';
                } else {
                    const title = (item.title || '').substring(0, 22);
                    line = `${title}`.padEnd(24) + `$${item.store_price.toFixed(2)}`.padStart(8) + '\n';
                }
                receipt.push(line);
            });
            
            receipt.push(''.padEnd(32, '-') + '\n');
            
            // Totals - Bold on
            receipt.push('\x1B\x45\x01'); // Bold on
            receipt.push(`Subtotal:`.padEnd(24) + `$${transaction.subtotal.toFixed(2)}`.padStart(8) + '\n');
            receipt.push(`Tax (${transaction.taxRate || 0}%):`.padEnd(24) + `$${transaction.tax.toFixed(2)}`.padStart(8) + '\n');
            receipt.push(`TOTAL:`.padEnd(24) + `$${transaction.total.toFixed(2)}`.padStart(8) + '\n');
            receipt.push('\x1B\x45\x00'); // Bold off
            
            // Payment info
            receipt.push(''.padEnd(32, '-') + '\n');
            receipt.push(`Payment: ${transaction.paymentMethod || 'Cash'}\n`);
            if (transaction.tendered) {
                receipt.push(`Tendered:`.padEnd(24) + `$${transaction.tendered.toFixed(2)}`.padStart(8) + '\n');
                receipt.push(`Change:`.padEnd(24) + `$${transaction.change.toFixed(2)}`.padStart(8) + '\n');
            }
            
            // Footer - Center align
            receipt.push(''.padEnd(32, '-') + '\n');
            receipt.push('\x1B\x61\x01'); // Center align
            receipt.push(transaction.footer || 'Thank you for your purchase!\n');
            receipt.push('\n\n\n'); // Feed paper for tear-off
            
            // Cut paper (if supported)
            receipt.push('\x1B\x69'); // Cut paper command for many thermal printers
            
            return receipt.join('');
        }

        // Fetch all config values from database
        async function fetchAllConfigValues() {
            const response = await fetch(`${AppConfig.baseUrl}/config`);
            const data = await response.json();
            
            if (data.status === 'success') {
                dbConfigValues = data.configs || {};
                return dbConfigValues;
            } else {
                throw new Error('Failed to fetch configuration from database');
            }
        }

        // Get a specific config value
        function getConfigValue(key) {
            if (!dbConfigValues[key]) {
                throw new Error(`Configuration key '${key}' not found in database`);
            }
            const value = dbConfigValues[key].value;
            
            if (value === 'true') return true;
            if (value === 'false') return false;
            if (!isNaN(value) && value !== '') return parseFloat(value);
            return value;
        }

        // Update a config value in database
        async function updateConfigValue(key, newValue) {
            const response = await fetch(`${AppConfig.baseUrl}/config/${key}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    config_value: String(newValue)
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                if (!dbConfigValues[key]) {
                    dbConfigValues[key] = {
                        value: String(newValue),
                        description: ''
                    };
                } else {
                    dbConfigValues[key].value = String(newValue);
                }
                return true;
            } else {
                throw new Error(`Failed to update configuration key '${key}'`);
            }
        }

        // Delete a config value
        async function deleteConfigValue(key) {
            if (!confirm(`Are you sure you want to delete '${key}'? This action cannot be undone.`)) {
                return false;
            }
            
            const response = await fetch(`${AppConfig.baseUrl}/config/${key}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                delete dbConfigValues[key];
                return true;
            } else {
                throw new Error(`Failed to delete configuration key '${key}'`);
            }
        }

        // Add a new config value
        async function addConfigValue(key, value, description) {
            const response = await fetch(`${AppConfig.baseUrl}/config`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    config_key: key,
                    config_value: String(value),
                    description: description
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                dbConfigValues[key] = {
                    value: String(value),
                    description: description || ''
                };
                return true;
            } else {
                throw new Error(`Failed to add configuration key '${key}'`);
            }
        }

        // Load both config tables
        async function loadConfigTables() {
            await fetchAllConfigValues();
            
            const printKeys = [
                'LABEL_WIDTH_MM',
                'LABEL_HEIGHT_MM',
                'LEFT_MARGIN_MM',
                'GUTTER_SPACING_MM',
                'TOP_MARGIN_MM',
                'PRICE_FONT_SIZE',
                'TEXT_FONT_SIZE',
                'ARTIST_LABEL_FONT_SIZE',
                'BARCODE_HEIGHT',
                'PRINT_BORDERS',
                'PRICE_Y_POS',
                'BARCODE_Y_POS',
                'INFO_Y_POS'
            ];
            
            const printConfigBody = document.getElementById('print-config-body');
            const generalConfigBody = document.getElementById('general-config-body');
            
            let printHtml = '';
            let generalHtml = '';
            
            const sortedKeys = Object.keys(dbConfigValues).sort();
            
            for (const key of sortedKeys) {
                const config = dbConfigValues[key];
                const value = config.value;
                const description = config.description || '';
                
                const rowHtml = `
                    <tr id="config-row-${key.replace(/\./g, '-')}">
                        <td><code>${key}</code></td>
                        <td>
                            <input type="text" class="config-value-input" data-key="${key}" value="${value}" style="width: 100%; padding: 5px;">
                        </td>
                        <td>${description}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="saveConfigValue('${key}')">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteConfigValue('${key}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
                
                if (printKeys.includes(key)) {
                    printHtml += rowHtml;
                } else {
                    generalHtml += rowHtml;
                }
            }
            
            printConfigBody.innerHTML = printHtml || '<tr><td colspan="4" style="text-align:center; padding:20px;">No print settings found</td></tr>';
            generalConfigBody.innerHTML = generalHtml || '<tr><td colspan="4" style="text-align:center; padding:20px;">No general settings found</td></tr>';
            
            updateUIFromConfig();
        }

        // Add new configuration
        async function addNewConfig() {
            const key = document.getElementById('new-config-key').value.trim();
            const value = document.getElementById('new-config-value').value.trim();
            const description = document.getElementById('new-config-description').value.trim();
            
            if (!key || !value) {
                alert('Key and Value are required');
                return;
            }
            
            if (dbConfigValues[key]) {
                alert(`Configuration key '${key}' already exists`);
                return;
            }
            
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Adding...';
            button.disabled = true;
            
            try {
                await addConfigValue(key, value, description);
                
                document.getElementById('new-config-key').value = '';
                document.getElementById('new-config-value').value = '';
                document.getElementById('new-config-description').value = '';
                
                await loadConfigTables();
                
                button.innerHTML = '<i class="fas fa-check"></i> Added!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
                
            } catch (error) {
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
                alert(`Error: ${error.message}`);
            }
        }

        // Save a specific config value
        async function saveConfigValue(key) {
            const input = document.querySelector(`.config-value-input[data-key="${key}"]`);
            const newValue = input.value.trim();
            
            const button = input.closest('tr').querySelector('button.btn-success');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Saving...';
            button.disabled = true;
            
            try {
                await updateConfigValue(key, newValue);
                
                button.innerHTML = '<i class="fas fa-check"></i> Saved!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
                
                updateUIFromConfig();
                
            } catch (error) {
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
                throw error;
            }
        }

        // Update UI elements that depend on config values
        function updateUIFromConfig() {
            try {
                const taxRate = getConfigValue('TAX_RATE');
                document.getElementById('tax-rate-display').textContent = taxRate;
                
                document.getElementById('commission-rate-display').textContent = 'Per Record';
                document.getElementById('admin-commission-display').textContent = 'Per Record';
                document.getElementById('consignor-commission-display').textContent = 'Per Record';
                
            } catch (error) {
                console.error('Error updating UI from config:', error);
            }
        }

        // Get admin config values for backward compatibility
        function getAdminConfig() {
            let taxRate = 0;
            let taxEnabled = false;
            let commissionRate = 10;
            
            try {
                taxRate = getConfigValue('TAX_RATE');
            } catch (e) {
                console.log('TAX_RATE not found, using default');
            }
            
            try {
                taxEnabled = getConfigValue('TAX_ENABLED');
            } catch (e) {
                console.log('TAX_ENABLED not found, using default false');
            }
            
            try {
                commissionRate = getConfigValue('COMMISSION_RATE');
            } catch (e) {
                console.log('COMMISSION_RATE not found, using default 10');
            }
            
            return {
                taxRate: taxRate,
                taxEnabled: taxEnabled,
                commissionRate: commissionRate,
                storeName: (dbConfigValues['STORE_NAME'] && dbConfigValues['STORE_NAME'].value) || 'PigStyle Music',
                storeAddress: (dbConfigValues['STORE_ADDRESS'] && dbConfigValues['STORE_ADDRESS'].value) || '',
                storePhone: (dbConfigValues['STORE_PHONE'] && dbConfigValues['STORE_PHONE'].value) || '',
                receiptFooter: (dbConfigValues['RECEIPT_FOOTER'] && dbConfigValues['RECEIPT_FOOTER'].value) || 'Thank you for your purchase!',
                autoPrintReceipt: (dbConfigValues['AUTO_PRINT_RECEIPT'] && dbConfigValues['AUTO_PRINT_RECEIPT'].value) || false
            };
        }
        
        // Load saved receipts from localStorage
        function loadSavedReceipts() {
            const saved = localStorage.getItem('pigstyle_receipts');
            if (saved) {
                try {
                    savedReceipts = JSON.parse(saved);
                    savedReceipts.forEach(receipt => {
                        receipt.date = new Date(receipt.date);
                    });
                } catch (e) {
                    console.error('Error loading receipts:', e);
                    savedReceipts = [];
                }
            }
            return savedReceipts;
        }
        
        // Save a receipt to localStorage
        function saveReceipt(transaction) {
            const receiptToSave = {
                ...transaction,
                date: transaction.date.toISOString()
            };
            
            savedReceipts.unshift(receiptToSave);
            
            if (savedReceipts.length > 1000) {
                savedReceipts = savedReceipts.slice(0, 1000);
            }
            
            localStorage.setItem('pigstyle_receipts', JSON.stringify(savedReceipts));
            
            if (document.getElementById('receipts-tab').classList.contains('active')) {
                renderReceipts(savedReceipts);
            }
        }
        
        // Render receipts in the receipts tab
        function renderReceipts(receipts) {
            const container = document.getElementById('receipts-grid');
            
            if (receipts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; grid-column: 1/-1;">
                        <i class="fas fa-receipt" style="font-size: 48px; margin-bottom: 20px; color: #ccc;"></i>
                        <p>No receipts found</p>
                    </div>
                `;
                
                document.getElementById('total-receipts').textContent = '0';
                document.getElementById('total-receipts-sales').textContent = '$0.00';
                document.getElementById('total-receipts-tax').textContent = '$0.00';
                document.getElementById('total-receipts-items').textContent = '0';
                return;
            }
            
            let html = '';
            let totalSales = 0;
            let totalTax = 0;
            let totalItems = 0;
            
            receipts.forEach(receipt => {
                const date = new Date(receipt.date);
                const dateStr = date.toLocaleDateString() + ' ' + 
                               date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const itemCount = receipt.items.length;
                const itemSummary = itemCount === 1 ? 
                    (receipt.items[0].type === 'accessory' ? receipt.items[0].description : receipt.items[0].artist + ' - ' + receipt.items[0].title) : 
                    `${itemCount} items`;
                
                totalSales += receipt.total || 0;
                totalTax += receipt.tax || 0;
                totalItems += itemCount;
                
                html += `
                    <div class="receipt-card" onclick="viewReceipt('${receipt.id}')">
                        <div class="receipt-card-header">
                            <span class="receipt-card-title">${receipt.id}</span>
                            <span class="receipt-card-date">${dateStr}</span>
                        </div>
                        <div class="receipt-card-meta">
                            <span>Items: ${itemCount}</span>
                            <span class="receipt-card-total">$${(receipt.total || 0).toFixed(2)}</span>
                        </div>
                        <div class="receipt-card-items" title="${itemSummary}">
                            <i class="fas fa-music"></i> ${itemSummary}
                        </div>
                        <div class="receipt-card-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-primary" onclick="viewReceipt('${receipt.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-success" onclick="downloadReceiptPDF('${receipt.id}')">
                                <i class="fas fa-download"></i> PDF
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="printReceipt('${receipt.id}')">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            document.getElementById('total-receipts').textContent = receipts.length;
            document.getElementById('total-receipts-sales').textContent = `$${totalSales.toFixed(2)}`;
            document.getElementById('total-receipts-tax').textContent = `$${totalTax.toFixed(2)}`;
            document.getElementById('total-receipts-items').textContent = totalItems;
        }
        
        // Search receipts
        function searchReceipts() {
            const startDate = document.getElementById('receipt-start-date').value;
            const endDate = document.getElementById('receipt-end-date').value;
            const query = document.getElementById('receipt-search-query').value.toLowerCase().trim();
            
            let filtered = [...savedReceipts];
            
            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                filtered = filtered.filter(r => new Date(r.date) >= start);
            }
            
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filtered = filtered.filter(r => new Date(r.date) <= end);
            }
            
            if (query) {
                filtered = filtered.filter(r => 
                    r.id.toLowerCase().includes(query) ||
                    r.items.some(item => 
                        (item.artist && item.artist.toLowerCase().includes(query)) ||
                        (item.title && item.title.toLowerCase().includes(query)) ||
                        (item.catalog_number && item.catalog_number.toLowerCase().includes(query)) ||
                        (item.description && item.description.toLowerCase().includes(query))
                    )
                );
            }
            
            renderReceipts(filtered);
        }
        
        // Reset receipt search
        function resetReceiptSearch() {
            document.getElementById('receipt-start-date').value = '';
            document.getElementById('receipt-end-date').value = '';
            document.getElementById('receipt-search-query').value = '';
            renderReceipts(savedReceipts);
        }
        
        // View a specific receipt
        function viewReceipt(receiptId) {
            const receipt = savedReceipts.find(r => r.id === receiptId);
            if (receipt) {
                if (typeof receipt.date === 'string') {
                    receipt.date = new Date(receipt.date);
                }
                showReceipt(receipt);
            }
        }
        
        // Download receipt as PDF
        async function downloadReceiptPDF(receiptId) {
            const receipt = savedReceipts.find(r => r.id === receiptId);
            if (!receipt) return;
            
            if (typeof receipt.date === 'string') {
                receipt.date = new Date(receipt.date);
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const dateStr = receipt.date.toLocaleDateString() + ' ' + 
                           receipt.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let y = 20;
            
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(receipt.storeName || (dbConfigValues['STORE_NAME'] && dbConfigValues['STORE_NAME'].value) || 'PigStyle Music', 105, y, { align: 'center' });
            
            y += 7;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(receipt.storeAddress || (dbConfigValues['STORE_ADDRESS'] && dbConfigValues['STORE_ADDRESS'].value) || '', 105, y, { align: 'center' });
            
            y += 5;
            doc.text(receipt.storePhone || (dbConfigValues['STORE_PHONE'] && dbConfigValues['STORE_PHONE'].value) || '', 105, y, { align: 'center' });
            
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('RECEIPT', 105, y, { align: 'center' });
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(`Receipt #: ${receipt.id}`, 20, y);
            doc.text(`Date: ${dateStr}`, 20, y + 5);
            
            y += 15;
            
            doc.setFont('helvetica', 'bold');
            doc.text('Item', 20, y);
            doc.text('Price', 180, y, { align: 'right' });
            doc.line(20, y + 2, 190, y + 2);
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            
            receipt.items.forEach((item, index) => {
                let desc;
                if (item.type === 'accessory') {
                    desc = `[ACCESSORY] ${item.description || 'Unknown'}`;
                } else {
                    desc = `${item.artist || 'Unknown'} - ${item.title || 'Unknown'}`;
                }
                const price = `$${(item.store_price || 0).toFixed(2)}`;
                
                if (desc.length > 40) {
                    doc.text(desc.substring(0, 37) + '...', 20, y);
                } else {
                    doc.text(desc, 20, y);
                }
                doc.text(price, 180, y, { align: 'right' });
                
                y += 5;
                
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
            });
            
            y += 5;
            doc.line(20, y, 190, y);
            y += 5;
            
            doc.setFont('helvetica', 'bold');
            doc.text(`Subtotal: $${(receipt.subtotal || 0).toFixed(2)}`, 180, y, { align: 'right' });
            y += 5;
            doc.text(`Tax (${receipt.taxRate || (dbConfigValues['TAX_RATE'] && dbConfigValues['TAX_RATE'].value) || 0}%): $${(receipt.tax || 0).toFixed(2)}`, 180, y, { align: 'right' });
            y += 5;
            doc.setFontSize(11);
            doc.text(`TOTAL: $${(receipt.total || 0).toFixed(2)}`, 180, y, { align: 'right' });
            
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Payment Method: ${receipt.paymentMethod || 'Cash'}`, 20, y);
            y += 5;
            doc.text(`Tendered: $${(receipt.tendered || 0).toFixed(2)}`, 20, y);
            y += 5;
            doc.text(`Change: $${(receipt.change || 0).toFixed(2)}`, 20, y);
            
            y += 10;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            doc.text(receipt.footer || (dbConfigValues['RECEIPT_FOOTER'] && dbConfigValues['RECEIPT_FOOTER'].value) || 'Thank you for your purchase!', 105, y, { align: 'center' });
            
            doc.save(`${receipt.id}.pdf`);
        }
        
        // Print receipt
        function printReceipt(receiptId) {
            const receipt = savedReceipts.find(r => r.id === receiptId);
            if (receipt) {
                if (typeof receipt.date === 'string') {
                    receipt.date = new Date(receipt.date);
                }
                showReceipt(receipt);
                setTimeout(() => {
                    window.print();
                }, 500);
            }
        }
        
        // Show receipt in modal
        function showReceipt(transaction) {
            const receiptContent = document.getElementById('receipt-content');
            const dateStr = transaction.date.toLocaleDateString() + ' ' + 
                           transaction.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let itemsHtml = '';
            transaction.items.forEach(item => {
                if (item.type === 'accessory') {
                    itemsHtml += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <div><span class="accessory-badge" style="background: #9b59b6; color: white; padding: 2px 6px; border-radius: 4px; margin-right: 5px;">ACC</span> ${escapeHtml(item.description) || 'Unknown Accessory'}</div>
                            <div>$${(item.store_price || 0).toFixed(2)}</div>
                        </div>
                    `;
                } else {
                    itemsHtml += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <div>${escapeHtml(item.artist) || 'Unknown'} - ${escapeHtml(item.title) || 'Unknown'}</div>
                            <div>$${(item.store_price || 0).toFixed(2)}</div>
                        </div>
                    `;
                }
            });
            
            receiptContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2>${escapeHtml(transaction.storeName) || (dbConfigValues['STORE_NAME'] && dbConfigValues['STORE_NAME'].value) || 'PigStyle Music'}</h2>
                    <p>${escapeHtml(transaction.storeAddress) || (dbConfigValues['STORE_ADDRESS'] && dbConfigValues['STORE_ADDRESS'].value) || ''}</p>
                    <p>${escapeHtml(transaction.storePhone) || (dbConfigValues['STORE_PHONE'] && dbConfigValues['STORE_PHONE'].value) || ''}</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span><strong>Receipt #:</strong> ${escapeHtml(transaction.id)}</span>
                        <span><strong>Date:</strong> ${dateStr}</span>
                    </div>
                    <div><strong>Cashier:</strong> ${escapeHtml(transaction.cashier) || 'Admin'}</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h3>Items</h3>
                    ${itemsHtml}
                </div>
                
                <div style="border-top: 1px solid #ccc; padding-top: 10px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Subtotal:</span>
                        <span>$${(transaction.subtotal || 0).toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Tax (${transaction.taxRate || (dbConfigValues['TAX_RATE'] && dbConfigValues['TAX_RATE'].value) || 0}%):</span>
                        <span>$${(transaction.tax || 0).toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 18px; margin-top: 10px;">
                        <span>TOTAL:</span>
                        <span>$${(transaction.total || 0).toFixed(2)}</span>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <div><strong>Payment Method:</strong> ${escapeHtml(transaction.paymentMethod) || 'Cash'}</div>
                    ${transaction.tendered ? `<div><strong>Tendered:</strong> $${transaction.tendered.toFixed(2)}</div>` : ''}
                    ${transaction.change ? `<div><strong>Change:</strong> $${transaction.change.toFixed(2)}</div>` : ''}
                </div>
                
                <div style="text-align: center; margin-top: 30px; font-style: italic;">
                    ${escapeHtml(transaction.footer) || (dbConfigValues['RECEIPT_FOOTER'] && dbConfigValues['RECEIPT_FOOTER'].value) || 'Thank you for your purchase!'}
                </div>
            `;
            
            document.getElementById('receipt-modal').style.display = 'flex';
        }
        
        // Close receipt modal
        function closeReceiptModal() {
            document.getElementById('receipt-modal').style.display = 'none';
        }
        
        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            if (!text) return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Helper functions
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'admin-config') {
                loadConfigTables();
            }
            else if (tabName === 'check-out') {
                const searchResults = document.getElementById('search-results');
                if (currentSearchResults.length === 0) {
                    searchResults.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 20px; color: #ccc;"></i>
                            <p>Enter a search term to find records or accessories</p>
                        </div>
                    `;
                }
                refreshTerminals();
            } else if (tabName === 'receipts') {
                loadSavedReceipts();
                renderReceipts(savedReceipts);
            } else if (tabName === 'consignors') {
                loadConsignors();
            } else if (tabName === 'artists') {
                loadArtists();
            } else if (tabName === 'genres') {
                loadGenreMismatches();
            } else if (tabName === 'accessories') {
                loadAccessories();
            }
        }
        
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        function showCheckoutStatus(message, type = 'info') {
            const statusEl = document.getElementById('checkout-status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showCheckoutLoading(show) {
            document.getElementById('checkout-loading').style.display = show ? 'block' : 'none';
        }
        
        function showReceiptsLoading(show) {
            document.getElementById('receipts-loading').style.display = show ? 'block' : 'none';
        }
        
        function showArtistsLoading(show) {
            document.getElementById('artists-loading').style.display = show ? 'block' : 'none';
        }
        
        function showGenresLoading(show) {
            document.getElementById('genres-loading').style.display = show ? 'block' : 'none';
        }

        function showAccessoriesLoading(show) {
            document.getElementById('accessories-loading').style.display = show ? 'block' : 'none';
        }
        
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength - 1) + '' : text;
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (e) {
                return dateString.split('T')[0] || 'Unknown';
            }
        }
        
        function getStatusClass(statusId) {
            switch(statusId) {
                case 1: return 'condition-gplus';
                case 2: return 'condition-vgplus';
                case 3: return 'condition-mint';
                default: return 'condition-g';
            }
        }
        
        function getStatusText(statusId) {
            switch(statusId) {
                case 1: return 'Inactive';
                case 2: return 'Active';
                case 3: return 'Sold';
                default: return `Status ${statusId || '?'}`;
            }
        }
        
        function getStatusIdFromFilter(filterValue) {
            switch(filterValue) {
                case 'inactive': return 1;
                case 'active': return 2;
                case 'sold': return 3;
                default: return null;
            }
        }
        
        async function getConsignorInfo(consignorId) {
            if (!consignorId) return { username: 'None', initials: '' };
            
            if (consignorCache[consignorId]) {
                return consignorCache[consignorId];
            }
            
            try {
                const url = `${AppConfig.baseUrl}/users/${consignorId}`;
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        const user = data.user || {};
                        const consignorInfo = {
                            username: user.username || `User ${consignorId}`,
                            initials: user.initials || (user.username ? user.username.substring(0, 2).toUpperCase() : '')
                        };
                        consignorCache[consignorId] = consignorInfo;
                        return consignorInfo;
                    }
                }
            } catch (error) {
                console.log('Error fetching consignor:', error);
            }
            
            return { username: `User ${consignorId}`, initials: '' };
        }
        
        async function loadUsers() {
            const url = `${AppConfig.baseUrl}/users`;
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.status === 'success') {
                const users = data.users || [];
                const userSelect = $('#user-select');
                userSelect.empty();
                userSelect.append('<option value="all">All Users</option>');
                
                users.forEach(user => {
                    userSelect.append(`<option value="${user.id}">${user.username} (ID: ${user.id})</option>`);
                });
                
                users.forEach(user => {
                    consignorCache[user.id] = {
                        username: user.username || `User ${user.id}`,
                        initials: user.initials || (user.username ? user.username.substring(0, 2).toUpperCase() : '')
                    };
                });
            }
        }
        
        async function loadRecords() {
            showLoading(true);
            
            const userSelect = document.getElementById('user-select');
            const selectedUserId = userSelect.value === 'all' ? null : userSelect.value;
            
            let url;
            if (selectedUserId) {
                url = `${AppConfig.baseUrl}/records/user/${selectedUserId}`;
            } else {
                url = `${AppConfig.baseUrl}/records`;
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.status === 'success') {
                allRecords = data.records || [];
                
                allRecords.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                document.getElementById('total-records').textContent = allRecords.length;
                const inactiveCount = allRecords.filter(r => r.status_id === 1).length;
                const activeCount = allRecords.filter(r => r.status_id === 2).length;
                const soldCount = allRecords.filter(r => r.status_id === 3).length;
                
                document.getElementById('inactive-records').textContent = inactiveCount;
                document.getElementById('active-records').textContent = activeCount;
                document.getElementById('sold-records').textContent = soldCount;
                
                const batchSizeInput = document.getElementById('batch-size');
                batchSizeInput.max = inactiveCount;
                batchSizeInput.value = Math.min(parseInt(batchSizeInput.value) || 10, inactiveCount);
                
                const consignorIds = new Set();
                allRecords.forEach(r => { if (r.consignor_id) consignorIds.add(r.consignor_id); });
                const fetchPromises = Array.from(consignorIds).map(id => getConsignorInfo(id));
                await Promise.all(fetchPromises);
                
                filterRecords();
                
                showStatus(`Loaded ${allRecords.length} records (${inactiveCount} inactive, ${activeCount} active, ${soldCount} sold)`, 'success');
            }
            
            showLoading(false);
        }
        
        function filterRecords() {
            const statusFilter = document.getElementById('status-filter').value;
            const statusId = getStatusIdFromFilter(statusFilter);
            
            if (statusId) {
                filteredRecords = allRecords.filter(r => r.status_id === statusId);
            } else {
                filteredRecords = [...allRecords];
            }
            
            filteredRecords.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            currentPage = 1;
            updatePagination();
            renderCurrentPage();
            
            const statusText = statusFilter === 'all' ? 'All records' : 
                              statusFilter === 'inactive' ? 'Inactive records' :
                              statusFilter === 'active' ? 'Active records' : 'Sold records';
            
            showStatus(`Showing ${filteredRecords.length} ${statusText}`, 'info');
        }
        
        function updatePagination() {
            totalPages = Math.ceil(filteredRecords.length / pageSize);
            if (totalPages === 0) totalPages = 1;
            
            document.getElementById('total-pages').textContent = totalPages;
            document.getElementById('current-page').value = currentPage;
            document.getElementById('total-filtered').textContent = filteredRecords.length;
            
            document.getElementById('first-page-btn').disabled = currentPage === 1;
            document.getElementById('prev-page-btn').disabled = currentPage === 1;
            document.getElementById('next-page-btn').disabled = currentPage === totalPages;
            document.getElementById('last-page-btn').disabled = currentPage === totalPages;
            
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, filteredRecords.length);
            
            document.getElementById('showing-start').textContent = filteredRecords.length > 0 ? startIndex : 0;
            document.getElementById('showing-end').textContent = filteredRecords.length > 0 ? endIndex : 0;
            document.getElementById('total-filtered').textContent = filteredRecords.length;
            
            const selectedCount = window.selectedRecords ? window.selectedRecords.size : 0;
            document.getElementById('selected-count').textContent = selectedCount;
            
            updateButtonStates();
        }
        
        function updateButtonStates() {
            const selectedCount = window.selectedRecords ? window.selectedRecords.size : 0;
            const hasSelection = selectedCount > 0;
            
            document.getElementById('print-btn').disabled = !hasSelection;
            document.getElementById('mark-active-btn').disabled = !hasSelection;
        }
        
        function renderCurrentPage() {
            const tbody = document.getElementById('records-body');
            tbody.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; padding: 20px; color: #666;">No records found</td></tr>`;
                updatePagination();
                return;
            }
            
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredRecords.length);
            const pageRecords = filteredRecords.slice(startIndex, endIndex);
            
            pageRecords.forEach((record, index) => {
                const globalIndex = startIndex + index;
                const consignorInfo = consignorCache[record.consignor_id] || { username: 'None', initials: '' };
                
                const isRecentlyPrinted = recentlyPrintedIds.has(record.id.toString());
                
                const tr = document.createElement('tr');
                if (isRecentlyPrinted) {
                    tr.style.backgroundColor = '#f0fff0';
                    tr.style.borderLeft = '3px solid #27ae60';
                }
                
                tr.innerHTML = `
                    <td><input type="checkbox" class="record-checkbox" data-id="${record.id}" ${window.selectedRecords && window.selectedRecords.has(record.id.toString()) ? 'checked' : ''}></td>
                    <td>${globalIndex + 1}</td>
                    <td><strong>${formatDate(record.created_at)}</strong></td>
                    <td>${truncateText(escapeHtml(record.artist) || 'Unknown', 25)}</td>
                    <td>${truncateText(escapeHtml(record.title) || 'Unknown', 30)}</td>
                    <td>$${(record.store_price || 0).toFixed(2)}</td>
                    <td>${truncateText(escapeHtml(record.catalog_number) || 'N/A', 15)}</td>
                    <td>${truncateText(escapeHtml(record.genre_name || record.genre) || 'Unknown', 20)}</td>
                    <td>${record.barcode || 'N/A'}</td>
                    <td>
                        ${record.consignor_id ? 
                            `<span class="consignor-badge" title="${escapeHtml(consignorInfo.username)}">${escapeHtml(consignorInfo.initials) || escapeHtml(consignorInfo.username.substring(0, 2))}</span>` : 
                            '<span style="color: #999;">None</span>'}
                    </td>
                    <td>
                        <span class="condition-badge ${getStatusClass(record.status_id)}">
                            ${getStatusText(record.status_id)}
                        </span>
                        ${isRecentlyPrinted ? '<br><small style="color: #27ae60; font-size: 10px;">(Printed)</small>' : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const recordId = this.getAttribute('data-id');
                    if (this.checked) {
                        window.selectedRecords.add(recordId);
                    } else {
                        window.selectedRecords.delete(recordId);
                    }
                    updateButtonStates();
                    updatePagination();
                });
            });
            
            const selectAllCheckbox = document.getElementById('select-all');
            selectAllCheckbox.checked = false;
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.record-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    const recordId = checkbox.getAttribute('data-id');
                    if (this.checked) {
                        window.selectedRecords.add(recordId);
                    } else {
                        window.selectedRecords.delete(recordId);
                    }
                });
                updateButtonStates();
                updatePagination();
            });
            
            updatePagination();
        }
        
        function goToPage(page) {
            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;
            
            currentPage = page;
            renderCurrentPage();
            updatePagination();
        }
        
        function goToFirstPage() {
            goToPage(1);
        }
        
        function goToPreviousPage() {
            goToPage(currentPage - 1);
        }
        
        function goToNextPage() {
            goToPage(currentPage + 1);
        }
        
        function goToLastPage() {
            goToPage(totalPages);
        }
        
        function changePageSize(newSize) {
            pageSize = newSize;
            currentPage = 1;
            updatePagination();
            renderCurrentPage();
        }
        
        function updateSelectionUI() {
            const count = window.selectedRecords ? window.selectedRecords.size : 0;
            document.getElementById('selected-tags').textContent = count;
            updateButtonStates();
        }
        
        function selectRecentInactiveRecords() {
            const batchSize = parseInt(document.getElementById('batch-size').value) || 10;
            
            window.selectedRecords.clear();
            
            const inactiveRecords = allRecords
                .filter(r => r.status_id === 1)
                .slice(0, batchSize);
            
            inactiveRecords.forEach(record => {
                window.selectedRecords.add(record.id.toString());
            });
            
            renderCurrentPage();
            
            if (inactiveRecords.length > 0) {
                showStatus(`Selected ${inactiveRecords.length} most recent inactive records`, 'success');
            } else {
                showStatus('No inactive records available to select', 'info');
            }
        }
        
        function selectAllOnPage() {
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredRecords.length);
            const pageRecords = filteredRecords.slice(startIndex, endIndex);
            
            pageRecords.forEach((record) => {
                const recordId = record.id.toString();
                window.selectedRecords.add(recordId);
            });
            
            renderCurrentPage();
            
            showStatus(`Selected all ${pageRecords.length} records on this page`, 'success');
        }
        
        function clearSelection() {
            window.selectedRecords.clear();
            renderCurrentPage();
            showStatus('Selection cleared', 'info');
        }
        
        // Modal Functions
        function showPrintConfirmation() {
            const selectedIds = Array.from(window.selectedRecords);
            if (selectedIds.length === 0) {
                showStatus('No records selected for printing', 'error');
                return;
            }
            
            const selectedRecords = allRecords.filter(r => selectedIds.includes(r.id.toString()));
            const inactiveRecords = selectedRecords.filter(r => r.status_id === 1);
            const activeRecords = selectedRecords.filter(r => r.status_id === 2);
            const soldRecords = selectedRecords.filter(r => r.status_id === 3);
            
            document.getElementById('print-count').textContent = selectedRecords.length;
            
            const summaryList = document.getElementById('print-summary-list');
            summaryList.innerHTML = `
                <li>Total selected: ${selectedRecords.length} records</li>
                <li>Inactive records: ${inactiveRecords.length} (will be printed)</li>
                <li>Active records: ${activeRecords.length} (already active)</li>
                <li>Sold records: ${soldRecords.length} (won't be printed)</li>
            `;
            
            document.getElementById('print-confirmation-modal').style.display = 'flex';
        }
        
        function closePrintConfirmation() {
            document.getElementById('print-confirmation-modal').style.display = 'none';
        }
        
        async function confirmPrint() {
            const selectedIds = Array.from(window.selectedRecords);
            
            closePrintConfirmation();
            showLoading(true);
            
            const selectedRecords = allRecords
                .filter(r => selectedIds.includes(r.id.toString()) && r.status_id === 1);
                
            if (selectedRecords.length === 0) {
                showStatus('No inactive records selected', 'error');
                showLoading(false);
                return;
            }
            
            await fetchAllConfigValues();
            
            const pdfBlob = await generatePDF(selectedRecords);
            
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `price_tags_${new Date().toISOString().slice(0, 10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            selectedRecords.forEach(record => {
                recentlyPrintedIds.add(record.id.toString());
            });
            
            window.selectedRecords.clear();
            
            showStatus(`PDF generated for ${selectedRecords.length} records. Now mark them as Active.`, 'success');
            
            renderCurrentPage();
            
            showLoading(false);
        }
        
        function showMarkActiveConfirmation() {
            const selectedIds = Array.from(window.selectedRecords);
            if (selectedIds.length === 0) {
                showStatus('No records selected', 'error');
                return;
            }
            
            const selectedRecords = allRecords.filter(r => selectedIds.includes(r.id.toString()));
            const inactiveRecords = selectedRecords.filter(r => r.status_id === 1);
            const activeRecords = selectedRecords.filter(r => r.status_id === 2);
            const soldRecords = selectedRecords.filter(r => r.status_id === 3);
            
            document.getElementById('mark-active-count').textContent = selectedRecords.length;
            
            const summaryList = document.getElementById('mark-active-summary-list');
            summaryList.innerHTML = `
                <li>Total selected: ${selectedRecords.length} records</li>
                <li>Inactive records: ${inactiveRecords.length} (will be marked as Active)</li>
                <li>Active records: ${activeRecords.length} (already active - no change)</li>
                <li>Sold records: ${soldRecords.length} (won't be changed)</li>
            `;
            
            document.getElementById('mark-active-confirmation-check').checked = false;
            document.getElementById('confirm-mark-active-btn').disabled = true;
            
            document.getElementById('mark-active-confirmation-modal').style.display = 'flex';
            
            document.getElementById('mark-active-confirmation-check').addEventListener('change', function() {
                document.getElementById('confirm-mark-active-btn').disabled = !this.checked;
            });
        }
        
        function closeMarkActiveConfirmation() {
            document.getElementById('mark-active-confirmation-modal').style.display = 'none';
        }
        
        async function confirmMarkActive() {
            const selectedIds = Array.from(window.selectedRecords);
            
            closeMarkActiveConfirmation();
            showLoading(true);
            
            const inactiveRecordIds = selectedIds.filter(id => {
                const record = allRecords.find(r => r.id.toString() === id);
                return record && record.status_id === 1;
            });
            
            if (inactiveRecordIds.length === 0) {
                showStatus('No inactive records to mark as active', 'info');
                showLoading(false);
                return;
            }
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const recordId of inactiveRecordIds) {
                try {
                    const response = await fetch(`${AppConfig.baseUrl}/records/${recordId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            status_id: 2
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'success') {
                            successCount++;
                            
                            const recordIndex = allRecords.findIndex(r => r.id.toString() === recordId);
                            if (recordIndex !== -1) {
                                allRecords[recordIndex].status_id = 2;
                            }
                        } else {
                            errorCount++;
                        }
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    console.error(`Error updating record ${recordId}:`, error);
                    errorCount++;
                }
            }
            
            window.selectedRecords.clear();
            
            inactiveRecordIds.forEach(id => {
                recentlyPrintedIds.delete(id);
            });
            
            await loadRecords();
            
            if (successCount > 0) {
                showStatus(`Successfully marked ${successCount} records as Active${errorCount > 0 ? ` (${errorCount} failed)` : ''}`, 'success');
            } else {
                showStatus(`Failed to mark records as Active: ${errorCount} errors`, 'error');
            }
            
            showLoading(false);
        }
        
        async function generatePDF(records) {
            return new Promise(async (resolve) => {
                const { jsPDF } = window.jspdf;
                
                const labelWidthMM = getConfigValue('LABEL_WIDTH_MM');
                const labelHeightMM = getConfigValue('LABEL_HEIGHT_MM');
                const leftMarginMM = getConfigValue('LEFT_MARGIN_MM');
                const gutterSpacingMM = getConfigValue('GUTTER_SPACING_MM');
                const topMarginMM = getConfigValue('TOP_MARGIN_MM');
                const priceFontSize = getConfigValue('PRICE_FONT_SIZE');
                const textFontSize = getConfigValue('TEXT_FONT_SIZE');
                const artistLabelFontSize = getConfigValue('ARTIST_LABEL_FONT_SIZE');
                const barcodeHeightMM = getConfigValue('BARCODE_HEIGHT');
                const printBorders = getConfigValue('PRINT_BORDERS');
                
                const priceYPos = getConfigValue('PRICE_Y_POS');
                const barcodeYPos = getConfigValue('BARCODE_Y_POS');
                const infoYPos = getConfigValue('INFO_Y_POS');
                
                const mmToPt = 2.83465;
                const labelWidthPt = labelWidthMM * mmToPt;
                const labelHeightPt = labelHeightMM * mmToPt;
                const leftMarginPt = leftMarginMM * mmToPt;
                const gutterSpacingPt = gutterSpacingMM * mmToPt;
                const topMarginPt = topMarginMM * mmToPt;
                const barcodeHeightPt = barcodeHeightMM * mmToPt;
                
                const doc = new jsPDF({
                    unit: 'pt',
                    format: 'letter'
                });
                
                const rows = 15;
                const cols = 4;
                const labelsPerPage = rows * cols;
                
                let currentLabel = 0;
                
                const isArtistLabels = records.length > 0 && records[0].title === 'ARTIST LABEL';
                
                for (const record of records) {
                    if (currentLabel > 0 && currentLabel % labelsPerPage === 0) {
                        doc.addPage();
                    }
                    
                    const pageIndex = currentLabel % labelsPerPage;
                    const row = Math.floor(pageIndex / cols);
                    const col = pageIndex % cols;
                    
                    const x = leftMarginPt + (col * (labelWidthPt + gutterSpacingPt));
                    const y = topMarginPt + (row * labelHeightPt);
                    
                    if (printBorders) {
                        doc.setDrawColor(0);
                        doc.setLineWidth(0.5);
                        doc.rect(x, y, labelWidthPt, labelHeightPt);
                    }
                    
                    if (isArtistLabels) {
                        const artist = record.artist || 'Unknown';
                        
                        doc.setFontSize(artistLabelFontSize);
                        doc.setFont('helvetica', 'bold');
                        
                        const textWidth = doc.getTextWidth(artist);
                        const textX = x + (labelWidthPt - textWidth) / 2;
                        const textY = y + (labelHeightPt / 2) + (artistLabelFontSize / 3);
                        
                        doc.text(artist, textX, textY);
                    } else {
                        const consignorId = record.consignor_id;
                        let consignorInitials = '';
                        if (consignorId) {
                            const consignorInfo = await getConsignorInfo(consignorId);
                            consignorInitials = consignorInfo.initials || '';
                        }
                        
                        const price = record.store_price || 0;
                        const priceText = `$${price.toFixed(2)}`;
                        doc.setFontSize(priceFontSize);
                        doc.setFont('helvetica', 'bold');
                        
                        const priceWidth = doc.getTextWidth(priceText);
                        const priceX = x + (labelWidthPt - priceWidth) / 2;
                        const priceY = y + (priceYPos * mmToPt);
                        
                        doc.text(priceText, priceX, priceY);
                        
                        const artist = record.artist || 'Unknown';
                        const genre = record.genre_name || record.genre || 'Unknown';
                        
                        const initialsText = consignorInitials ? ` | (${consignorInitials})` : '';
                        const maxInfoWidth = labelWidthPt - 10;
                        
                        let baseText = genre;
                        if (artist !== 'Unknown') {
                            baseText += ` | ${artist}`;
                        }
                        
                        doc.setFontSize(textFontSize);
                        doc.setFont('helvetica', 'normal');
                        const initialsWidth = initialsText ? doc.getTextWidth(initialsText) : 0;
                        const availableWidthForBase = maxInfoWidth - initialsWidth;
                        
                        let displayBaseText = baseText;
                        if (doc.getTextWidth(baseText) > availableWidthForBase) {
                            while (doc.getTextWidth(displayBaseText + '') > availableWidthForBase && displayBaseText.length > 0) {
                                displayBaseText = displayBaseText.slice(0, -1);
                            }
                            displayBaseText += '';
                        }
                        
                        let infoText = displayBaseText + initialsText;
                        
                        const infoWidth = doc.getTextWidth(infoText);
                        const infoX = x + (labelWidthPt - infoWidth) / 2;
                        const infoY = y + (infoYPos * mmToPt);
                        
                        doc.text(infoText, infoX, infoY);
                        
                        const barcodeNum = record.barcode;
                        if (barcodeNum) {
                            const canvas = document.createElement('canvas');
                            JsBarcode(canvas, barcodeNum, {
                                format: "CODE128",
                                displayValue: false,
                                height: 20,
                                margin: 0,
                                width: 2
                            });
                            
                            const barcodeData = canvas.toDataURL('image/png');
                            const barcodeX = x + (labelWidthPt - (25 * mmToPt)) / 2;
                            const barcodeY = y + (barcodeYPos * mmToPt);
                            
                            doc.addImage(barcodeData, 'PNG', barcodeX, barcodeY, 25 * mmToPt, barcodeHeightPt);
                        }
                    }
                    
                    currentLabel++;
                }
                
                const pdfBlob = doc.output('blob');
                resolve(pdfBlob);
            });
        }
        
        // ============= TERMINAL MANAGEMENT FUNCTIONS =============
        
        async function refreshTerminals() {
            const terminalList = document.getElementById('terminal-list');
            terminalList.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner" style="width: 30px; height: 30px;"></div><p>Loading terminals...</p></div>';
            
            const response = await fetch(`${AppConfig.baseUrl}/api/square/terminals`, {
                credentials: 'include'
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Terminal fetch error:', response.status, errorText);
                terminalList.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">
                    <i class="fas fa-exclamation-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                    <p>Error ${response.status}: ${response.statusText}</p>
                    <p style="font-size: 12px;">${errorText.substring(0, 100)}</p>
                </div>`;
                return;
            }
            
            const data = await response.json();
            if (data.status === 'success') {
                availableTerminals = data.terminals || [];
                renderTerminalList(availableTerminals);
            } else {
                terminalList.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">
                    <i class="fas fa-exclamation-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                    <p>Error: ${data.message || 'Unknown error'}</p>
                </div>`;
            }
        }

        function renderTerminalList(terminals) {
            const terminalList = document.getElementById('terminal-list');
            
            if (terminals.length === 0) {
                terminalList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <i class="fas fa-square" style="font-size: 24px; margin-bottom: 10px; color: #ccc;"></i>
                        <p>No Square Terminals found</p>
                        <small>Make sure your terminal is registered and online</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            terminals.forEach(terminal => {
                let displayId = terminal.id;
                let storeId = terminal.id;
                
                if (storeId && storeId.startsWith('device:')) {
                    storeId = storeId.replace('device:', '');
                }
                
                const isOnline = terminal.status === 'ONLINE';
                const isSelected = selectedTerminalId === storeId;
                
                html += `
                    <div class="terminal-item ${isSelected ? 'selected' : ''}" onclick="selectTerminal('${storeId}')">
                        <div class="terminal-icon">
                            <i class="fas fa-square"></i>
                        </div>
                        <div class="terminal-details">
                            <div class="terminal-name">${escapeHtml(terminal.device_name) || 'Square Terminal'}</div>
                            <div class="terminal-id">ID: ${escapeHtml(displayId)}</div>
                        </div>
                        <div class="terminal-status ${isOnline ? 'online' : 'offline'}">
                            ${isOnline ? 'Online' : 'Offline'}
                        </div>
                    </div>
                `;
            });
            
            terminalList.innerHTML = html;
            
            if (terminals.length === 1) {
                let singleTerminalId = terminals[0].id;
                if (singleTerminalId && singleTerminalId.startsWith('device:')) {
                    singleTerminalId = singleTerminalId.replace('device:', '');
                }
                selectedTerminalId = singleTerminalId;
            }
        }
        
        function selectTerminal(terminalId) {
            selectedTerminalId = terminalId;
            renderTerminalList(availableTerminals);
        }
        
        // ============= CHECK OUT FUNCTIONS =============
        
        async function searchRecordsAndAccessories() {
            const query = document.getElementById('search-query').value.trim();
            if (!query) {
                showCheckoutStatus('Please enter a search term', 'error');
                return;
            }
            
            const activeOnly = document.getElementById('filter-active').checked;
            const barcodeOnly = document.getElementById('filter-barcode').checked;
            
            showCheckoutLoading(true);
            
            try {
                let recordsUrl = `${AppConfig.baseUrl}/records/search?q=${encodeURIComponent(query)}`;
                const recordsResponse = await fetch(recordsUrl);
                const recordsData = await recordsResponse.json();
                
                const accessoriesUrl = `${AppConfig.baseUrl}/accessories`;
                const accessoriesResponse = await fetch(accessoriesUrl);
                const accessoriesData = await accessoriesResponse.json();
                
                let records = [];
                let accessories = [];
                
                if (recordsData.status === 'success') {
                    records = recordsData.records || [];
                }
                
                if (accessoriesData.status === 'success') {
                    const allAcc = accessoriesData.accessories || [];
                    
                    const queryLower = query.toLowerCase();
                    accessories = allAcc.filter(acc => {
                        if (acc.bar_code && acc.bar_code.toLowerCase().includes(queryLower)) {
                            return true;
                        }
                        if (acc.description && acc.description.toLowerCase().includes(queryLower)) {
                            return true;
                        }
                        return false;
                    });
                }
                
                if (activeOnly) {
                    records = records.filter(r => r.status_id === 2);
                }
                
                if (barcodeOnly) {
                    records = records.filter(r => r.barcode && r.barcode.toLowerCase().includes(query.toLowerCase()));
                    accessories = accessories.filter(acc => acc.bar_code && acc.bar_code.toLowerCase().includes(query.toLowerCase()));
                }
                
                const transformedAccessories = accessories.map(acc => ({
                    id: `acc_${acc.id}`,
                    original_id: acc.id,
                    type: 'accessory',
                    artist: null,
                    title: null,
                    description: acc.description,
                    store_price: acc.store_price,
                    catalog_number: null,
                    genre_name: 'Accessory',
                    barcode: acc.bar_code,
                    consignor_id: null,
                    status_id: 2,
                    count: acc.count,
                    created_at: acc.created_at
                }));
                
                currentSearchResults = [...records, ...transformedAccessories];
                
                currentSearchResults.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                renderSearchResults(currentSearchResults);
                
                showCheckoutStatus(`Found ${records.length} records and ${accessories.length} accessories`, 'success');
            } catch (error) {
                console.error('Error searching:', error);
                showCheckoutStatus('Error searching items', 'error');
            }
            
            showCheckoutLoading(false);
        }
        
        function renderSearchResults(results) {
            const container = document.getElementById('search-results');
            document.getElementById('search-result-count').textContent = results.length;
            document.getElementById('displayed-results').textContent = results.length;
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 20px; color: #ccc;"></i>
                        <p>No items found matching your search</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            results.forEach(item => {
                const inCart = checkoutCart.some(cartItem => {
                    if (item.type === 'accessory') {
                        return cartItem.type === 'accessory' && cartItem.original_id === item.original_id;
                    } else {
                        return cartItem.id === item.id;
                    }
                });
                
                if (item.type === 'accessory') {
                    const stockDisplay = item.count < 0 ? 
                        `<span class="stock-negative">(Stock: ${item.count})</span>` : 
                        `<span class="stock-positive">(Stock: ${item.count})</span>`;
                    
                    html += `
                        <div class="search-result-item" style="border-left: 4px solid #9b59b6;">
                            <div class="result-details">
                                <div class="result-artist">
                                    <span class="accessory-badge">ACCESSORY</span>
                                    ${escapeHtml(item.description) || 'Unknown Accessory'}
                                    <span class="stock-indicator ${item.count < 0 ? 'stock-negative' : 'stock-positive'}">${stockDisplay}</span>
                                </div>
                                <div class="result-meta">
                                    <span class="result-barcode"><i class="fas fa-barcode"></i> ${escapeHtml(item.barcode)}</span>
                                </div>
                            </div>
                            <div class="result-price">$${(item.store_price || 0).toFixed(2)}</div>
                            <div class="result-actions">
                                ${inCart ? 
                                    `<button class="btn btn-secondary btn-sm" onclick="removeAccessoryFromCart(${item.original_id})">
                                        <i class="fas fa-minus"></i> Remove
                                    </button>` :
                                    `<button class="btn btn-cart btn-sm" onclick="addAccessoryToCart(${item.original_id}, '${escapeHtml(item.description)}', ${item.store_price})">
                                        <i class="fas fa-cart-plus"></i> Add to Cart
                                    </button>`
                                }
                            </div>
                        </div>
                    `;
                } else {
                    const consignorInfo = consignorCache[item.consignor_id] || { username: 'None', initials: '' };
                    
                    html += `
                        <div class="search-result-item">
                            <div class="result-details">
                                <div class="result-artist">${escapeHtml(item.artist) || 'Unknown Artist'}</div>
                                <div class="result-title">${escapeHtml(item.title) || 'Unknown Title'}</div>
                                <div class="result-meta">
                                    <span class="result-catalog">${escapeHtml(item.catalog_number) || 'No catalog'}</span>
                                    ${item.barcode ? `<span class="result-barcode"><i class="fas fa-barcode"></i> ${escapeHtml(item.barcode)}</span>` : ''}
                                    <span>Status: ${getStatusText(item.status_id)}</span>
                                    ${item.consignor_id ? `<span><i class="fas fa-user"></i> ${escapeHtml(consignorInfo.username)}</span>` : ''}
                                </div>
                            </div>
                            <div class="result-price">$${(item.store_price || 0).toFixed(2)}</div>
                            <div class="result-actions">
                                ${item.status_id === 3 ? 
                                    '<span class="sold-badge"><i class="fas fa-check-circle"></i> Sold</span>' : 
                                    item.status_id === 2 ?
                                    (inCart ? 
                                        `<button class="btn btn-secondary btn-sm" onclick="removeFromCart(${item.id})">
                                            <i class="fas fa-minus"></i> Remove
                                        </button>` :
                                        `<button class="btn btn-cart btn-sm" onclick="addToCartFromData(${item.id})">
                                            <i class="fas fa-cart-plus"></i> Add to Cart
                                        </button>`
                                    ) :
                                    '<span class="inactive-badge">Not Active</span>'
                                }
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
            
            updateCartDisplay();
        }
        
        function addAccessoryToCart(id, description, price) {
            if (checkoutCart.some(item => item.type === 'accessory' && item.original_id === id)) {
                showCheckoutStatus('Item already in cart', 'info');
                return;
            }
            
            const cartItem = {
                id: `acc_${id}`,
                original_id: id,
                type: 'accessory',
                description: description,
                store_price: price,
                barcode: allAccessories.find(a => a.id === id)?.bar_code || ''
            };
            
            checkoutCart.push(cartItem);
            
            updateCartDisplay();
            searchRecordsAndAccessories();
            showCheckoutStatus(`Added "${description}" to cart`, 'success');
        }
        
        function removeAccessoryFromCart(originalId) {
            const index = checkoutCart.findIndex(item => item.type === 'accessory' && item.original_id === originalId);
            if (index !== -1) {
                const removed = checkoutCart.splice(index, 1)[0];
                updateCartDisplay();
                searchRecordsAndAccessories();
                showCheckoutStatus(`Removed "${removed.description}" from cart`, 'info');
            }
        }
        
        function addToCartFromData(recordId) {
            const record = currentSearchResults.find(r => r.id === recordId) || 
                          allRecords.find(r => r.id === recordId);
            if (record && record.type !== 'accessory') {
                addToCart(record);
            }
        }
        
        function addToCart(record) {
            if (checkoutCart.some(item => item.id === record.id)) {
                showCheckoutStatus('Item already in cart', 'info');
                return;
            }
            
            checkoutCart.push(record);
            
            updateCartDisplay();
            searchRecordsAndAccessories();
            showCheckoutStatus(`Added "${record.title}" to cart`, 'success');
        }
        
        function removeFromCart(recordId) {
            const recordIndex = checkoutCart.findIndex(item => item.id === recordId);
            if (recordIndex !== -1) {
                const removed = checkoutCart.splice(recordIndex, 1)[0];
                updateCartDisplay();
                searchRecordsAndAccessories();
                showCheckoutStatus(`Removed "${removed.title}" from cart`, 'info');
            }
        }
        
        function clearCart() {
            if (checkoutCart.length === 0) return;
            
            if (confirm('Are you sure you want to clear the cart?')) {
                checkoutCart = [];
                updateCartDisplay();
                searchRecordsAndAccessories();
                showCheckoutStatus('Cart cleared', 'info');
            }
        }
        
        function updateCartDisplay() {
            const cartSection = document.getElementById('shopping-cart-section');
            const cartItems = document.getElementById('cart-items');
            const cartCount = document.getElementById('cart-item-count');
            const cartSubtotal = document.getElementById('cart-subtotal');
            const cartTax = document.getElementById('cart-tax');
            const cartTotal = document.getElementById('cart-total');
            const squareBtn = document.getElementById('checkout-square-btn');
            
            if (checkoutCart.length === 0) {
                cartSection.style.display = 'none';
                squareBtn.disabled = true;
                return;
            }
            
            cartSection.style.display = 'block';
            cartCount.textContent = `${checkoutCart.length} item${checkoutCart.length !== 1 ? 's' : ''}`;
            
            let subtotal = 0;
            checkoutCart.forEach(item => {
                const price = parseFloat(item.store_price);
                subtotal += price;
            });
            
            let taxRate = 0;
            try {
                taxRate = getConfigValue('TAX_ENABLED') ? (parseFloat(getConfigValue('TAX_RATE')) / 100) : 0;
            } catch (e) {
                console.log('Tax config not found, using 0');
            }
            
            const tax = subtotal * taxRate;
            const total = subtotal + tax;
            
            cartSubtotal.textContent = `$${subtotal.toFixed(2)}`;
            cartTax.textContent = `$${tax.toFixed(2)}`;
            cartTotal.textContent = `$${total.toFixed(2)}`;
            
            squareBtn.disabled = availableTerminals.length === 0;
            
            let cartHtml = '';
            checkoutCart.forEach(item => {
                if (item.type === 'accessory') {
                    cartHtml += `
                        <div class="cart-item" style="border-left: 4px solid #9b59b6;">
                            <div class="cart-item-details">
                                <div class="cart-item-artist">
                                    <span class="accessory-badge">ACC</span>
                                    ${escapeHtml(item.description) || 'Unknown Accessory'}
                                </div>
                                <div class="cart-item-meta">${escapeHtml(item.barcode) || 'No barcode'}</div>
                            </div>
                            <div class="cart-item-price">$${(item.store_price || 0).toFixed(2)}</div>
                            <div class="cart-item-remove" onclick="removeAccessoryFromCart(${item.original_id})">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    `;
                } else {
                    const price = parseFloat(item.store_price) || 0;
                    cartHtml += `
                        <div class="cart-item">
                            <div class="cart-item-details">
                                <div class="cart-item-artist">${escapeHtml(item.artist) || 'Unknown Artist'}</div>
                                <div class="cart-item-title">${escapeHtml(item.title) || 'Unknown Title'}</div>
                                <div class="cart-item-meta">${escapeHtml(item.catalog_number) || 'No catalog'}</div>
                            </div>
                            <div class="cart-item-price">$${price.toFixed(2)}</div>
                            <div class="cart-item-remove" onclick="removeFromCart(${item.id})">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    `;
                }
            });
            
            cartItems.innerHTML = cartHtml;
        }
        
        // ============= SQUARE PAYMENT FUNCTIONS =============
        
        function processSquarePayment() {
            if (checkoutCart.length === 0) {
                showCheckoutStatus('Cart is empty', 'error');
                return;
            }
            
            if (availableTerminals.length === 0) {
                showCheckoutStatus('No Square Terminals available. Please refresh terminals.', 'error');
                return;
            }
            
            const onlineTerminals = availableTerminals.filter(t => t.status === 'ONLINE');
            if (onlineTerminals.length === 0) {
                showCheckoutStatus('No online terminals available. Please check terminal connection.', 'error');
                return;
            }
            
            pendingCartCheckout = {
                items: [...checkoutCart],
                type: 'cart'
            };
            
            renderTerminalSelectionModal();
        }
        
        function renderTerminalSelectionModal() {
            const onlineTerminals = availableTerminals.filter(t => t.status === 'ONLINE');
            
            const selectionList = document.getElementById('terminal-selection-list');
            let html = '<h4>Select Terminal</h4>';
            
            onlineTerminals.forEach(terminal => {
                let terminalId = terminal.id;
                if (terminalId && terminalId.startsWith('device:')) {
                    terminalId = terminalId.replace('device:', '');
                }
                
                html += `
                    <div class="terminal-device" onclick="selectTerminalForCheckout('${terminalId}')">
                        <input type="radio" name="terminal" value="${terminalId}" ${selectedTerminalId === terminalId ? 'checked' : ''}>
                        <div class="terminal-device-info">
                            <div class="terminal-device-name">${escapeHtml(terminal.device_name) || 'Square Terminal'}</div>
                            <div class="terminal-device-status online">Online</div>
                        </div>
                    </div>
                `;
            });
            
            selectionList.innerHTML = html;
            
            if (selectedTerminalId && onlineTerminals.some(t => {
                let tid = t.id;
                if (tid && tid.startsWith('device:')) {
                    tid = tid.replace('device:', '');
                }
                return tid === selectedTerminalId;
            })) {
                document.getElementById('confirm-terminal-btn').disabled = false;
            } else {
                document.getElementById('confirm-terminal-btn').disabled = true;
            }
            
            document.getElementById('terminal-selection-modal').style.display = 'flex';
        }
        
        function selectTerminalForCheckout(terminalId) {
            selectedTerminalId = terminalId;
            
            document.querySelectorAll('input[name="terminal"]').forEach(radio => {
                radio.checked = radio.value === terminalId;
            });
            
            document.getElementById('confirm-terminal-btn').disabled = false;
        }
        
        function closeTerminalSelectionModal() {
            document.getElementById('terminal-selection-modal').style.display = 'none';
        }
        
        async function initiateCartTerminalCheckout() {
            if (!pendingCartCheckout) {
                showCheckoutStatus('No items selected for checkout', 'error');
                closeTerminalSelectionModal();
                return;
            }
            
            if (!selectedTerminalId) {
                showCheckoutStatus('Please select a terminal', 'error');
                return;
            }
            
            const total = parseFloat(document.getElementById('cart-total').textContent.replace('$', ''));
            const amountCents = Math.round(total * 100);
            const recordIds = pendingCartCheckout.items.map(item => 
                item.type === 'accessory' ? `acc_${item.original_id}` : item.id
            );
            const recordTitles = pendingCartCheckout.items.map(item => 
                item.type === 'accessory' ? item.description : item.title
            );
            
            closeTerminalSelectionModal();
            
            const modalBody = document.getElementById('terminal-checkout-body');
            modalBody.innerHTML = `
                <div class="payment-status">
                    <div class="payment-status-icon processing">
                        <i class="fas fa-spinner fa-pulse"></i>
                    </div>
                    <div class="payment-status-message">Creating Terminal Checkout...</div>
                    <div class="payment-status-detail">Amount: $${total.toFixed(2)}</div>
                    <div class="payment-status-detail">Please wait while we prepare the terminal</div>
                    <div class="payment-progress">
                        <div class="payment-progress-bar" style="animation: progress 30s linear;"></div>
                    </div>
                </div>
            `;
            document.getElementById('terminal-checkout-modal').style.display = 'flex';
            
            try {
                const requestBody = {
                    amount_cents: amountCents,
                    record_ids: recordIds,
                    record_titles: recordTitles,
                    device_id: selectedTerminalId
                };
                
                console.log('Sending checkout request:', requestBody);
                
                const response = await fetch(`${AppConfig.baseUrl}/api/square/terminal/checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(requestBody)
                });
                
                const responseText = await response.text();
                console.log('Response status:', response.status);
                console.log('Response body:', responseText);
                
                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.message || errorData.error || errorMessage;
                    } catch (e) {
                        if (responseText) errorMessage = responseText;
                    }
                    throw new Error(errorMessage);
                }
                
                const data = JSON.parse(responseText);
                
                if (data.status === 'success') {
                    const checkout = data.checkout;
                    activeCheckoutId = checkout.id;
                    
                    modalBody.innerHTML = `
                        <div class="payment-status">
                            <div class="payment-status-icon processing">
                                <i class="fas fa-credit-card fa-pulse"></i>
                            </div>
                            <div class="payment-status-message">Waiting for payment on terminal</div>
                            <div class="payment-status-detail">Amount: $${total.toFixed(2)}</div>
                            <div class="payment-status-detail">Please present card to the terminal</div>
                            <div class="payment-progress">
                                <div class="payment-progress-bar" style="animation: progress 30s linear;"></div>
                            </div>
                            <button class="btn btn-warning" onclick="cancelTerminalCheckout()" style="margin-top: 20px;">
                                <i class="fas fa-times"></i> Cancel Payment
                            </button>
                        </div>
                    `;
                    
                    startCartCheckoutPolling(checkout.id);
                    
                } else {
                    throw new Error(data.message || 'Failed to create checkout');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                
                modalBody.innerHTML = `
                    <div class="payment-status">
                        <div class="payment-status-icon error">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="payment-status-message">Checkout Failed</div>
                        <div class="payment-status-detail">${error.message}</div>
                        <button class="btn btn-primary" onclick="closeTerminalCheckoutModal()" style="margin-top: 20px;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                `;
                
                showCheckoutStatus(`Checkout failed: ${error.message}`, 'error');
            }
        }
        
        function startCartCheckoutPolling(checkoutId) {
            if (checkoutPollInterval) {
                clearInterval(checkoutPollInterval);
            }
            
            let pollCount = 0;
            const maxPolls = 60;
            
            checkoutPollInterval = setInterval(async () => {
                pollCount++;
                
                try {
                    const response = await fetch(`${AppConfig.baseUrl}/api/square/terminal/checkout/${checkoutId}/status`, {
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    if (!response.ok) {
                        console.error(`Status check failed: ${response.status}`);
                        return;
                    }
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        const checkout = data.checkout;
                        const checkoutStatus = checkout.status;
                        
                        if (checkoutStatus === 'COMPLETED') {
                            clearInterval(checkoutPollInterval);
                            
                            await processSquarePaymentSuccess();
                            
                            const modalBody = document.getElementById('terminal-checkout-body');
                            modalBody.innerHTML = `
                                <div class="payment-status">
                                    <div class="payment-status-icon success">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="payment-status-message">Payment Successful!</div>
                                    <div class="payment-status-detail">Amount: $${(checkout.amount_money.amount / 100).toFixed(2)}</div>
                                    <div class="payment-status-detail">Thank you for your purchase</div>
                                    <button class="btn btn-success" onclick="closeTerminalCheckoutModal()" style="margin-top: 20px;">
                                        <i class="fas fa-check"></i> Done
                                    </button>
                                </div>
                            `;
                            
                            showCheckoutStatus('Payment completed successfully!', 'success');
                            
                        } else if (checkoutStatus === 'CANCELED' || checkoutStatus === 'FAILED') {
                            clearInterval(checkoutPollInterval);
                            
                            const modalBody = document.getElementById('terminal-checkout-body');
                            modalBody.innerHTML = `
                                <div class="payment-status">
                                    <div class="payment-status-icon error">
                                        <i class="fas fa-times-circle"></i>
                                    </div>
                                    <div class="payment-status-message">Payment ${checkoutStatus}</div>
                                    <div class="payment-status-detail">The transaction was ${checkoutStatus.toLowerCase()}</div>
                                    <button class="btn btn-primary" onclick="closeTerminalCheckoutModal()" style="margin-top: 20px;">
                                        <i class="fas fa-times"></i> Close
                                    </button>
                                </div>
                            `;
                            
                            showCheckoutStatus(`Payment ${checkoutStatus.toLowerCase()}`, 'error');
                        }
                    }
                    
                    if (pollCount >= maxPolls) {
                        clearInterval(checkoutPollInterval);
                        
                        const modalBody = document.getElementById('terminal-checkout-body');
                        modalBody.innerHTML = `
                            <div class="payment-status">
                                <div class="payment-status-icon error">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="payment-status-message">Checkout Timed Out</div>
                                <div class="payment-status-detail">The terminal did not respond in time</div>
                                <button class="btn btn-primary" onclick="closeTerminalCheckoutModal()" style="margin-top: 20px;">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 5000);
        }
        
        async function processSquarePaymentSuccess() {
            showCheckoutLoading(true);
            
            let successCount = 0;
            let errorCount = 0;
            const soldItems = [];
            const consignorPayments = {};
            
            for (const item of pendingCartCheckout.items) {
                if (item.type === 'accessory') {
                    try {
                        const getResponse = await fetch(`${AppConfig.baseUrl}/accessories/${item.original_id}`);
                        const getData = await getResponse.json();
                        
                        if (getData.status === 'success') {
                            const accessory = getData.accessory;
                            const newCount = accessory.count - 1;
                            
                            const updateResponse = await fetch(`${AppConfig.baseUrl}/accessories/${item.original_id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    count: newCount
                                })
                            });
                            
                            if (updateResponse.ok) {
                                const updateData = await updateResponse.json();
                                if (updateData.status === 'success') {
                                    successCount++;
                                    soldItems.push({
                                        ...item,
                                        description: accessory.description,
                                        store_price: accessory.store_price
                                    });
                                } else {
                                    errorCount++;
                                }
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error(`Error updating accessory ${item.original_id}:`, error);
                        errorCount++;
                    }
                } else {
                    try {
                        const response = await fetch(`${AppConfig.baseUrl}/records/${item.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                status_id: 3
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.status === 'success') {
                                successCount++;
                                soldItems.push(item);
                                
                                if (item.consignor_id) {
                                    const commissionRate = item.commission_rate || 10;
                                    const consignorShare = item.store_price * (1 - (commissionRate / 100));
                                    
                                    if (!consignorPayments[item.consignor_id]) {
                                        consignorPayments[item.consignor_id] = 0;
                                    }
                                    consignorPayments[item.consignor_id] += consignorShare;
                                }
                                
                                const recordIndex = allRecords.findIndex(r => r.id === item.id);
                                if (recordIndex !== -1) {
                                    allRecords[recordIndex].status_id = 3;
                                }
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error(`Error updating record ${item.id}:`, error);
                        errorCount++;
                    }
                }
            }
            
            if (Object.keys(consignorPayments).length > 0) {
                let storedOwed = JSON.parse(localStorage.getItem('consignor_owed') || '{}');
                for (const [consignorId, amount] of Object.entries(consignorPayments)) {
                    storedOwed[consignorId] = (storedOwed[consignorId] || 0) + amount;
                }
                localStorage.setItem('consignor_owed', JSON.stringify(storedOwed));
                consignorOwedAmounts = storedOwed;
            }
            
            if (successCount > 0) {
                let cashierName = 'Admin';
                try {
                    const userData = localStorage.getItem('user');
                    if (userData) {
                        const user = JSON.parse(userData);
                        cashierName = user.username || 'Admin';
                    }
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
                
                const subtotal = pendingCartCheckout.items.reduce((sum, item) => sum + (parseFloat(item.store_price) || 0), 0);
                let taxRate = 0;
                try {
                    taxRate = getConfigValue('TAX_ENABLED') ? (getConfigValue('TAX_RATE') / 100) : 0;
                } catch (e) {
                    console.log('Tax config not found, using 0');
                }
                const tax = subtotal * taxRate;
                const total = subtotal + tax;
                
                const transaction = {
                    id: `SQUARE-${Date.now()}`,
                    date: new Date(),
                    items: [...soldItems],
                    subtotal: subtotal,
                    tax: tax,
                    taxRate: taxRate * 100,
                    total: total,
                    paymentMethod: 'Square Terminal',
                    cashier: cashierName,
                    storeName: dbConfigValues['STORE_NAME'] ? dbConfigValues['STORE_NAME'].value : 'PigStyle Music',
                    storeAddress: dbConfigValues['STORE_ADDRESS'] ? dbConfigValues['STORE_ADDRESS'].value : '',
                    storePhone: dbConfigValues['STORE_PHONE'] ? dbConfigValues['STORE_PHONE'].value : '',
                    footer: dbConfigValues['RECEIPT_FOOTER'] ? dbConfigValues['RECEIPT_FOOTER'].value : 'Thank you for your purchase!',
                    consignorPayments: consignorPayments
                };
                
                saveReceipt(transaction);
                
                // Print receipt to thermal printer
                const receiptText = formatReceiptForPrinter(transaction);
                printToThermalPrinter(receiptText);
                
                checkoutCart = [];
                updateCartDisplay();
                searchRecordsAndAccessories();
                
                showCheckoutStatus(`Successfully sold ${successCount} items${errorCount > 0 ? ` (${errorCount} failed)` : ''}`, 'success');
            } else {
                showCheckoutStatus(`Failed to process sale: ${errorCount} errors`, 'error');
            }
            
            showCheckoutLoading(false);
            pendingCartCheckout = null;
        }
        
        async function cancelTerminalCheckout() {
            if (!activeCheckoutId) {
                showCheckoutStatus('No active checkout to cancel', 'info');
                return;
            }
            
            const modalBody = document.getElementById('terminal-checkout-body');
            modalBody.innerHTML = `
                <div class="payment-status">
                    <div class="payment-status-icon processing">
                        <i class="fas fa-spinner fa-pulse"></i>
                    </div>
                    <div class="payment-status-message">Cancelling checkout...</div>
                </div>
            `;
            
            try {
                console.log('Original checkout ID:', activeCheckoutId);
                
                const checkoutIdToUse = `termapia:${activeCheckoutId}`;
                console.log('Using checkout ID with prefix:', checkoutIdToUse);
                
                const encodedId = encodeURIComponent(checkoutIdToUse);
                const url = `${AppConfig.baseUrl}/api/square/terminal/checkout/${encodedId}/cancel`;
                console.log('Sending cancel request to:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });
                
                console.log('Cancel response status:', response.status);
                
                const responseText = await response.text();
                console.log('Cancel response body:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    data = { message: responseText };
                }
                
                if (response.ok) {
                    if (data.status === 'success') {
                        showCheckoutStatus('Checkout cancelled successfully', 'success');
                        
                        modalBody.innerHTML = `
                            <div class="payment-status">
                                <div class="payment-status-icon success">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="payment-status-message">Checkout Cancelled Successfully</div>
                                <button class="btn btn-primary" onclick="closeTerminalCheckoutModal()" style="margin-top: 20px;">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        `;
                        
                        if (checkoutPollInterval) {
                            clearInterval(checkoutPollInterval);
                            checkoutPollInterval = null;
                        }
                        activeCheckoutId = null;
                    } else {
                        throw new Error(data.message || 'Failed to cancel checkout');
                    }
                } else {
                    let errorMessage = `Error ${response.status}: ${response.statusText}`;
                    if (data.message) {
                        errorMessage = data.message;
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('Cancel checkout error:', error);
                
                modalBody.innerHTML = `
                    <div class="payment-status">
                        <div class="payment-status-icon error">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="payment-status-message">Failed to Cancel Checkout</div>
                        <div class="payment-status-detail">${error.message}</div>
                        <div class="payment-status-detail" style="font-size: 12px; margin-top: 10px;">
                            Checkout ID: ${escapeHtml(activeCheckoutId)}
                        </div>
                        <button class="btn btn-primary" onclick="closeTerminalCheckoutModal()" style="margin-top: 20px;">
                            <i class="fas fa-times"></i> Close
                        </button>
                        <button class="btn btn-secondary" onclick="cancelTerminalCheckout()" style="margin-top: 10px;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
                
                showCheckoutStatus(`Failed to cancel: ${error.message}`, 'error');
            }
        }
        
        function closeTerminalCheckoutModal() {
            document.getElementById('terminal-checkout-modal').style.display = 'none';
            if (checkoutPollInterval) {
                clearInterval(checkoutPollInterval);
                checkoutPollInterval = null;
            }
            activeCheckoutId = null;
        }
        
        // ============= CASH PAYMENT FUNCTIONS =============
        
        function showTenderModal() {
            if (checkoutCart.length === 0) {
                showCheckoutStatus('Cart is empty', 'error');
                return;
            }
            
            const total = parseFloat(document.getElementById('cart-total').textContent.replace('$', ''));
            
            document.getElementById('tender-total-due').textContent = `$${total.toFixed(2)}`;
            document.getElementById('tender-amount').value = '';
            document.getElementById('change-display-container').style.display = 'none';
            document.getElementById('complete-payment-btn').disabled = true;
            
            document.getElementById('tender-modal').style.display = 'flex';
            document.getElementById('tender-amount').focus();
            
            document.getElementById('tender-amount').addEventListener('input', function(e) {
                const tendered = parseFloat(e.target.value) || 0;
                const total = parseFloat(document.getElementById('tender-total-due').textContent.replace('$', ''));
                
                if (tendered >= total) {
                    const change = tendered - total;
                    document.getElementById('change-amount').textContent = `$${change.toFixed(2)}`;
                    document.getElementById('change-display-container').style.display = 'block';
                    document.getElementById('complete-payment-btn').disabled = false;
                } else {
                    document.getElementById('change-display-container').style.display = 'none';
                    document.getElementById('complete-payment-btn').disabled = true;
                }
            });
        }
        
        function closeTenderModal() {
            document.getElementById('tender-modal').style.display = 'none';
        }
        
        async function processCashPayment() {
            const tendered = parseFloat(document.getElementById('tender-amount').value) || 0;
            const total = parseFloat(document.getElementById('cart-total').textContent.replace('$', ''));
            
            if (tendered < total) {
                showCheckoutStatus('Insufficient payment', 'error');
                return;
            }
            
            const change = tendered - total;
            
            closeTenderModal();
            showCheckoutLoading(true);
            
            let successCount = 0;
            let errorCount = 0;
            const soldItems = [];
            const consignorPayments = {};
            
            for (const item of checkoutCart) {
                if (item.type === 'accessory') {
                    try {
                        const getResponse = await fetch(`${AppConfig.baseUrl}/accessories/${item.original_id}`);
                        const getData = await getResponse.json();
                        
                        if (getData.status === 'success') {
                            const accessory = getData.accessory;
                            const newCount = accessory.count - 1;
                            
                            const updateResponse = await fetch(`${AppConfig.baseUrl}/accessories/${item.original_id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    count: newCount
                                })
                            });
                            
                            if (updateResponse.ok) {
                                const updateData = await updateResponse.json();
                                if (updateData.status === 'success') {
                                    successCount++;
                                    soldItems.push({
                                        ...item,
                                        description: accessory.description,
                                        store_price: accessory.store_price
                                    });
                                } else {
                                    errorCount++;
                                }
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error(`Error updating accessory ${item.original_id}:`, error);
                        errorCount++;
                    }
                } else {
                    try {
                        const response = await fetch(`${AppConfig.baseUrl}/records/${item.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                status_id: 3
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.status === 'success') {
                                successCount++;
                                soldItems.push(item);
                                
                                if (item.consignor_id) {
                                    const commissionRate = item.commission_rate || 10;
                                    const consignorShare = item.store_price * (1 - (commissionRate / 100));
                                    
                                    if (!consignorPayments[item.consignor_id]) {
                                        consignorPayments[item.consignor_id] = 0;
                                    }
                                    consignorPayments[item.consignor_id] += consignorShare;
                                }
                                
                                const recordIndex = allRecords.findIndex(r => r.id === item.id);
                                if (recordIndex !== -1) {
                                    allRecords[recordIndex].status_id = 3;
                                }
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error(`Error updating record ${item.id}:`, error);
                        errorCount++;
                    }
                }
            }
            
            if (Object.keys(consignorPayments).length > 0) {
                let storedOwed = JSON.parse(localStorage.getItem('consignor_owed') || '{}');
                for (const [consignorId, amount] of Object.entries(consignorPayments)) {
                    storedOwed[consignorId] = (storedOwed[consignorId] || 0) + amount;
                }
                localStorage.setItem('consignor_owed', JSON.stringify(storedOwed));
                consignorOwedAmounts = storedOwed;
            }
            
            if (successCount > 0) {
                let cashierName = 'Admin';
                try {
                    const userData = localStorage.getItem('user');
                    if (userData) {
                        const user = JSON.parse(userData);
                        cashierName = user.username || 'Admin';
                    }
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
                
                const subtotal = checkoutCart.reduce((sum, item) => sum + (parseFloat(item.store_price) || 0), 0);
                let taxRate = 0;
                try {
                    taxRate = getConfigValue('TAX_ENABLED') ? (getConfigValue('TAX_RATE') / 100) : 0;
                } catch (e) {
                    console.log('Tax config not found, using 0');
                }
                const tax = subtotal * taxRate;
                
                const transaction = {
                    id: `CASH-${Date.now()}`,
                    date: new Date(),
                    items: [...soldItems],
                    subtotal: subtotal,
                    tax: tax,
                    taxRate: taxRate * 100,
                    total: total,
                    tendered: tendered,
                    change: change,
                    paymentMethod: 'Cash',
                    cashier: cashierName,
                    storeName: dbConfigValues['STORE_NAME'] ? dbConfigValues['STORE_NAME'].value : 'PigStyle Music',
                    storeAddress: dbConfigValues['STORE_ADDRESS'] ? dbConfigValues['STORE_ADDRESS'].value : '',
                    storePhone: dbConfigValues['STORE_PHONE'] ? dbConfigValues['STORE_PHONE'].value : '',
                    footer: dbConfigValues['RECEIPT_FOOTER'] ? dbConfigValues['RECEIPT_FOOTER'].value : 'Thank you for your purchase!',
                    consignorPayments: consignorPayments
                };
                
                saveReceipt(transaction);
                // showReceipt(transaction);
                
                // Print receipt to thermal printer
                const receiptText = formatReceiptForPrinter(transaction);
                printToThermalPrinter(receiptText);
                
                checkoutCart = [];
                updateCartDisplay();
                searchRecordsAndAccessories();
                
                showCheckoutStatus(`Successfully sold ${successCount} items${errorCount > 0 ? ` (${errorCount} failed)` : ''}`, 'success');
            } else {
                showCheckoutStatus(`Failed to process sale: ${errorCount} errors`, 'error');
            }
            
            showCheckoutLoading(false);
        }
        
        // ========== CONSIGNOR MANAGEMENT FUNCTIONS ==========
        async function loadConsignors() {
            const tbody = document.getElementById('consignors-body');
            const loading = document.getElementById('consignors-loading');
            loading.style.display = 'block';
            
            const url = `${AppConfig.baseUrl}/users`;
            const response = await fetch(url);
            const data = await response.json();
            
            let users = data.users || [];
            
            let storedOwed = JSON.parse(localStorage.getItem('consignor_owed') || '{}');
            consignorOwedAmounts = storedOwed;
            
            let totalAdminCommission = 0;
            savedReceipts.forEach(receipt => {
                if (receipt.consignorPayments) {
                    receipt.items.forEach(item => {
                        if (item.consignor_id && item.type !== 'accessory') {
                            const commissionRate = item.commission_rate || 10;
                            totalAdminCommission += item.store_price * (commissionRate / 100);
                        }
                    });
                }
            });
            
            consignorsList = users.map(u => ({
                id: u.id,
                username: u.username || 'Unknown',
                initials: u.initials || (u.username ? u.username.substring(0,2).toUpperCase() : '??'),
                owed: storedOwed[u.id] || 0,
                recordsSold: allRecords.filter(r => r.consignor_id == u.id && r.status_id === 3).length
            }));
            
            renderConsignors(consignorsList);
            updateConsignorStats(totalAdminCommission);
            
            loading.style.display = 'none';
        }
        
        function renderConsignors(consignors) {
            const tbody = document.getElementById('consignors-body');
            if (!consignors.length) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No consignors found</td></tr>`;
                return;
            }
            let html = '';
            consignors.forEach(c => {
                html += `<tr>
                    <td>${c.id}</td>
                    <td>${escapeHtml(c.username)}</td>
                    <td>${escapeHtml(c.initials)}</td>
                    <td>$${c.owed.toFixed(2)}</td>
                    <td>${c.recordsSold}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="showPaymentModal('${c.id}', '${escapeHtml(c.username)}', ${c.owed})">
                            <i class="fas fa-dollar-sign"></i> Clear
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteConsignor('${c.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }
        
        function updateConsignorStats(totalAdminCommission) {
            document.getElementById('total-consignors').textContent = consignorsList.length;
            const totalOwed = consignorsList.reduce((acc, c) => acc + (c.owed || 0), 0);
            document.getElementById('total-credit').textContent = `$${totalOwed.toFixed(2)}`;
            document.getElementById('admin-total-commission').textContent = `$${totalAdminCommission.toFixed(2)}`;
        }
        
        let currentPaymentUserId = null;
        let currentPaymentAmount = 0;
        
        function showPaymentModal(userId, username, amount) {
            if (amount <= 0) {
                alert('This consignor has no owed amount to clear.');
                return;
            }
            currentPaymentUserId = userId;
            currentPaymentAmount = amount;
            document.getElementById('payment-consignor-name').textContent = username;
            document.getElementById('payment-amount').textContent = `$${amount.toFixed(2)}`;
            document.getElementById('payment-modal').style.display = 'flex';
        }
        
        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
            currentPaymentUserId = null;
            currentPaymentAmount = 0;
        }
        
        async function processPayment() {
            if (!currentPaymentUserId) return;
            
            let storedOwed = JSON.parse(localStorage.getItem('consignor_owed') || '{}');
            delete storedOwed[currentPaymentUserId];
            localStorage.setItem('consignor_owed', JSON.stringify(storedOwed));
            
            consignorOwedAmounts = storedOwed;
            const consignor = consignorsList.find(c => c.id == currentPaymentUserId);
            if (consignor) {
                consignor.owed = 0;
            }
            
            renderConsignors(consignorsList);
            
            let totalAdminCommission = 0;
            savedReceipts.forEach(receipt => {
                if (receipt.consignorPayments) {
                    receipt.items.forEach(item => {
                        if (item.consignor_id && item.type !== 'accessory') {
                            const commissionRate = item.commission_rate || 10;
                            totalAdminCommission += item.store_price * (commissionRate / 100);
                        }
                    });
                }
            });
            updateConsignorStats(totalAdminCommission);
            
            closePaymentModal();
            showStatus(`Payment cleared for ${consignor?.username}`, 'success');
        }
        
        async function deleteConsignor(userId) {
            if (!confirm('Are you sure you want to delete this consignor? This action cannot be undone.')) return;
            
            const hasRecords = allRecords.some(r => r.consignor_id == userId);
            if (hasRecords) {
                alert('Cannot delete consignor with existing records. Please reassign or delete records first.');
                return;
            }
            
            const loading = document.getElementById('consignors-loading');
            loading.style.display = 'block';
            
            consignorsList = consignorsList.filter(c => c.id != userId);
            renderConsignors(consignorsList);
            
            let storedOwed = JSON.parse(localStorage.getItem('consignor_owed') || '{}');
            delete storedOwed[userId];
            localStorage.setItem('consignor_owed', JSON.stringify(storedOwed));
            
            updateConsignorStats(0);
            showStatus('Consignor deleted', 'success');
            
            loading.style.display = 'none';
        }
        
        // ========== ARTISTS FUNCTIONS ==========
        async function loadArtists() {
            showArtistsLoading(true);
            
            try {
                const recordsUrl = `${AppConfig.baseUrl}/records`;
                const recordsResponse = await fetch(recordsUrl);
                const recordsData = await recordsResponse.json();
                
                if (recordsData.status === 'success') {
                    const records = recordsData.records || [];
                    
                    const artistMap = new Map();
                    
                    records.forEach(record => {
                        if (!record.artist) return;
                        
                        const artistName = record.artist.trim();
                        
                        if (!artistMap.has(artistName)) {
                            artistMap.set(artistName, {
                                name: artistName,
                                recordCount: 0
                            });
                        }
                        
                        const artistData = artistMap.get(artistName);
                        artistData.recordCount++;
                    });
                    
                    allArtists = Array.from(artistMap.values())
                        .sort((a, b) => b.recordCount - a.recordCount);
                    
                    filteredArtists = [...allArtists];
                    
                    artistsCurrentPage = 1;
                    
                    renderArtists();
                    
                    document.getElementById('total-artists-count').textContent = allArtists.length;
                }
            } catch (error) {
                console.error('Error loading artists:', error);
                const tbody = document.getElementById('artists-body');
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:#dc3545;">
                    <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 20px; display: block;"></i>
                    Error loading artists: ${error.message}
                </td></tr>`;
            }
            
            showArtistsLoading(false);
        }
        
        function filterArtists() {
            const searchTerm = document.getElementById('artist-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                filteredArtists = [...allArtists];
            } else {
                filteredArtists = allArtists.filter(artist => 
                    artist.name.toLowerCase().includes(searchTerm)
                );
            }
            
            artistsCurrentPage = 1;
            renderArtists();
        }
        
        function renderArtists() {
            const tbody = document.getElementById('artists-body');
            
            if (filteredArtists.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px;">
                    <i class="fas fa-music" style="font-size: 48px; margin-bottom: 20px; color: #ccc; display: block;"></i>
                    No artists found
                </td></tr>`;
                updateArtistsPagination();
                return;
            }
            
            const startIndex = (artistsCurrentPage - 1) * artistsPageSize;
            const endIndex = Math.min(startIndex + artistsPageSize, filteredArtists.length);
            const pageArtists = filteredArtists.slice(startIndex, endIndex);
            
            let html = '';
            pageArtists.forEach((artist, index) => {
                const globalIndex = startIndex + index + 1;
                const isSelected = selectedArtists.has(artist.name);
                
                html += `
                    <tr>
                        <td><input type="checkbox" class="artist-checkbox" data-artist="${escapeHtml(artist.name)}" ${isSelected ? 'checked' : ''}></td>
                        <td>${globalIndex}</td>
                        <td><strong>${escapeHtml(artist.name)}</strong></td>
                        <td style="text-align: center;"><span class="badge" style="background: #3498db; color: white; padding: 3px 8px; border-radius: 12px;">${artist.recordCount}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="searchArtistRecords('${escapeHtml(artist.name)}')">
                                <i class="fas fa-search"></i> View Records
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            document.querySelectorAll('.artist-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const artistName = this.getAttribute('data-artist');
                    if (this.checked) {
                        selectedArtists.add(artistName);
                    } else {
                        selectedArtists.delete(artistName);
                    }
                    updateArtistButtonStates();
                });
            });
            
            const selectAllCheckbox = document.getElementById('select-all-artists');
            selectAllCheckbox.checked = false;
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.artist-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    const artistName = checkbox.getAttribute('data-artist');
                    if (this.checked) {
                        selectedArtists.add(artistName);
                    } else {
                        selectedArtists.delete(artistName);
                    }
                });
                updateArtistButtonStates();
            });
            
            updateArtistsPagination();
        }
        
        function updateArtistsPagination() {
            artistsTotalPages = Math.ceil(filteredArtists.length / artistsPageSize);
            if (artistsTotalPages === 0) artistsTotalPages = 1;
            
            document.getElementById('artists-current-page').textContent = artistsCurrentPage;
            document.getElementById('artists-total-pages').textContent = artistsTotalPages;
            
            document.getElementById('artists-first-btn').disabled = artistsCurrentPage === 1;
            document.getElementById('artists-prev-btn').disabled = artistsCurrentPage === 1;
            document.getElementById('artists-next-btn').disabled = artistsCurrentPage === artistsTotalPages;
            document.getElementById('artists-last-btn').disabled = artistsCurrentPage === artistsTotalPages;
            
            updateArtistButtonStates();
        }
        
        function updateArtistButtonStates() {
            const hasSelection = selectedArtists.size > 0;
            document.getElementById('print-artists-btn').disabled = !hasSelection;
        }
        
        function goToArtistsPage(direction) {
            if (direction === 'first') {
                artistsCurrentPage = 1;
            } else if (direction === 'prev') {
                artistsCurrentPage = Math.max(1, artistsCurrentPage - 1);
            } else if (direction === 'next') {
                artistsCurrentPage = Math.min(artistsTotalPages, artistsCurrentPage + 1);
            } else if (direction === 'last') {
                artistsCurrentPage = artistsTotalPages;
            }
            
            renderArtists();
        }
        
        function changeArtistsPageSize(newSize) {
            artistsPageSize = newSize;
            artistsCurrentPage = 1;
            renderArtists();
        }
        
        function selectTopArtists() {
            const batchSize = parseInt(document.getElementById('artist-batch-size').value) || 10;
            
            selectedArtists.clear();
            
            const topArtists = allArtists.slice(0, batchSize);
            
            topArtists.forEach(artist => {
                selectedArtists.add(artist.name);
            });
            
            renderArtists();
            
            if (topArtists.length > 0) {
                showStatus(`Selected top ${topArtists.length} artists by record count`, 'success');
            } else {
                showStatus('No artists available to select', 'info');
            }
        }
        
        function selectAllArtistsOnPage() {
            const startIndex = (artistsCurrentPage - 1) * artistsPageSize;
            const endIndex = Math.min(startIndex + artistsPageSize, filteredArtists.length);
            const pageArtists = filteredArtists.slice(startIndex, endIndex);
            
            pageArtists.forEach(artist => {
                selectedArtists.add(artist.name);
            });
            
            renderArtists();
            
            showStatus(`Selected all ${pageArtists.length} artists on this page`, 'success');
        }
        
        function clearArtistSelection() {
            selectedArtists.clear();
            renderArtists();
            showStatus('Artist selection cleared', 'info');
        }
        
        function searchArtistRecords(artistName) {
            switchTab('check-out');
            
            const searchInput = document.getElementById('search-query');
            searchInput.value = artistName;
            
            document.getElementById('filter-barcode').checked = false;
            
            searchRecordsAndAccessories();
        }
        
        function showPrintArtistsConfirmation() {
            if (selectedArtists.size === 0) {
                showStatus('No artists selected for printing', 'error');
                return;
            }
            
            const selectedArtistsList = allArtists.filter(artist => selectedArtists.has(artist.name));
            
            document.getElementById('print-artists-count').textContent = selectedArtistsList.length;
            
            const summaryList = document.getElementById('print-artists-summary-list');
            let summaryHtml = '';
            selectedArtistsList.slice(0, 10).forEach(artist => {
                summaryHtml += `<li>${escapeHtml(artist.name)} (${artist.recordCount} records)</li>`;
            });
            if (selectedArtistsList.length > 10) {
                summaryHtml += `<li>...and ${selectedArtistsList.length - 10} more</li>`;
            }
            summaryList.innerHTML = summaryHtml;
            
            document.getElementById('print-artists-confirmation-modal').style.display = 'flex';
        }
        
        function closePrintArtistsConfirmation() {
            document.getElementById('print-artists-confirmation-modal').style.display = 'none';
        }
        
        async function confirmPrintArtists() {
            closePrintArtistsConfirmation();
            showLoading(true);
            
            const selectedArtistsList = allArtists.filter(artist => selectedArtists.has(artist.name));
            
            if (selectedArtistsList.length === 0) {
                showStatus('No artists selected', 'error');
                showLoading(false);
                return;
            }
            
            await fetchAllConfigValues();
            
            const dummyRecords = selectedArtistsList.map(artist => ({
                artist: artist.name,
                title: 'ARTIST LABEL',
                store_price: 0,
                genre_name: 'Artist',
                barcode: null,
                consignor_id: null
            }));
            
            const pdfBlob = await generatePDF(dummyRecords);
            
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `artist_labels_${new Date().toISOString().slice(0, 10)}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus(`PDF generated for ${selectedArtistsList.length} artists`, 'success');
            showLoading(false);
        }
        
        // ========== GENRE MISMATCH FUNCTIONS ==========
        async function loadGenreMismatches() {
            showGenresLoading(true);
            
            try {
                const artistGenreUrl = `${AppConfig.baseUrl}/artist-genre`;
                const artistGenreResponse = await fetch(artistGenreUrl);
                
                if (!artistGenreResponse.ok) {
                    throw new Error(`Failed to fetch artist-genre data: ${artistGenreResponse.status}`);
                }
                
                const artistGenres = await artistGenreResponse.json();
                
                const recordsUrl = `${AppConfig.baseUrl}/records`;
                const recordsResponse = await fetch(recordsUrl);
                const recordsData = await recordsResponse.json();
                
                const genresUrl = `${AppConfig.baseUrl}/genres`;
                const genresResponse = await fetch(genresUrl);
                const genresData = await genresResponse.json();
                
                window.allGenres = [];
                if (genresData.status === 'success') {
                    window.allGenres = genresData.genres || [];
                }
                
                if (recordsData.status === 'success') {
                    const records = recordsData.records || [];
                    
                    const expectedGenreMap = new Map();
                    const artistGenreIdMap = new Map();
                    
                    if (Array.isArray(artistGenres)) {
                        artistGenres.forEach(item => {
                            const artist = item.artist;
                            const genre = item.genre_name;
                            const genreId = item.genre_id;
                            
                            if (artist && genre && !expectedGenreMap.has(artist)) {
                                expectedGenreMap.set(artist, genre);
                                artistGenreIdMap.set(artist, genreId);
                            }
                        });
                    }
                    
                    const mismatchMap = new Map();
                    
                    records.forEach(record => {
                        if (!record.artist) return;
                        
                        const artist = record.artist.trim();
                        const recordGenre = record.genre_name || record.genre || 'Unknown';
                        
                        if (expectedGenreMap.has(artist)) {
                            const expectedGenre = expectedGenreMap.get(artist);
                            const genreId = artistGenreIdMap.get(artist);
                            
                            if (recordGenre !== expectedGenre) {
                                if (!mismatchMap.has(artist)) {
                                    mismatchMap.set(artist, {
                                        artist: artist,
                                        expectedGenre: expectedGenre,
                                        genreId: genreId,
                                        mismatchedRecords: []
                                    });
                                }
                                
                                mismatchMap.get(artist).mismatchedRecords.push({
                                    title: record.title || 'Unknown',
                                    genre: recordGenre,
                                    catalog: record.catalog_number || 'N/A'
                                });
                            }
                        }
                    });
                    
                    allMismatches = Array.from(mismatchMap.values())
                        .filter(m => m.mismatchedRecords.length > 0)
                        .sort((a, b) => b.mismatchedRecords.length - a.mismatchedRecords.length);
                    
                    filteredMismatches = [...allMismatches];
                    
                    document.getElementById('total-mismatch-artists').textContent = allMismatches.length;
                    const totalMismatchRecords = allMismatches.reduce((sum, m) => sum + m.mismatchedRecords.length, 0);
                    document.getElementById('total-mismatch-records').textContent = totalMismatchRecords;
                    
                    populateGenreFilterFromMismatches();
                    
                    mismatchesCurrentPage = 1;
                    
                    renderMismatches();
                } else {
                    throw new Error('Failed to fetch records');
                }
            } catch (error) {
                console.error('Error loading genre mismatches:', error);
                const tbody = document.getElementById('genre-mismatches-body');
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:#dc3545;">
                    <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 20px; display: block;"></i>
                    Error loading genre mismatches: ${error.message}
                </td></tr>`;
            }
            
            showGenresLoading(false);
        }
        
        function populateGenreFilterFromMismatches() {
            const genreSet = new Set();
            allMismatches.forEach(m => {
                genreSet.add(m.expectedGenre);
            });
            
            const genreFilter = document.getElementById('genre-filter-select');
            const currentValue = genreFilter.value;
            
            const sortedGenres = Array.from(genreSet).sort();
            
            genreFilter.innerHTML = '<option value="all">All Genres</option>';
            
            sortedGenres.forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreFilter.appendChild(option);
            });
            
            if (currentValue !== 'all' && sortedGenres.includes(currentValue)) {
                genreFilter.value = currentValue;
            }
        }
        
        function filterGenreMismatches() {
            const searchTerm = document.getElementById('genre-mismatch-search').value.toLowerCase().trim();
            const selectedGenre = document.getElementById('genre-filter-select').value;
            
            filteredMismatches = allMismatches.filter(mismatch => {
                if (searchTerm && !mismatch.artist.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                if (selectedGenre !== 'all' && mismatch.expectedGenre !== selectedGenre) {
                    return false;
                }
                
                return true;
            });
            
            mismatchesCurrentPage = 1;
            renderMismatches();
        }
        
        function renderMismatches() {
            const tbody = document.getElementById('genre-mismatches-body');
            
            if (filteredMismatches.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px;">
                    <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 20px; color: #28a745; display: block;"></i>
                    No genre mismatches found!
                </td></tr>`;
                updateMismatchesPagination();
                return;
            }
            
            const startIndex = (mismatchesCurrentPage - 1) * mismatchesPageSize;
            const endIndex = Math.min(startIndex + mismatchesPageSize, filteredMismatches.length);
            const pageMismatches = filteredMismatches.slice(startIndex, endIndex);
            
            let html = '';
            pageMismatches.forEach(mismatch => {
                let recordsHtml = '';
                mismatch.mismatchedRecords.slice(0, 3).forEach(record => {
                    recordsHtml += `<div style="font-size: 0.9em; color: #666; margin: 2px 0;">
                        <i class="fas fa-times" style="color: #dc3545; margin-right: 5px;"></i>
                        ${escapeHtml(record.title)} (Genre: ${escapeHtml(record.genre)})
                    </div>`;
                });
                if (mismatch.mismatchedRecords.length > 3) {
                    recordsHtml += `<div style="font-size: 0.9em; color: #666;">...and ${mismatch.mismatchedRecords.length - 3} more</div>`;
                }
                
                html += `
                    <tr>
                        <td><strong>${escapeHtml(mismatch.artist)}</strong></td>
                        <td><span class="badge" style="background: #28a745; color: white; padding: 3px 8px; border-radius: 12px;">${escapeHtml(mismatch.expectedGenre)}</span></td>
                        <td>${recordsHtml}</td>
                        <td style="text-align: center;"><span class="badge" style="background: #dc3545; color: white; padding: 3px 8px; border-radius: 12px;">${mismatch.mismatchedRecords.length}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="showGenreEditModal('${escapeHtml(mismatch.artist)}', '${escapeHtml(mismatch.expectedGenre)}', ${mismatch.genreId})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            updateMismatchesPagination();
        }
        
        function updateMismatchesPagination() {
            mismatchesTotalPages = Math.ceil(filteredMismatches.length / mismatchesPageSize);
            if (mismatchesTotalPages === 0) mismatchesTotalPages = 1;
            
            document.getElementById('mismatches-current-page').textContent = mismatchesCurrentPage;
            document.getElementById('mismatches-total-pages').textContent = mismatchesTotalPages;
            
            document.getElementById('mismatches-first-btn').disabled = mismatchesCurrentPage === 1;
            document.getElementById('mismatches-prev-btn').disabled = mismatchesCurrentPage === 1;
            document.getElementById('mismatches-next-btn').disabled = mismatchesCurrentPage === mismatchesTotalPages;
            document.getElementById('mismatches-last-btn').disabled = mismatchesCurrentPage === mismatchesTotalPages;
        }
        
        function goToMismatchesPage(direction) {
            if (direction === 'first') {
                mismatchesCurrentPage = 1;
            } else if (direction === 'prev') {
                mismatchesCurrentPage = Math.max(1, mismatchesCurrentPage - 1);
            } else if (direction === 'next') {
                mismatchesCurrentPage = Math.min(mismatchesTotalPages, mismatchesCurrentPage + 1);
            } else if (direction === 'last') {
                mismatchesCurrentPage = mismatchesTotalPages;
            }
            
            renderMismatches();
        }
        
        function changeMismatchesPageSize(newSize) {
            mismatchesPageSize = newSize;
            mismatchesCurrentPage = 1;
            renderMismatches();
        }
        
        function showGenreEditModal(artist, currentGenre, genreId) {
            currentEditArtist = artist;
            currentEditGenreId = genreId;
            
            document.getElementById('edit-artist-name').textContent = artist;
            
            const genreSelect = document.getElementById('edit-genre-select');
            genreSelect.innerHTML = '';
            
            if (window.allGenres && window.allGenres.length > 0) {
                window.allGenres.forEach(genre => {
                    const option = document.createElement('option');
                    option.value = genre.id;
                    option.textContent = genre.name;
                    if (genre.name === currentGenre) {
                        option.selected = true;
                    }
                    genreSelect.appendChild(option);
                });
            }
            
            document.getElementById('genre-edit-modal').style.display = 'flex';
        }
        
        function closeGenreEditModal() {
            document.getElementById('genre-edit-modal').style.display = 'none';
            currentEditArtist = null;
            currentEditGenreId = null;
        }
        
        async function saveGenreEdit() {
            if (!currentEditArtist || !currentEditGenreId) {
                alert('Missing artist or genre information');
                return;
            }
            
            const genreSelect = document.getElementById('edit-genre-select');
            const newGenreId = genreSelect.value;
            
            const saveBtn = document.getElementById('save-genre-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Saving...';
            saveBtn.disabled = true;
            
            try {
                const response = await fetch(`${AppConfig.baseUrl}/artist-genre/${encodeURIComponent(currentEditArtist)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        genre_id: newGenreId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showStatus(`Successfully updated genre for ${currentEditArtist}`, 'success');
                    closeGenreEditModal();
                    await loadGenreMismatches();
                } else {
                    throw new Error(data.error || 'Failed to update genre');
                }
            } catch (error) {
                console.error('Error updating genre:', error);
                showStatus(`Error updating genre: ${error.message}`, 'error');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        // ========== ACCESSORIES FUNCTIONS ==========
        async function loadAccessories() {
            showAccessoriesLoading(true);
            
            try {
                const response = await fetch(`${AppConfig.baseUrl}/accessories`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    allAccessories = data.accessories || [];
                    filteredAccessories = [...allAccessories];
                    
                    renderAccessories();
                } else {
                    throw new Error(data.message || 'Failed to load accessories');
                }
            } catch (error) {
                console.error('Error loading accessories:', error);
                const tbody = document.getElementById('accessories-body');
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:40px; color:#dc3545;">
                    <i class="fas fa-exclamation-circle" style="font-size: 48px; margin-bottom: 20px; display: block;"></i>
                    Error loading accessories: ${error.message}
                </td></tr>`;
            }
            
            showAccessoriesLoading(false);
        }
        
        function filterAccessories() {
            const searchTerm = document.getElementById('accessory-search').value.toLowerCase().trim();
            const stockFilter = document.getElementById('stock-filter').value;
            
            filteredAccessories = allAccessories.filter(accessory => {
                if (searchTerm) {
                    const matchesSearch = accessory.description.toLowerCase().includes(searchTerm) ||
                                         accessory.bar_code.toLowerCase().includes(searchTerm);
                    if (!matchesSearch) return false;
                }
                
                if (stockFilter === 'low' && (accessory.count > 5 || accessory.count <= 0)) return false;
                if (stockFilter === 'negative' && accessory.count >= 0) return false;
                if (stockFilter === 'in' && accessory.count <= 0) return false;
                
                return true;
            });
            
            renderAccessories();
        }
        
        function renderAccessories() {
            const tbody = document.getElementById('accessories-body');
            
            if (filteredAccessories.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:40px;">
                    <i class="fas fa-headphones" style="font-size: 48px; margin-bottom: 20px; color: #ccc; display: block;"></i>
                    No accessories found
                </td></tr>`;
                updateAccessorySelectionButtons();
                return;
            }
            
            let html = '';
            filteredAccessories.forEach(acc => {
                const stockClass = acc.count < 0 ? 'out-of-stock' : 
                                 acc.count <= 5 ? 'low-stock' : '';
                const isSelected = selectedAccessories.has(acc.id);
                
                html += `
                    <tr class="${stockClass}">
                        <td><input type="checkbox" class="accessory-checkbox" data-id="${acc.id}" ${isSelected ? 'checked' : ''}></td>
                        <td>${acc.id}</td>
                        <td><strong>${escapeHtml(acc.description)}</strong></td>
                        <td><span class="barcode-cell">${escapeHtml(acc.bar_code)}</span></td>
                        <td>$${acc.store_price.toFixed(2)}</td>
                        <td class="${acc.count < 0 ? 'negative-stock' : ''}">${acc.count}</td>
                        <td>${formatDate(acc.created_at)}</td>
                        <td>
                            <div class="accessory-actions">
                                <button class="btn btn-sm btn-warning" onclick="editAccessory(${acc.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteAccessory(${acc.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            
            document.querySelectorAll('.accessory-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    if (this.checked) {
                        selectedAccessories.add(id);
                    } else {
                        selectedAccessories.delete(id);
                    }
                    updateAccessorySelectionButtons();
                });
            });
            
            const selectAllCheckbox = document.getElementById('select-all-accessories');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.accessory-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                        const id = parseInt(checkbox.getAttribute('data-id'));
                        if (this.checked) {
                            selectedAccessories.add(id);
                        } else {
                            selectedAccessories.delete(id);
                        }
                    });
                    updateAccessorySelectionButtons();
                });
            }
            
            updateAccessorySelectionButtons();
        }
        
        function updateAccessorySelectionButtons() {
            const hasSelection = selectedAccessories.size > 0;
            document.getElementById('print-accessories-btn').disabled = !hasSelection;
        }
        
        function selectAllAccessoriesOnPage() {
            const checkboxes = document.querySelectorAll('.accessory-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const id = parseInt(checkbox.getAttribute('data-id'));
                selectedAccessories.add(id);
            });
            updateAccessorySelectionButtons();
            showStatus(`Selected all accessories on this page`, 'success');
        }
        
        function clearAccessorySelection() {
            selectedAccessories.clear();
            document.querySelectorAll('.accessory-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateAccessorySelectionButtons();
            showStatus('Accessory selection cleared', 'info');
        }
        
        function showAddAccessoryForm() {
            document.getElementById('form-title').innerHTML = '<i class="fas fa-plus-circle"></i> Add New Accessory';
            document.getElementById('accessory-description').value = '';
            document.getElementById('accessory-price').value = '';
            document.getElementById('accessory-count').value = '0';
            document.getElementById('accessory-form').style.display = 'block';
            document.getElementById('add-new-btn-container').style.display = 'none';
        }
        
        function cancelAccessoryForm() {
            document.getElementById('accessory-form').style.display = 'none';
            document.getElementById('add-new-btn-container').style.display = 'block';
        }
        
        async function saveAccessory() {
            const description = document.getElementById('accessory-description').value.trim();
            const price = parseFloat(document.getElementById('accessory-price').value);
            const count = parseInt(document.getElementById('accessory-count').value) || 0;
            
            if (!description) {
                alert('Description is required');
                return;
            }
            
            if (isNaN(price) || price < 0) {
                alert('Please enter a valid price');
                return;
            }
            
            const saveBtn = document.querySelector('#accessory-form .btn-success');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Saving...';
            saveBtn.disabled = true;
            
            try {
                const response = await fetch(`${AppConfig.baseUrl}/accessories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        description: description,
                        store_price: price,
                        count: count
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showStatus('Accessory added successfully', 'success');
                    cancelAccessoryForm();
                    await loadAccessories();
                } else {
                    throw new Error(data.message || 'Failed to add accessory');
                }
            } catch (error) {
                console.error('Error adding accessory:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }
        
        function editAccessory(id) {
            const accessory = allAccessories.find(a => a.id === id);
            if (!accessory) return;
            
            currentEditAccessoryId = id;
            
            document.getElementById('edit-accessory-description').value = accessory.description;
            document.getElementById('edit-accessory-price').value = accessory.store_price;
            document.getElementById('edit-accessory-count').value = accessory.count;
            
            const previewDiv = document.getElementById('edit-barcode-preview');
            const canvas = document.createElement('canvas');
            JsBarcode(canvas, accessory.bar_code, {
                format: "CODE128",
                displayValue: true,
                fontSize: 16,
                height: 50,
                width: 2,
                margin: 10
            });
            previewDiv.innerHTML = '';
            previewDiv.appendChild(canvas);
            
            document.getElementById('accessory-edit-modal').style.display = 'flex';
        }
        
        function closeAccessoryEditModal() {
            document.getElementById('accessory-edit-modal').style.display = 'none';
            currentEditAccessoryId = null;
        }
        
        async function updateAccessory() {
            if (!currentEditAccessoryId) return;
            
            const description = document.getElementById('edit-accessory-description').value.trim();
            const price = parseFloat(document.getElementById('edit-accessory-price').value);
            const count = parseInt(document.getElementById('edit-accessory-count').value) || 0;
            
            if (!description) {
                alert('Description is required');
                return;
            }
            
            if (isNaN(price) || price < 0) {
                alert('Please enter a valid price');
                return;
            }
            
            const saveBtn = document.querySelector('#accessory-edit-modal .btn-success');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Saving...';
            saveBtn.disabled = true;
            
            try {
                const response = await fetch(`${AppConfig.baseUrl}/accessories/${currentEditAccessoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        description: description,
                        store_price: price,
                        count: count
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showStatus('Accessory updated successfully', 'success');
                    closeAccessoryEditModal();
                    await loadAccessories();
                } else {
                    throw new Error(data.message || 'Failed to update accessory');
                }
            } catch (error) {
                console.error('Error updating accessory:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }
        
        async function regenerateAccessoryBarcode() {
            if (!currentEditAccessoryId) return;
            
            if (!confirm('Are you sure you want to regenerate the barcode? This will create a new unique barcode.')) {
                return;
            }
            
            const regenBtn = document.getElementById('regenerate-barcode-btn');
            const originalText = regenBtn.innerHTML;
            regenBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Generating...';
            regenBtn.disabled = true;
            
            try {
                const response = await fetch(`${AppConfig.baseUrl}/accessories/${currentEditAccessoryId}/generate-barcode`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showStatus('Barcode regenerated successfully', 'success');
                    
                    const previewDiv = document.getElementById('edit-barcode-preview');
                    const canvas = document.createElement('canvas');
                    JsBarcode(canvas, data.bar_code, {
                        format: "CODE128",
                        displayValue: true,
                        fontSize: 16,
                        height: 50,
                        width: 2,
                        margin: 10
                    });
                    previewDiv.innerHTML = '';
                    previewDiv.appendChild(canvas);
                    
                    await loadAccessories();
                } else {
                    throw new Error(data.message || 'Failed to regenerate barcode');
                }
            } catch (error) {
                console.error('Error regenerating barcode:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                regenBtn.innerHTML = originalText;
                regenBtn.disabled = false;
            }
        }
        
        function deleteAccessory(id) {
            const accessory = allAccessories.find(a => a.id === id);
            if (!accessory) return;
            
            currentDeleteAccessoryId = id;
            document.getElementById('delete-accessory-description').textContent = accessory.description;
            document.getElementById('accessory-delete-modal').style.display = 'flex';
        }
        
        function closeAccessoryDeleteModal() {
            document.getElementById('accessory-delete-modal').style.display = 'none';
            currentDeleteAccessoryId = null;
        }
        
        async function confirmDeleteAccessory() {
            if (!currentDeleteAccessoryId) return;
            
            const deleteBtn = document.querySelector('#accessory-delete-modal .btn-danger');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> Deleting...';
            deleteBtn.disabled = true;
            
            try {
                const response = await fetch(`${AppConfig.baseUrl}/accessories/${currentDeleteAccessoryId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showStatus('Accessory deleted successfully', 'success');
                    closeAccessoryDeleteModal();
                    await loadAccessories();
                } else {
                    throw new Error(data.message || 'Failed to delete accessory');
                }
            } catch (error) {
                console.error('Error deleting accessory:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                deleteBtn.innerHTML = originalText;
                deleteBtn.disabled = false;
            }
        }
        
        // Visual barcode printing function for accessories - FIXED
        function printAccessoryBarcodes() {
            if (selectedAccessories.size === 0) {
                showStatus('No accessories selected for printing', 'error');
                return;
            }
            
            const selectedItems = allAccessories.filter(acc => selectedAccessories.has(acc.id));
            
            // Create a new window for printing
            const printWindow = window.open('', '_blank');
            
            let barcodeHtml = '<html><head><title>Accessory Barcodes</title>';
            barcodeHtml += '<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"><' + '/script>';
            barcodeHtml += '<style>';
            barcodeHtml += 'body { font-family: Arial, sans-serif; padding: 20px; }';
            barcodeHtml += '.barcode-page { page-break-after: always; }';
            barcodeHtml += '.barcode-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }';
            barcodeHtml += '.barcode-item { text-align: center; padding: 15px; border: 1px solid #ddd; border-radius: 8px; page-break-inside: avoid; }';
            barcodeHtml += '.barcode-item svg { max-width: 100%; height: auto; }';
            barcodeHtml += '.barcode-description { font-weight: bold; margin: 10px 0 5px; }';
            barcodeHtml += '.barcode-price { color: #27ae60; font-size: 1.2rem; }';
            barcodeHtml += '@media print { .no-print { display: none; } }';
            barcodeHtml += '</style>';
            barcodeHtml += '</head><body>';
            barcodeHtml += '<div class="no-print" style="margin-bottom: 20px; text-align: center;">';
            barcodeHtml += '<button onclick="window.print()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">Print Barcodes</button>';
            barcodeHtml += '</div>';
            
            // Group barcodes in pages (8 per page - 2 columns x 4 rows)
            for (let i = 0; i < selectedItems.length; i += 8) {
                if (i > 0) {
                    barcodeHtml += '<div class="barcode-page" style="page-break-before: always;"></div>';
                }
                barcodeHtml += '<div class="barcode-grid">';
                
                for (let j = i; j < Math.min(i + 8, selectedItems.length); j++) {
                    const item = selectedItems[j];
                    barcodeHtml += '<div class="barcode-item">';
                    barcodeHtml += `<canvas id="barcode-${j}" style="width: 100%; height: auto;"></canvas>`;
                    barcodeHtml += `<div class="barcode-description">${escapeHtml(item.description)}</div>`;
                    barcodeHtml += `<div class="barcode-price">$${item.store_price.toFixed(2)}</div>`;
                    barcodeHtml += `<div style="font-family: monospace; color: #666; font-size: 0.8rem; margin-top: 5px;">${escapeHtml(item.bar_code)}</div>`;
                    barcodeHtml += '</div>';
                }
                
                barcodeHtml += '</div>';
            }
            
            barcodeHtml += '<script>';
            barcodeHtml += 'window.onload = function() {';
            
            for (let i = 0; i < selectedItems.length; i++) {
                const item = selectedItems[i];
                barcodeHtml += `JsBarcode("#barcode-${i}", "${item.bar_code}", { format: "CODE128", displayValue: false, height: 60, width: 2 });`;
            }
            
            barcodeHtml += '}';
            barcodeHtml += '<' + '/script>';
            barcodeHtml += '</body></html>';
            
            printWindow.document.write(barcodeHtml);
            printWindow.document.close();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            const userData = localStorage.getItem('user');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    if (user.role !== 'admin') {
                        window.location.href = '/';
                        return;
                    }
                } catch {
                    window.location.href = '/';
                    return;
                }
            } else {
                window.location.href = '/';
                return;
            }
            
            window.selectedRecords = new Set();
            
            loadSavedReceipts();
            
            await fetchAllConfigValues();
            
            $('#user-select').select2({
                placeholder: "Select a user...",
                allowClear: true
            }).on('change', loadRecords);
            
            loadUsers();
            loadRecords();
            refreshTerminals();
            
            document.getElementById('search-query').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchRecordsAndAccessories();
                }
            });
            
            const today = new Date().toISOString().split('T')[0];
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('receipt-start-date').value = thirtyDaysAgo;
            document.getElementById('receipt-end-date').value = today;
            
            if (document.getElementById('accessories-tab').classList.contains('active')) {
                loadAccessories();
            }
        });
    </script>
</body>
</html>