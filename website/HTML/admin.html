<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - PigStyle Music</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/admin.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="/static/js/app-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="/">PigStyle Music</a>
        </div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/catalog">Catalog</a>
            <a href="/streaming">Streaming</a>
            <a href="/consignment">Consignment</a>
            <a href="/dashboard">Dashboard</a>
            <div id="auth-section">
                <!-- Populated by app-config.js -->
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <h1><i class="fas fa-cogs"></i> Admin Panel</h1>
        
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('price-tags')">
                <i class="fas fa-tags"></i> Print Price Tags
            </div>
            <div class="tab" onclick="switchTab('check-out')">
                <i class="fas fa-shopping-cart"></i> Check Out
            </div>
            <div class="tab" onclick="switchTab('receipts')">
                <i class="fas fa-receipt"></i> Receipts
            </div>
            <div class="tab" onclick="switchTab('consignors')">
                <i class="fas fa-users"></i> Consignors
            </div>
            <div class="tab" onclick="switchTab('admin-config')">
                <i class="fas fa-sliders-h"></i> Admin Config
            </div>
        </div>
        
        <!-- Price Tags Tab -->
        <div id="price-tags-tab" class="tab-content active">
            <h2><i class="fas fa-tags"></i> Print Price Tags</h2>
            
            <!-- Filter Controls -->
            <div class="filter-controls">
                <!-- User Selection -->
                <div class="filter-group">
                    <label for="user-select"><i class="fas fa-user"></i> Select User:</label>
                    <select id="user-select" class="select2 filter-select" style="width: 250px;">
                        <option value="all">All Users</option>
                    </select>
                </div>
                
                <!-- Status Filter -->
                <div class="filter-group">
                    <label for="status-filter"><i class="fas fa-filter"></i> Filter by Status:</label>
                    <select id="status-filter" class="filter-select" onchange="filterRecords()">
                        <option value="all">All Statuses</option>
                        <option value="inactive">Inactive Only</option>
                        <option value="active">Active Only</option>
                        <option value="sold">Sold Only</option>
                    </select>
                </div>
                
                <!-- Refresh Button -->
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="loadRecords()" style="height: 38px;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <!-- Records Section -->
            <div id="records-section">
                <h3><i class="fas fa-list"></i> Records</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Records</h3>
                        <p class="stat-number" id="total-records">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Inactive Records</h3>
                        <p class="stat-number" id="inactive-records">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Active Records</h3>
                        <p class="stat-number" id="active-records">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Sold Records</h3>
                        <p class="stat-number" id="sold-records">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Selected Tags</h3>
                        <p class="stat-number" id="selected-tags">0</p>
                    </div>
                </div>
                
                <!-- Batch Size Input -->
                <div class="input-group">
                    <label for="batch-size"><i class="fas fa-sort-numeric-down"></i> Number of tags to print:</label>
                    <input type="number" id="batch-size" min="1" value="10" style="width: 200px; padding: 8px;">
                    <small>Most recent inactive records will be selected (sorted by creation date descending)</small>
                </div>
                
                <!-- Pagination Controls -->
                <div class="pagination" id="pagination-controls">
                    <button class="page-btn" onclick="goToFirstPage()" id="first-page-btn" disabled>
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button class="page-btn" onclick="goToPreviousPage()" id="prev-page-btn" disabled>
                        <i class="fas fa-angle-left"></i>
                    </button>
                    
                    <span class="pagination-info">
                        Page <input type="number" class="page-input" id="current-page" min="1" value="1" 
                               onchange="goToPage(parseInt(this.value))" onblur="goToPage(parseInt(this.value))"> 
                        of <span id="total-pages">1</span>
                    </span>
                    
                    <button class="page-btn" onclick="goToNextPage()" id="next-page-btn" disabled>
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button class="page-btn" onclick="goToLastPage()" id="last-page-btn" disabled>
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                    
                    <div class="records-per-page">
                        <span>Show:</span>
                        <select id="page-size" onchange="changePageSize(parseInt(this.value))">
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                        <span>records per page</span>
                    </div>
                </div>
                
                <!-- Records Table -->
                <div class="records-table-container">
                    <table class="records-table" id="records-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all"></th>
                                <th>#</th>
                                <th>Created Date <i class="fas fa-sort-down"></i></th>
                                <th>Artist</th>
                                <th>Title</th>
                                <th>Price</th>
                                <th>Catalog #</th>
                                <th>Genre</th>
                                <th>Barcode</th>
                                <th>Consignor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="records-body">
                            <!-- Records will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Footer -->
                <div class="pagination" id="pagination-footer">
                    <span class="pagination-info">
                        Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> 
                        of <span id="total-filtered">0</span> records
                        (<span id="selected-count">0</span> selected)
                    </span>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadRecords()">
                        <i class="fas fa-sync-alt"></i> Refresh Records
                    </button>
                    <button class="btn btn-success" onclick="showPrintConfirmation()" id="print-btn" disabled>
                        <i class="fas fa-print"></i> Print Price Tags
                    </button>
                    <button class="btn btn-warning" onclick="showMarkActiveConfirmation()" id="mark-active-btn" disabled>
                        <i class="fas fa-check-circle"></i> Mark as Active
                    </button>
                    <button class="btn btn-secondary" onclick="selectInactiveRecords()" id="select-inactive-btn">
                        <i class="fas fa-check-square"></i> Select Inactive Records
                    </button>
                    <button class="btn btn-secondary" onclick="selectAllOnPage()">
                        <i class="fas fa-check-double"></i> Select All on Page
                    </button>
                    <button class="btn btn-secondary" onclick="clearSelection()">
                        <i class="fas fa-times-circle"></i> Clear Selection
                    </button>
                </div>
                
                <!-- Status Messages -->
                <div id="status-message" class="status-message"></div>
                
                <!-- Loading Indicator -->
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p>Processing...</p>
                </div>
            </div>
        </div>
        
        <!-- Check Out Tab -->
        <div id="check-out-tab" class="tab-content">
            <h2><i class="fas fa-shopping-cart"></i> Check Out</h2>
            
            <!-- Terminal Management Section (Kept for future Square integration) -->
            <div class="terminal-management">
                <div class="terminal-header">
                    <h3><i class="fas fa-square"></i> Square Terminal Status</h3>
                    <button class="btn btn-secondary" onclick="refreshTerminals()">
                        <i class="fas fa-sync-alt"></i> Refresh Terminals
                    </button>
                </div>
                <div id="terminal-list" class="terminal-list">
                    <!-- Terminal list will be populated here -->
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <i class="fas fa-square" style="font-size: 24px; margin-bottom: 10px; color: #ccc;"></i>
                        <p>Click refresh to load available terminals</p>
                    </div>
                </div>
            </div>
            
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="search-query" class="search-input" 
                           placeholder="Search by barcode, title, artist, or catalog number..." 
                           onkeypress="if(event.key === 'Enter') searchRecords()">
                    <button class="btn btn-primary" onclick="searchRecords()">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                
                <div class="search-filters">
                    <label class="search-filter-checkbox">
                        <input type="checkbox" id="filter-active" checked> 
                        <i class="fas fa-check-circle" style="color: #28a745;"></i> Active Only
                    </label>
                    <label class="search-filter-checkbox">
                        <input type="checkbox" id="filter-barcode"> 
                        <i class="fas fa-barcode"></i> Search Barcode Only
                    </label>
                    <span style="color: #666; margin-left: auto; display: flex; align-items: center;">
                        <i class="fas fa-info-circle"></i> 
                        <span style="margin-left: 5px;">Found <span id="search-result-count">0</span> results</span>
                    </span>
                </div>
            </div>
            
            <div id="checkout-status-message" class="status-message"></div>
            
            <div id="search-results-container">
                <div class="results-count" id="results-count-header">
                    Showing <span id="displayed-results">0</span> records
                </div>
                <div id="search-results" class="search-results">
                    <!-- Search results will be loaded here -->
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 20px; color: #ccc;"></i>
                        <p>Enter a search term to find records</p>
                    </div>
                </div>
            </div>
            
            <!-- Shopping Cart Section -->
            <div id="shopping-cart-section" class="cart-section" style="display: none;">
                <div class="cart-header">
                    <h3><i class="fas fa-shopping-cart"></i> Shopping Cart</h3>
                    <span id="cart-item-count" class="badge" style="background: #3498db; color: white; padding: 5px 10px; border-radius: 20px;">0 items</span>
                </div>
                
                <div id="cart-items" class="cart-items">
                    <!-- Cart items will be dynamically added here -->
                </div>
                
                <div class="cart-summary">
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="cart-subtotal">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax (<span id="tax-rate-display">0</span>%):</span>
                        <span id="cart-tax">$0.00</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total:</span>
                        <span id="cart-total">$0.00</span>
                    </div>
                </div>
                
                <div class="cart-actions">
                    <button class="btn btn-secondary" onclick="clearCart()">
                        <i class="fas fa-times"></i> Clear Cart
                    </button>
                    <button class="btn btn-cash" onclick="showTenderModal()" id="checkout-cash-btn" disabled>
                        <i class="fas fa-money-bill-wave"></i> Complete Cash Sale
                    </button>
                </div>
            </div>
            
            <!-- Check Out Loading Indicator -->
            <div class="loading" id="checkout-loading">
                <div class="loading-spinner"></div>
                <p>Searching...</p>
            </div>
        </div>
        
        <!-- Receipts Tab -->
        <div id="receipts-tab" class="tab-content">
            <h2><i class="fas fa-receipt"></i> Receipt History</h2>
            
            <!-- Receipt Stats -->
            <div class="receipt-stats" id="receipt-stats">
                <div class="receipt-stat-card">
                    <div class="receipt-stat-number" id="total-receipts">0</div>
                    <div class="receipt-stat-label">Total Receipts</div>
                </div>
                <div class="receipt-stat-card">
                    <div class="receipt-stat-number" id="total-receipts-sales">$0.00</div>
                    <div class="receipt-stat-label">Total Sales</div>
                </div>
                <div class="receipt-stat-card">
                    <div class="receipt-stat-number" id="total-receipts-tax">$0.00</div>
                    <div class="receipt-stat-label">Total Tax Collected</div>
                </div>
                <div class="receipt-stat-card">
                    <div class="receipt-stat-number" id="total-receipts-items">0</div>
                    <div class="receipt-stat-label">Items Sold</div>
                </div>
            </div>
            
            <!-- Search/Filter Section -->
            <div class="receipts-search">
                <h3><i class="fas fa-search"></i> Search Receipts</h3>
                <div class="date-range">
                    <div class="date-field">
                        <label for="receipt-start-date">From Date:</label>
                        <input type="date" id="receipt-start-date" class="date-input">
                    </div>
                    <div class="date-field">
                        <label for="receipt-end-date">To Date:</label>
                        <input type="date" id="receipt-end-date" class="date-input">
                    </div>
                    <div class="date-field">
                        <label for="receipt-search-query">Receipt # or Item:</label>
                        <input type="text" id="receipt-search-query" class="filter-select" placeholder="Search...">
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-primary" onclick="searchReceipts()">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <button class="btn btn-secondary" onclick="resetReceiptSearch()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Receipts Grid -->
            <div id="receipts-grid" class="receipts-grid">
                <!-- Receipts will be loaded here -->
                <div style="text-align: center; padding: 40px; color: #666; grid-column: 1/-1;">
                    <i class="fas fa-receipt" style="font-size: 48px; margin-bottom: 20px; color: #ccc;"></i>
                    <p>No receipts found</p>
                </div>
            </div>
            
            <!-- Receipts Loading Indicator -->
            <div class="loading" id="receipts-loading">
                <div class="loading-spinner"></div>
                <p>Loading receipts...</p>
            </div>
        </div>
        
        <!-- Consignors Tab (NEW) -->
        <div id="consignors-tab" class="tab-content">
            <h2><i class="fas fa-users"></i> Consignor Management</h2>
            
            <!-- Commission Rate Display -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p><strong>Commission Rate:</strong> <span id="commission-rate-display">10</span>% (Admin gets <span id="admin-commission-display">10</span>% of sale, Consignor gets <span id="consignor-commission-display">90</span>%)</p>
            </div>
            
            <!-- Summary Cards -->
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <h3>Total Consignors</h3>
                    <p class="stat-number" id="total-consignors">0</p>
                </div>
                <div class="stat-card">
                    <h3>Total Owed to Consignors</h3>
                    <p class="stat-number" id="total-credit">$0.00</p>
                </div>
                <div class="stat-card">
                    <h3>Total Admin Commission</h3>
                    <p class="stat-number" id="admin-total-commission">$0.00</p>
                </div>
            </div>
            
            <!-- Consignor Table -->
            <div class="records-table-container">
                <table class="records-table" id="consignors-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Initials</th>
                            <th>Owed Amount</th>
                            <th>Records Sold</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="consignors-body">
                        <tr><td colspan="6" style="text-align:center; padding:20px;">Loading consignors...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Payment Modal -->
            <div id="payment-modal" class="modal-overlay" style="display:none;">
                <div class="modal-content" style="max-width:400px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Pay Consignor</h3>
                        <button class="modal-close" onclick="closePaymentModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Consignor: <strong id="payment-consignor-name"></strong></p>
                        <p>Amount Owed: <strong id="payment-amount">$0.00</strong></p>
                        <p>Are you sure you want to mark this amount as paid? This will clear their balance.</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
                        <button class="btn btn-success" onclick="processPayment()">Confirm Payment</button>
                    </div>
                </div>
            </div>
            
            <!-- Loading for consignor actions -->
            <div class="loading" id="consignors-loading" style="display:none;">
                <div class="loading-spinner"></div>
                <p>Processing...</p>
            </div>
        </div>
        
        <!-- Admin Config Tab -->
        <div id="admin-config-tab" class="tab-content">
            <h2><i class="fas fa-sliders-h"></i> Admin Configuration</h2>
            
            <div class="admin-config-section">
                <h3><i class="fas fa-percent"></i> Tax Settings</h3>
                <div class="config-grid">
                    <div class="input-group">
                        <label for="tax-rate">Tax Rate (%):</label>
                        <input type="number" id="tax-rate" min="0" max="100" step="0.01" value="8.25" class="filter-select" style="width: 200px;">
                        <small>Sales tax percentage to apply to all cash sales</small>
                    </div>
                    <div class="input-group">
                        <label for="tax-enabled">
                            <input type="checkbox" id="tax-enabled" checked> Enable Tax Calculation
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="admin-config-section">
                <h3><i class="fas fa-percent"></i> Commission Settings</h3>
                <div class="config-grid">
                    <div class="input-group">
                        <label for="commission-rate">Commission Rate (%):</label>
                        <input type="number" id="commission-rate" min="0" max="100" step="0.1" value="10" class="filter-select" style="width: 200px;">
                        <small>Percentage that goes to the store (admin). The rest goes to consignor.</small>
                    </div>
                </div>
            </div>
            
            <div class="admin-config-section">
                <h3><i class="fas fa-receipt"></i> Receipt Settings</h3>
                <div class="config-grid">
                    <div class="input-group">
                        <label for="store-name">Store Name:</label>
                        <input type="text" id="store-name" value="PigStyle Music" class="filter-select" style="width: 100%;">
                    </div>
                    <div class="input-group">
                        <label for="store-address">Store Address:</label>
                        <input type="text" id="store-address" value="123 Main Street, City, State 12345" class="filter-select" style="width: 100%;">
                    </div>
                    <div class="input-group">
                        <label for="store-phone">Store Phone:</label>
                        <input type="text" id="store-phone" value="(555) 555-5555" class="filter-select" style="width: 100%;">
                    </div>
                    <div class="input-group">
                        <label for="receipt-footer">Receipt Footer Message:</label>
                        <textarea id="receipt-footer" rows="3" class="filter-select" style="width: 100%;">Thank you for your business! Returns accepted within 30 days.</textarea>
                    </div>
                    <div class="input-group">
                        <label for="auto-print-receipt">
                            <input type="checkbox" id="auto-print-receipt" checked> Automatically show receipt after sale
                        </label>
                    </div>
                </div>
                <div class="action-buttons" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveAdminConfig()">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Confirmation Modal -->
    <div id="print-confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-print"></i> Print Price Tags</h3>
                <button class="modal-close" onclick="closePrintConfirmation()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="print-summary">
                    <h4>Print Summary</h4>
                    <p>You are about to print price tags for <strong id="print-count">0</strong> selected records.</p>
                    <ul id="print-summary-list">
                        <!-- Will be populated dynamically -->
                    </ul>
                    <p>After printing successfully, you should mark these records as <strong>Active</strong> using the "Mark as Active" button.</p>
                </div>
                <div class="confirmation-check">
                    <input type="checkbox" id="print-confirmation-check">
                    <label for="print-confirmation-check">I have confirmed the print settings and am ready to print</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePrintConfirmation()">Cancel</button>
                <button class="btn btn-success" onclick="confirmPrint()" id="confirm-print-btn" disabled>
                    <i class="fas fa-print"></i> Print Now
                </button>
            </div>
        </div>
    </div>

    <!-- Mark Active Confirmation Modal -->
    <div id="mark-active-confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-check-circle"></i> Mark as Active</h3>
                <button class="modal-close" onclick="closeMarkActiveConfirmation()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="print-summary">
                    <h4>Confirmation Required</h4>
                    <p>You are about to mark <strong id="mark-active-count">0</strong> selected records as <strong>Active</strong>.</p>
                    <ul id="mark-active-summary-list">
                        <!-- Will be populated dynamically -->
                    </ul>
                    <p><strong>Important:</strong> Only mark records as Active <em>after</em> you have successfully printed their price tags.</p>
                    <p>This will change their status from "Inactive" to "Active" in the system.</p>
                </div>
                <div class="confirmation-check">
                    <input type="checkbox" id="mark-active-confirmation-check">
                    <label for="mark-active-confirmation-check">I have successfully printed price tags for these records</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMarkActiveConfirmation()">Cancel</button>
                <button class="btn btn-warning" onclick="confirmMarkActive()" id="confirm-mark-active-btn" disabled>
                    <i class="fas fa-check-circle"></i> Mark as Active
                </button>
            </div>
        </div>
    </div>

    <!-- Terminal Checkout Modal -->
    <div id="terminal-checkout-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-square"></i> Square Terminal Checkout</h3>
                <button class="modal-close" onclick="closeTerminalCheckoutModal()">&times;</button>
            </div>
            <div class="modal-body" id="terminal-checkout-body">
                <!-- Content will be dynamically populated -->
            </div>
        </div>
    </div>

    <!-- Terminal Selection Modal -->
    <div id="terminal-selection-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-square"></i> Select Terminal</h3>
                <button class="modal-close" onclick="closeTerminalSelectionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="terminal-selection-list" class="terminal-device-selector">
                    <!-- Terminal selection will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTerminalSelectionModal()">Cancel</button>
                <button class="btn btn-success" onclick="initiateTerminalCheckout()" id="confirm-terminal-btn" disabled>
                    <i class="fas fa-check-circle"></i> Start Checkout
                </button>
            </div>
        </div>
    </div>

    <!-- Tender Modal (Cash Payment) -->
    <div id="tender-modal" class="tender-modal">
        <div class="tender-content">
            <h3 style="text-align: center; margin-bottom: 20px;"><i class="fas fa-money-bill-wave"></i> Cash Payment</h3>
            
            <div style="text-align: center; margin-bottom: 10px;">Total Due:</div>
            <div class="tender-amount" id="tender-total-due">$0.00</div>
            
            <input type="number" id="tender-amount" class="tender-input" placeholder="Enter amount received" min="0" step="0.01" autofocus>
            
            <div id="change-display-container" style="display: none;">
                <div style="text-align: center; margin-bottom: 5px;">Change:</div>
                <div class="change-display" id="change-amount">$0.00</div>
            </div>
            
            <div class="action-buttons" style="justify-content: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeTenderModal()">Cancel</button>
                <button class="btn btn-success" onclick="processCashPayment()" id="complete-payment-btn" disabled>
                    <i class="fas fa-check"></i> Complete Payment
                </button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receipt-modal" class="receipt-modal">
        <div class="receipt-content" id="receipt-content">
            <!-- Receipt will be dynamically generated here -->
        </div>
    </div>

    <script>
        // Global variables
        let consignorCache = {};
        let allRecords = [];
        let filteredRecords = [];
        let currentPage = 1;
        let pageSize = 100;
        let totalPages = 1;
        let configValues = {};
        let recentlyPrintedIds = new Set(); // Track recently printed records
        let currentSearchResults = []; // Store current search results for check out tab
        let availableTerminals = []; // Store available Square terminals
        let selectedTerminalId = null; // Currently selected terminal ID
        let activeCheckoutId = null; // Active terminal checkout ID
        let checkoutPollInterval = null; // Interval for polling checkout status
        
        // Shopping Cart Variables
        let checkoutCart = [];
        
        // Receipts Storage
        let savedReceipts = [];
        
        // Admin Config Variables
        let adminConfig = {
            taxRate: 8.25,
            taxEnabled: true,
            commissionRate: 10,
            storeName: 'PigStyle Music',
            storeAddress: '123 Main Street, City, State 12345',
            storePhone: '(555) 555-5555',
            receiptFooter: 'Thank you for your business! Returns accepted within 30 days.',
            autoPrintReceipt: true
        };
        
        // Consignors list with owed amounts
        let consignorsList = [];
        let consignorOwedAmounts = {}; // Track owed amounts per consignor
        
        // Configuration fetching functions
        async function fetchConfigValues() {
            try {
                const response = await fetch(`${AppConfig.baseUrl}/config`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        configValues = data.config || {};
                        console.log('Loaded config values:', configValues);
                        return configValues;
                    }
                }
                // Return default values if API fails
                return getDefaultConfig();
            } catch (error) {
                console.error('Error fetching config:', error);
                return getDefaultConfig();
            }
        }
        
        function getDefaultConfig() {
            return {
                LABEL_WIDTH_MM: 45.0,
                LABEL_HEIGHT_MM: 16.8,
                LEFT_MARGIN_MM: 6.5,
                GUTTER_SPACING_MM: 6.5,
                TOP_MARGIN_MM: 14.0,
                FONT_SIZE: 7,
                PRICE_FONT_SIZE: 10,
                PRICE_Y_POS: 2.0,
                TEXT_FONT_SIZE: 6,
                BARCODE_Y_POS: 2.0,
                BARCODE_HEIGHT: 6.0,
                PRINT_BORDERS: false
            };
        }
        
        async function getConfigValue(key, defaultValue) {
            if (Object.keys(configValues).length === 0) {
                await fetchConfigValues();
            }
            return configValues[key] !== undefined ? configValues[key] : defaultValue;
        }
        
        // Load admin config from localStorage
        function loadAdminConfig() {
            const savedConfig = localStorage.getItem('pigstyle_admin_config');
            if (savedConfig) {
                try {
                    const parsed = JSON.parse(savedConfig);
                    adminConfig = { ...adminConfig, ...parsed };
                } catch (e) {
                    console.error('Error loading admin config:', e);
                }
            }
            
            // Update UI with loaded config
            document.getElementById('tax-rate').value = adminConfig.taxRate;
            document.getElementById('tax-enabled').checked = adminConfig.taxEnabled;
            document.getElementById('commission-rate').value = adminConfig.commissionRate || 10;
            document.getElementById('store-name').value = adminConfig.storeName;
            document.getElementById('store-address').value = adminConfig.storeAddress;
            document.getElementById('store-phone').value = adminConfig.storePhone;
            document.getElementById('receipt-footer').value = adminConfig.receiptFooter;
            document.getElementById('auto-print-receipt').checked = adminConfig.autoPrintReceipt;
            
            document.getElementById('tax-rate-display').textContent = adminConfig.taxRate;
            
            // Update commission displays
            updateCommissionDisplay();
        }
        
        function updateCommissionDisplay() {
            const rate = adminConfig.commissionRate || 10;
            document.getElementById('commission-rate-display').textContent = rate;
            document.getElementById('admin-commission-display').textContent = rate;
            document.getElementById('consignor-commission-display').textContent = 100 - rate;
        }
        
        // Save admin config to localStorage
        function saveAdminConfig() {
            adminConfig = {
                taxRate: parseFloat(document.getElementById('tax-rate').value) || 0,
                taxEnabled: document.getElementById('tax-enabled').checked,
                commissionRate: parseFloat(document.getElementById('commission-rate').value) || 10,
                storeName: document.getElementById('store-name').value || 'PigStyle Music',
                storeAddress: document.getElementById('store-address').value || '',
                storePhone: document.getElementById('store-phone').value || '',
                receiptFooter: document.getElementById('receipt-footer').value || 'Thank you for your business!',
                autoPrintReceipt: document.getElementById('auto-print-receipt').checked
            };
            
            localStorage.setItem('pigstyle_admin_config', JSON.stringify(adminConfig));
            document.getElementById('tax-rate-display').textContent = adminConfig.taxRate;
            updateCommissionDisplay();
            
            showStatus('Configuration saved successfully!', 'success');
        }
        
        // Load saved receipts from localStorage
        function loadSavedReceipts() {
            const saved = localStorage.getItem('pigstyle_receipts');
            if (saved) {
                try {
                    savedReceipts = JSON.parse(saved);
                    // Convert date strings back to Date objects
                    savedReceipts.forEach(receipt => {
                        receipt.date = new Date(receipt.date);
                    });
                } catch (e) {
                    console.error('Error loading receipts:', e);
                    savedReceipts = [];
                }
            }
            return savedReceipts;
        }
        
        // Save a receipt to localStorage
        function saveReceipt(transaction) {
            // Create a copy with date as ISO string for storage
            const receiptToSave = {
                ...transaction,
                date: transaction.date.toISOString()
            };
            
            savedReceipts.unshift(receiptToSave); // Add to beginning (newest first)
            
            // Keep only last 1000 receipts to prevent localStorage from getting too full
            if (savedReceipts.length > 1000) {
                savedReceipts = savedReceipts.slice(0, 1000);
            }
            
            localStorage.setItem('pigstyle_receipts', JSON.stringify(savedReceipts));
            
            // Refresh receipts display if on receipts tab
            if (document.getElementById('receipts-tab').classList.contains('active')) {
                renderReceipts(savedReceipts);
            }
        }
        
        // Render receipts in the receipts tab
        function renderReceipts(receipts) {
            const container = document.getElementById('receipts-grid');
            
            if (receipts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666; grid-column: 1/-1;">
                        <i class="fas fa-receipt" style="font-size: 48px; margin-bottom: 20px; color: #ccc;"></i>
                        <p>No receipts found</p>
                    </div>
                `;
                
                // Update stats
                document.getElementById('total-receipts').textContent = '0';
                document.getElementById('total-receipts-sales').textContent = '$0.00';
                document.getElementById('total-receipts-tax').textContent = '$0.00';
                document.getElementById('total-receipts-items').textContent = '0';
                return;
            }
            
            let html = '';
            let totalSales = 0;
            let totalTax = 0;
            let totalItems = 0;
            
            receipts.forEach(receipt => {
                const date = new Date(receipt.date);
                const dateStr = date.toLocaleDateString() + ' ' + 
                               date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                const itemCount = receipt.items.length;
                const itemSummary = itemCount === 1 ? 
                    receipt.items[0].artist + ' - ' + receipt.items[0].title : 
                    `${itemCount} items`;
                
                totalSales += receipt.total || 0;
                totalTax += receipt.tax || 0;
                totalItems += itemCount;
                
                html += `
                    <div class="receipt-card" onclick="viewReceipt('${receipt.id}')">
                        <div class="receipt-card-header">
                            <span class="receipt-card-title">${receipt.id}</span>
                            <span class="receipt-card-date">${dateStr}</span>
                        </div>
                        <div class="receipt-card-meta">
                            <span>Items: ${itemCount}</span>
                            <span class="receipt-card-total">$${(receipt.total || 0).toFixed(2)}</span>
                        </div>
                        <div class="receipt-card-items" title="${itemSummary}">
                            <i class="fas fa-music"></i> ${itemSummary}
                        </div>
                        <div class="receipt-card-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-sm btn-primary" onclick="viewReceipt('${receipt.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-success" onclick="downloadReceiptPDF('${receipt.id}')">
                                <i class="fas fa-download"></i> PDF
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="printReceipt('${receipt.id}')">
                                <i class="fas fa-print"></i> Print
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Update stats
            document.getElementById('total-receipts').textContent = receipts.length;
            document.getElementById('total-receipts-sales').textContent = `$${totalSales.toFixed(2)}`;
            document.getElementById('total-receipts-tax').textContent = `$${totalTax.toFixed(2)}`;
            document.getElementById('total-receipts-items').textContent = totalItems;
        }
        
        // Search receipts
        function searchReceipts() {
            const startDate = document.getElementById('receipt-start-date').value;
            const endDate = document.getElementById('receipt-end-date').value;
            const query = document.getElementById('receipt-search-query').value.toLowerCase().trim();
            
            let filtered = [...savedReceipts];
            
            // Filter by date range
            if (startDate) {
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                filtered = filtered.filter(r => new Date(r.date) >= start);
            }
            
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filtered = filtered.filter(r => new Date(r.date) <= end);
            }
            
            // Filter by search query
            if (query) {
                filtered = filtered.filter(r => 
                    r.id.toLowerCase().includes(query) ||
                    r.items.some(item => 
                        (item.artist && item.artist.toLowerCase().includes(query)) ||
                        (item.title && item.title.toLowerCase().includes(query)) ||
                        (item.catalog_number && item.catalog_number.toLowerCase().includes(query))
                    )
                );
            }
            
            renderReceipts(filtered);
        }
        
        // Reset receipt search
        function resetReceiptSearch() {
            document.getElementById('receipt-start-date').value = '';
            document.getElementById('receipt-end-date').value = '';
            document.getElementById('receipt-search-query').value = '';
            renderReceipts(savedReceipts);
        }
        
        // View a specific receipt
        function viewReceipt(receiptId) {
            const receipt = savedReceipts.find(r => r.id === receiptId);
            if (receipt) {
                // Convert back to Date object if it's a string
                if (typeof receipt.date === 'string') {
                    receipt.date = new Date(receipt.date);
                }
                showReceipt(receipt);
            }
        }
        
        // Download receipt as PDF
        async function downloadReceiptPDF(receiptId) {
            const receipt = savedReceipts.find(r => r.id === receiptId);
            if (!receipt) return;
            
            // Convert back to Date object if it's a string
            if (typeof receipt.date === 'string') {
                receipt.date = new Date(receipt.date);
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const dateStr = receipt.date.toLocaleDateString() + ' ' + 
                           receipt.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let y = 20;
            
            // Store info
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(receipt.storeName || adminConfig.storeName, 105, y, { align: 'center' });
            
            y += 7;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(receipt.storeAddress || adminConfig.storeAddress, 105, y, { align: 'center' });
            
            y += 5;
            doc.text(receipt.storePhone || adminConfig.storePhone, 105, y, { align: 'center' });
            
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('RECEIPT', 105, y, { align: 'center' });
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            doc.text(`Receipt #: ${receipt.id}`, 20, y);
            doc.text(`Date: ${dateStr}`, 20, y + 5);
            
            y += 15;
            
            // Items header
            doc.setFont('helvetica', 'bold');
            doc.text('Item', 20, y);
            doc.text('Price', 180, y, { align: 'right' });
            doc.line(20, y + 2, 190, y + 2);
            
            y += 7;
            doc.setFont('helvetica', 'normal');
            
            // Items
            receipt.items.forEach((item, index) => {
                const desc = `${item.artist || 'Unknown'} - ${item.title || 'Unknown'}`;
                const price = `$${(item.store_price || 0).toFixed(2)}`;
                
                // Handle long descriptions
                if (desc.length > 40) {
                    doc.text(desc.substring(0, 37) + '...', 20, y);
                } else {
                    doc.text(desc, 20, y);
                }
                doc.text(price, 180, y, { align: 'right' });
                
                y += 5;
                
                // Add new page if needed
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
            });
            
            y += 5;
            doc.line(20, y, 190, y);
            y += 5;
            
            // Summary
            doc.setFont('helvetica', 'bold');
            doc.text(`Subtotal: $${(receipt.subtotal || 0).toFixed(2)}`, 180, y, { align: 'right' });
            y += 5;
            doc.text(`Tax (${receipt.taxRate || adminConfig.taxRate}%): $${(receipt.tax || 0).toFixed(2)}`, 180, y, { align: 'right' });
            y += 5;
            doc.setFontSize(11);
            doc.text(`TOTAL: $${(receipt.total || 0).toFixed(2)}`, 180, y, { align: 'right' });
            
            y += 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`Payment Method: ${receipt.paymentMethod || 'Cash'}`, 20, y);
            y += 5;
            doc.text(`Tendered: $${(receipt.tendered || 0).toFixed(2)}`, 20, y);
            y += 5;
            doc.text(`Change: $${(receipt.change || 0).toFixed(2)}`, 20, y);
            
            y += 10;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'italic');
            doc.text(receipt.footer || adminConfig.receiptFooter, 105, y, { align: 'center' });
            
            // Save PDF
            doc.save(`${receipt.id}.pdf`);
        }
        
        // Print receipt
        function printReceipt(receiptId) {
            const receipt = savedReceipts.find(r => r.id === receiptId);
            if (receipt) {
                if (typeof receipt.date === 'string') {
                    receipt.date = new Date(receipt.date);
                }
                showReceipt(receipt);
                setTimeout(() => {
                    window.print();
                }, 500);
            }
        }
        
        // Helper functions
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // If switching to check out tab and no search has been performed yet, show empty state
            if (tabName === 'check-out') {
                const searchResults = document.getElementById('search-results');
                if (currentSearchResults.length === 0) {
                    searchResults.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 20px; color: #ccc;"></i>
                            <p>Enter a search term to find records</p>
                        </div>
                    `;
                }
                // Refresh terminals when switching to check out tab
                refreshTerminals();
            } else if (tabName === 'receipts') {
                // Refresh receipts display
                loadSavedReceipts();
                renderReceipts(savedReceipts);
            } else if (tabName === 'consignors') {
                // Load consignors when switching to that tab
                loadConsignors();
            }
        }
        
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        function showCheckoutStatus(message, type = 'info') {
            const statusEl = document.getElementById('checkout-status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showCheckoutLoading(show) {
            document.getElementById('checkout-loading').style.display = show ? 'block' : 'none';
        }
        
        function showReceiptsLoading(show) {
            document.getElementById('receipts-loading').style.display = show ? 'block' : 'none';
        }
        
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength - 1) + '' : text;
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (e) {
                return dateString.split('T')[0] || 'Unknown';
            }
        }
        
        function getStatusClass(statusId) {
            switch(statusId) {
                case 1: return 'condition-gplus';
                case 2: return 'condition-vgplus';
                case 3: return 'condition-mint';
                default: return 'condition-g';
            }
        }
        
        function getStatusText(statusId) {
            switch(statusId) {
                case 1: return 'Inactive';
                case 2: return 'Active';
                case 3: return 'Sold';
                default: return `Status ${statusId || '?'}`;
            }
        }
        
        function getStatusBadge(statusId) {
            switch(statusId) {
                case 1: return '<span class="inactive-badge">Inactive</span>';
                case 2: return '<span class="active-badge">Active</span>';
                case 3: return '<span class="sold-badge">Sold</span>';
                default: return '<span class="inactive-badge">Unknown</span>';
            }
        }
        
        function getStatusIdFromFilter(filterValue) {
            switch(filterValue) {
                case 'inactive': return 1;
                case 'active': return 2;
                case 'sold': return 3;
                default: return null;
            }
        }
        
        async function getConsignorInfo(consignorId) {
            if (!consignorId) return { username: 'None', initials: '' };
            
            if (consignorCache[consignorId]) {
                return consignorCache[consignorId];
            }
            
            try {
                const url = `${AppConfig.baseUrl}/users/${consignorId}`;
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        const user = data.user || {};
                        const consignorInfo = {
                            username: user.username || `User ${consignorId}`,
                            initials: user.initials || (user.username ? user.username.substring(0, 2).toUpperCase() : '')
                        };
                        consignorCache[consignorId] = consignorInfo;
                        return consignorInfo;
                    }
                }
            } catch (error) {
                console.log('Error fetching consignor:', error);
            }
            
            return { username: `User ${consignorId}`, initials: '' };
        }
        
        async function loadUsers() {
            try {
                const url = `${AppConfig.baseUrl}/users`;
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        const users = data.users || [];
                        const userSelect = $('#user-select');
                        userSelect.empty();
                        userSelect.append('<option value="all">All Users</option>');
                        
                        users.forEach(user => {
                            userSelect.append(`<option value="${user.id}">${user.username} (ID: ${user.id})</option>`);
                        });
                        
                        users.forEach(user => {
                            consignorCache[user.id] = {
                                username: user.username || `User ${user.id}`,
                                initials: user.initials || (user.username ? user.username.substring(0, 2).toUpperCase() : '')
                            };
                        });
                    }
                }
            } catch (error) {
                showStatus('Error loading users', 'error');
            }
        }
        
        async function loadRecords() {
            showLoading(true);
            
            try {
                const userSelect = document.getElementById('user-select');
                const selectedUserId = userSelect.value === 'all' ? null : userSelect.value;
                
                let url;
                if (selectedUserId) {
                    url = `${AppConfig.baseUrl}/records/user/${selectedUserId}`;
                } else {
                    url = `${AppConfig.baseUrl}/records`;
                }
                
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        allRecords = data.records || [];
                        
                        // Sort by created_at descending (newest first)
                        allRecords.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                        
                        // Update counts
                        document.getElementById('total-records').textContent = allRecords.length;
                        const inactiveCount = allRecords.filter(r => r.status_id === 1).length;
                        const activeCount = allRecords.filter(r => r.status_id === 2).length;
                        const soldCount = allRecords.filter(r => r.status_id === 3).length;
                        
                        document.getElementById('inactive-records').textContent = inactiveCount;
                        document.getElementById('active-records').textContent = activeCount;
                        document.getElementById('sold-records').textContent = soldCount;
                        
                        // Update batch size
                        const batchSizeInput = document.getElementById('batch-size');
                        batchSizeInput.max = inactiveCount;
                        batchSizeInput.value = Math.min(parseInt(batchSizeInput.value) || 10, inactiveCount);
                        
                        // Pre-fetch consignor data
                        const consignorIds = new Set();
                        allRecords.forEach(r => { if (r.consignor_id) consignorIds.add(r.consignor_id); });
                        const fetchPromises = Array.from(consignorIds).map(id => getConsignorInfo(id));
                        await Promise.all(fetchPromises);
                        
                        // Apply current filter
                        filterRecords();
                        
                        showStatus(`Loaded ${allRecords.length} records (${inactiveCount} inactive, ${activeCount} active, ${soldCount} sold)`, 'success');
                    }
                }
            } catch (error) {
                showStatus('Error loading records', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function filterRecords() {
            const statusFilter = document.getElementById('status-filter').value;
            const statusId = getStatusIdFromFilter(statusFilter);
            
            if (statusId) {
                filteredRecords = allRecords.filter(r => r.status_id === statusId);
            } else {
                filteredRecords = [...allRecords];
            }
            
            // Sort by created_at descending (newest first)
            filteredRecords.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Reset to first page when filtering
            currentPage = 1;
            updatePagination();
            renderCurrentPage();
            
            // Update status message
            const statusText = statusFilter === 'all' ? 'All records' : 
                              statusFilter === 'inactive' ? 'Inactive records' :
                              statusFilter === 'active' ? 'Active records' : 'Sold records';
            
            showStatus(`Showing ${filteredRecords.length} ${statusText}`, 'info');
        }
        
        function updatePagination() {
            totalPages = Math.ceil(filteredRecords.length / pageSize);
            if (totalPages === 0) totalPages = 1;
            
            // Update page controls
            document.getElementById('total-pages').textContent = totalPages;
            document.getElementById('current-page').value = currentPage;
            document.getElementById('total-filtered').textContent = filteredRecords.length;
            
            // Update button states
            document.getElementById('first-page-btn').disabled = currentPage === 1;
            document.getElementById('prev-page-btn').disabled = currentPage === 1;
            document.getElementById('next-page-btn').disabled = currentPage === totalPages;
            document.getElementById('last-page-btn').disabled = currentPage === totalPages;
            
            // Update showing info
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, filteredRecords.length);
            
            document.getElementById('showing-start').textContent = filteredRecords.length > 0 ? startIndex : 0;
            document.getElementById('showing-end').textContent = filteredRecords.length > 0 ? endIndex : 0;
            document.getElementById('total-filtered').textContent = filteredRecords.length;
            
            // Update selected count
            const selectedCount = window.selectedRecords ? window.selectedRecords.size : 0;
            document.getElementById('selected-count').textContent = selectedCount;
            
            // Update button states based on selection
            updateButtonStates();
        }
        
        function updateButtonStates() {
            const selectedCount = window.selectedRecords ? window.selectedRecords.size : 0;
            const hasSelection = selectedCount > 0;
            
            document.getElementById('print-btn').disabled = !hasSelection;
            document.getElementById('mark-active-btn').disabled = !hasSelection;
        }
        
        function renderCurrentPage() {
            const tbody = document.getElementById('records-body');
            tbody.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; padding: 20px; color: #666;">No records found</td></tr>`;
                updatePagination();
                return;
            }
            
            // Calculate slice for current page
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredRecords.length);
            const pageRecords = filteredRecords.slice(startIndex, endIndex);
            
            pageRecords.forEach((record, index) => {
                const globalIndex = startIndex + index;
                const consignorInfo = consignorCache[record.consignor_id] || { username: 'None', initials: '' };
                
                // Check if this record was recently printed
                const isRecentlyPrinted = recentlyPrintedIds.has(record.id.toString());
                
                const tr = document.createElement('tr');
                if (isRecentlyPrinted) {
                    tr.style.backgroundColor = '#f0fff0';
                    tr.style.borderLeft = '3px solid #27ae60';
                }
                
                tr.innerHTML = `
                    <td><input type="checkbox" class="record-checkbox" data-id="${record.id}" ${window.selectedRecords && window.selectedRecords.has(record.id.toString()) ? 'checked' : ''}></td>
                    <td>${globalIndex + 1}</td>
                    <td><strong>${formatDate(record.created_at)}</strong></td>
                    <td>${truncateText(record.artist || 'Unknown', 25)}</td>
                    <td>${truncateText(record.title || 'Unknown', 30)}</td>
                    <td>$${(record.store_price || 0).toFixed(2)}</td>
                    <td>${truncateText(record.catalog_number || 'N/A', 15)}</td>
                    <td>${truncateText(record.genre_name || record.genre || 'Unknown', 20)}</td>
                    <td>${record.barcode || 'N/A'}</td>
                    <td>
                        ${record.consignor_id ? 
                            `<span class="consignor-badge" title="${consignorInfo.username}">${consignorInfo.initials || consignorInfo.username.substring(0, 2)}</span>` : 
                            '<span style="color: #999;">None</span>'}
                    </td>
                    <td>
                        <span class="condition-badge ${getStatusClass(record.status_id)}">
                            ${getStatusText(record.status_id)}
                        </span>
                        ${isRecentlyPrinted ? '<br><small style="color: #27ae60; font-size: 10px;">(Printed)</small>' : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Add checkbox event listeners
            document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const recordId = this.getAttribute('data-id');
                    if (this.checked) {
                        window.selectedRecords.add(recordId);
                    } else {
                        window.selectedRecords.delete(recordId);
                    }
                    updateButtonStates();
                    updatePagination();
                });
            });
            
            // Select all checkbox
            const selectAllCheckbox = document.getElementById('select-all');
            selectAllCheckbox.checked = false;
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.record-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    const recordId = checkbox.getAttribute('data-id');
                    if (this.checked) {
                        window.selectedRecords.add(recordId);
                    } else {
                        window.selectedRecords.delete(recordId);
                    }
                });
                updateButtonStates();
                updatePagination();
            });
            
            updatePagination();
        }
        
        function goToPage(page) {
            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;
            
            currentPage = page;
            renderCurrentPage();
            updatePagination();
        }
        
        function goToFirstPage() {
            goToPage(1);
        }
        
        function goToPreviousPage() {
            goToPage(currentPage - 1);
        }
        
        function goToNextPage() {
            goToPage(currentPage + 1);
        }
        
        function goToLastPage() {
            goToPage(totalPages);
        }
        
        function changePageSize(newSize) {
            pageSize = newSize;
            currentPage = 1;
            updatePagination();
            renderCurrentPage();
        }
        
        function updateSelectionUI() {
            const count = window.selectedRecords ? window.selectedRecords.size : 0;
            document.getElementById('selected-tags').textContent = count;
            updateButtonStates();
        }
        
        function selectInactiveRecords() {
            // Get all inactive records from the current page
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredRecords.length);
            const pageRecords = filteredRecords.slice(startIndex, endIndex);
            
            let selectedCount = 0;
            
            pageRecords.forEach((record) => {
                if (record.status_id === 1) { // Inactive
                    const recordId = record.id.toString();
                    window.selectedRecords.add(recordId);
                    selectedCount++;
                }
            });
            
            // Re-render to update checkboxes
            renderCurrentPage();
            
            if (selectedCount > 0) {
                showStatus(`Selected ${selectedCount} inactive records on this page`, 'success');
            } else {
                showStatus('No inactive records on this page', 'info');
            }
        }
        
        function selectAllOnPage() {
            // Select all records on current page
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredRecords.length);
            const pageRecords = filteredRecords.slice(startIndex, endIndex);
            
            pageRecords.forEach((record) => {
                const recordId = record.id.toString();
                window.selectedRecords.add(recordId);
            });
            
            // Re-render to update checkboxes
            renderCurrentPage();
            
            showStatus(`Selected all ${pageRecords.length} records on this page`, 'success');
        }
        
        function clearSelection() {
            window.selectedRecords.clear();
            renderCurrentPage();
            showStatus('Selection cleared', 'info');
        }
        
        // Modal Functions
        function showPrintConfirmation() {
            const selectedIds = Array.from(window.selectedRecords);
            if (selectedIds.length === 0) {
                showStatus('No records selected for printing', 'error');
                return;
            }
            
            const selectedRecords = allRecords.filter(r => selectedIds.includes(r.id.toString()));
            const inactiveRecords = selectedRecords.filter(r => r.status_id === 1);
            const activeRecords = selectedRecords.filter(r => r.status_id === 2);
            const soldRecords = selectedRecords.filter(r => r.status_id === 3);
            
            // Update modal content
            document.getElementById('print-count').textContent = selectedRecords.length;
            
            const summaryList = document.getElementById('print-summary-list');
            summaryList.innerHTML = `
                <li>Total selected: ${selectedRecords.length} records</li>
                <li>Inactive records: ${inactiveRecords.length} (will be printed)</li>
                <li>Active records: ${activeRecords.length} (already active)</li>
                <li>Sold records: ${soldRecords.length} (won't be printed)</li>
            `;
            
            // Reset confirmation checkbox
            document.getElementById('print-confirmation-check').checked = false;
            document.getElementById('confirm-print-btn').disabled = true;
            
            // Show modal
            document.getElementById('print-confirmation-modal').style.display = 'flex';
            
            // Add event listener for confirmation checkbox
            document.getElementById('print-confirmation-check').addEventListener('change', function() {
                document.getElementById('confirm-print-btn').disabled = !this.checked;
            });
        }
        
        function closePrintConfirmation() {
            document.getElementById('print-confirmation-modal').style.display = 'none';
        }
        
        async function confirmPrint() {
            const selectedIds = Array.from(window.selectedRecords);
            const batchSize = parseInt(document.getElementById('batch-size').value) || 10;
            
            closePrintConfirmation();
            showLoading(true);
            
            // Get selected inactive records (already sorted by date)
            const selectedRecords = allRecords
                .filter(r => selectedIds.includes(r.id.toString()) && r.status_id === 1)
                .slice(0, batchSize);
                
            if (selectedRecords.length === 0) {
                showStatus('No inactive records selected', 'error');
                showLoading(false);
                return;
            }
            
            try {
                // Fetch configuration values
                await fetchConfigValues();
                
                // Generate PDF
                const pdfBlob = await generatePDF(selectedRecords);
                
                // Download PDF
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `price_tags_${new Date().toISOString().slice(0, 10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Add to recently printed set
                selectedRecords.forEach(record => {
                    recentlyPrintedIds.add(record.id.toString());
                });
                
                // Clear selection after successful print
                window.selectedRecords.clear();
                
                showStatus(`PDF generated for ${selectedRecords.length} records. Now mark them as Active.`, 'success');
                
                // Refresh the display to show "Printed" indicator
                renderCurrentPage();
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showStatus(`Error generating PDF: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function showMarkActiveConfirmation() {
            const selectedIds = Array.from(window.selectedRecords);
            if (selectedIds.length === 0) {
                showStatus('No records selected', 'error');
                return;
            }
            
            const selectedRecords = allRecords.filter(r => selectedIds.includes(r.id.toString()));
            const inactiveRecords = selectedRecords.filter(r => r.status_id === 1);
            const activeRecords = selectedRecords.filter(r => r.status_id === 2);
            const soldRecords = selectedRecords.filter(r => r.status_id === 3);
            
            // Update modal content
            document.getElementById('mark-active-count').textContent = selectedRecords.length;
            
            const summaryList = document.getElementById('mark-active-summary-list');
            summaryList.innerHTML = `
                <li>Total selected: ${selectedRecords.length} records</li>
                <li>Inactive records: ${inactiveRecords.length} (will be marked as Active)</li>
                <li>Active records: ${activeRecords.length} (already active - no change)</li>
                <li>Sold records: ${soldRecords.length} (won't be changed)</li>
            `;
            
            // Reset confirmation checkbox
            document.getElementById('mark-active-confirmation-check').checked = false;
            document.getElementById('confirm-mark-active-btn').disabled = true;
            
            // Show modal
            document.getElementById('mark-active-confirmation-modal').style.display = 'flex';
            
            // Add event listener for confirmation checkbox
            document.getElementById('mark-active-confirmation-check').addEventListener('change', function() {
                document.getElementById('confirm-mark-active-btn').disabled = !this.checked;
            });
        }
        
        function closeMarkActiveConfirmation() {
            document.getElementById('mark-active-confirmation-modal').style.display = 'none';
        }
        
        async function confirmMarkActive() {
            const selectedIds = Array.from(window.selectedRecords);
            
            closeMarkActiveConfirmation();
            showLoading(true);
            
            try {
                // Filter for inactive records only
                const inactiveRecordIds = selectedIds.filter(id => {
                    const record = allRecords.find(r => r.id.toString() === id);
                    return record && record.status_id === 1;
                });
                
                if (inactiveRecordIds.length === 0) {
                    showStatus('No inactive records to mark as active', 'info');
                    showLoading(false);
                    return;
                }
                
                // Update each record's status
                let successCount = 0;
                let errorCount = 0;
                
                for (const recordId of inactiveRecordIds) {
                    try {
                        const response = await fetch(`${AppConfig.baseUrl}/records/${recordId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                status_id: 2 // Active status
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.status === 'success') {
                                successCount++;
                                
                                // Update local record status
                                const recordIndex = allRecords.findIndex(r => r.id.toString() === recordId);
                                if (recordIndex !== -1) {
                                    allRecords[recordIndex].status_id = 2;
                                }
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error(`Error updating record ${recordId}:`, error);
                        errorCount++;
                    }
                }
                
                // Clear selection
                window.selectedRecords.clear();
                
                // Clear recently printed indicators for these records
                inactiveRecordIds.forEach(id => {
                    recentlyPrintedIds.delete(id);
                });
                
                // Refresh data
                await loadRecords();
                
                if (successCount > 0) {
                    showStatus(`Successfully marked ${successCount} records as Active${errorCount > 0 ? ` (${errorCount} failed)` : ''}`, 'success');
                } else {
                    showStatus(`Failed to mark records as Active: ${errorCount} errors`, 'error');
                }
                
            } catch (error) {
                console.error('Error marking records as active:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function generatePDF(records) {
            return new Promise(async (resolve) => {
                const { jsPDF } = window.jspdf;
                
                // Load configuration values
                const config = await fetchConfigValues();
                
                // Extract configuration values with defaults
                const labelWidthMM = config.LABEL_WIDTH_MM || 45.0;
                const labelHeightMM = config.LABEL_HEIGHT_MM || 16.8;
                const leftMarginMM = config.LEFT_MARGIN_MM || 6.5;
                const gutterSpacingMM = config.GUTTER_SPACING_MM || 6.5;
                const topMarginMM = config.TOP_MARGIN_MM || 14.0;
                const priceFontSize = config.PRICE_FONT_SIZE || 10;
                const textFontSize = config.TEXT_FONT_SIZE || 6;
                const barcodeHeightMM = config.BARCODE_HEIGHT || 6.0;
                const printBorders = config.PRINT_BORDERS === 'true' || config.PRINT_BORDERS === true;
                
                // Convert mm to points for jsPDF (1 mm = 2.83465 points)
                const mmToPt = 2.83465;
                const labelWidthPt = labelWidthMM * mmToPt;
                const labelHeightPt = labelHeightMM * mmToPt;
                const leftMarginPt = leftMarginMM * mmToPt;
                const gutterSpacingPt = gutterSpacingMM * mmToPt;
                const topMarginPt = topMarginMM * mmToPt;
                const barcodeHeightPt = barcodeHeightMM * mmToPt;
                
                const doc = new jsPDF({
                    unit: 'pt',
                    format: 'letter'
                });
                
                // Layout calculations
                const pageWidthPt = doc.internal.pageSize.getWidth();
                const pageHeightPt = doc.internal.pageSize.getHeight();
                const rows = 15;
                const cols = 4;
                const labelsPerPage = rows * cols;
                
                let currentLabel = 0;
                
                // Pre-fetch consignor data
                const consignorCache = {};
                const consignorIds = new Set();
                records.forEach(r => { 
                    if (r.consignor_id) consignorIds.add(r.consignor_id); 
                });
                
                // Fetch consignor data
                for (const consignorId of consignorIds) {
                    const consignorInfo = await getConsignorInfo(consignorId);
                    consignorCache[consignorId] = consignorInfo.initials || '';
                }
                
                // Generate labels
                for (const record of records) {
                    // Add new page if needed
                    if (currentLabel > 0 && currentLabel % labelsPerPage === 0) {
                        doc.addPage();
                    }
                    
                    // Calculate position
                    const pageIndex = currentLabel % labelsPerPage;
                    const row = Math.floor(pageIndex / cols);
                    const col = pageIndex % cols;
                    
                    const x = leftMarginPt + (col * (labelWidthPt + gutterSpacingPt));
                    const y = topMarginPt + (row * labelHeightPt);
                    
                    // Draw border if enabled
                    if (printBorders) {
                        doc.setDrawColor(0);
                        doc.setLineWidth(0.5);
                        doc.rect(x, y, labelWidthPt, labelHeightPt);
                    }
                    
                    // Get consignor initials
                    const consignorId = record.consignor_id;
                    const consignorInitials = consignorCache[consignorId] || '';
                    
                    // Draw price
                    const price = record.store_price || 0;
                    const priceText = `$${price.toFixed(2)}`;
                    doc.setFontSize(priceFontSize);
                    doc.setFont('helvetica', 'bold');
                    
                    const priceWidth = doc.getTextWidth(priceText);
                    const priceX = x + (labelWidthPt - priceWidth) / 2;
                    const priceY = y + labelHeightPt - (4 * mmToPt); // Position from top
                    
                    doc.text(priceText, priceX, priceY);
                    
                    // Draw artist, genre, and consignor initials
                    const artist = record.artist || 'Unknown';
                    const genre = record.genre_name || record.genre || 'Unknown';
                    
                    let infoText = genre;
                    if (artist !== 'Unknown') {
                        infoText += ` | ${artist}`;
                    }
                    if (consignorInitials) {
                        infoText += ` | (${consignorInitials})`;
                    }
                    
                    // Truncate if too long
                    const maxLength = 35;
                    if (infoText.length > maxLength) {
                        infoText = infoText.substring(0, maxLength - 1) + '';
                    }
                    
                    doc.setFontSize(textFontSize);
                    doc.setFont('helvetica', 'normal');
                    
                    const infoWidth = doc.getTextWidth(infoText);
                    const infoX = x + (labelWidthPt - infoWidth) / 2;
                    const infoY = priceY - (3 * mmToPt);
                    
                    doc.text(infoText, infoX, infoY);
                    
                    // Draw barcode if available
                    const barcodeNum = record.barcode;
                    if (barcodeNum) {
                        const canvas = document.createElement('canvas');
                        JsBarcode(canvas, barcodeNum, {
                            format: "CODE128",
                            displayValue: false,
                            height: 20,
                            margin: 0,
                            width: 2
                        });
                        
                        const barcodeData = canvas.toDataURL('image/png');
                        const barcodeX = x + (labelWidthPt - (25 * mmToPt)) / 2;
                        const barcodeY = y + (2 * mmToPt);
                        
                        doc.addImage(barcodeData, 'PNG', barcodeX, barcodeY, 25 * mmToPt, barcodeHeightPt);
                    }
                    
                    currentLabel++;
                }
                
                const pdfBlob = doc.output('blob');
                resolve(pdfBlob);
            });
        }
        
        // ============= TERMINAL MANAGEMENT FUNCTIONS =============
        
        async function refreshTerminals() {
            const terminalList = document.getElementById('terminal-list');
            terminalList.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading-spinner" style="width: 30px; height: 30px;"></div><p>Loading terminals...</p></div>';
            
            try {
                const response = await fetch(`${AppConfig.baseUrl}/api/square/terminals`, {
                    credentials: 'include'  // Important: include cookies/session
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Terminal fetch error:', response.status, errorText);
                    terminalList.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">
                        <i class="fas fa-exclamation-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>Error ${response.status}: ${response.statusText}</p>
                        <p style="font-size: 12px;">${errorText.substring(0, 100)}</p>
                    </div>`;
                    return;
                }
                
                const data = await response.json();
                if (data.status === 'success') {
                    availableTerminals = data.terminals || [];
                    renderTerminalList(availableTerminals);
                } else {
                    terminalList.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">
                        <i class="fas fa-exclamation-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p>Error: ${data.message || 'Unknown error'}</p>
                    </div>`;
                }
            } catch (error) {
                console.error('Error refreshing terminals:', error);
                terminalList.innerHTML = `<div style="text-align: center; padding: 20px; color: #dc3545;">
                    <i class="fas fa-exclamation-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
                    <p>Error: ${error.message}</p>
                </div>`;
            }
        }
        
        function renderTerminalList(terminals) {
            const terminalList = document.getElementById('terminal-list');
            
            if (terminals.length === 0) {
                terminalList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <i class="fas fa-square" style="font-size: 24px; margin-bottom: 10px; color: #ccc;"></i>
                        <p>No Square Terminals found</p>
                        <small>Make sure your terminal is registered and online</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            terminals.forEach(terminal => {
                const isOnline = terminal.status === 'ONLINE';
                const isSelected = selectedTerminalId === terminal.id;
                
                html += `
                    <div class="terminal-item ${isSelected ? 'selected' : ''}" onclick="selectTerminal('${terminal.id}')">
                        <div class="terminal-icon">
                            <i class="fas fa-square"></i>
                        </div>
                        <div class="terminal-details">
                            <div class="terminal-name">${terminal.device_name || 'Square Terminal'}</div>
                            <div class="terminal-id">ID: ${terminal.id}</div>
                        </div>
                        <div class="terminal-status ${isOnline ? 'online' : 'offline'}">
                            ${isOnline ? 'Online' : 'Offline'}
                        </div>
                    </div>
                `;
            });
            
            terminalList.innerHTML = html;
        }
        
        function selectTerminal(terminalId) {
            selectedTerminalId = terminalId;
            renderTerminalList(availableTerminals);
        }
        
        // ============= CHECK OUT FUNCTIONS =============
        
        async function searchRecords() {
            const query = document.getElementById('search-query').value.trim();
            if (!query) {
                showCheckoutStatus('Please enter a search term', 'error');
                return;
            }
            
            const activeOnly = document.getElementById('filter-active').checked;
            const barcodeOnly = document.getElementById('filter-barcode').checked;
            
            showCheckoutLoading(true);
            
            try {
                let url = `${AppConfig.baseUrl}/records/search?q=${encodeURIComponent(query)}`;
                
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        let results = data.records || [];
                        
                        // Apply filters
                        if (activeOnly) {
                            results = results.filter(r => r.status_id === 2); // Active only
                        }
                        
                        if (barcodeOnly) {
                            results = results.filter(r => r.barcode && r.barcode.toLowerCase().includes(query.toLowerCase()));
                        }
                        
                        currentSearchResults = results;
                        renderSearchResults(results);
                        
                        showCheckoutStatus(`Found ${results.length} records`, 'success');
                    }
                } else {
                    showCheckoutStatus('Error searching records', 'error');
                }
            } catch (error) {
                console.error('Search error:', error);
                showCheckoutStatus(`Search error: ${error.message}`, 'error');
            } finally {
                showCheckoutLoading(false);
            }
        }
        
        function renderSearchResults(results) {
            const container = document.getElementById('search-results');
            document.getElementById('search-result-count').textContent = results.length;
            document.getElementById('displayed-results').textContent = results.length;
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 20px; color: #ccc;"></i>
                        <p>No records found matching your search</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            results.forEach(record => {
                const consignorInfo = consignorCache[record.consignor_id] || { username: 'None', initials: '' };
                const inCart = checkoutCart.some(item => item.id === record.id);
                
                html += `
                    <div class="search-result-item">
                        <div class="result-details">
                            <div class="result-artist">${record.artist || 'Unknown Artist'}</div>
                            <div class="result-title">${record.title || 'Unknown Title'}</div>
                            <div class="result-meta">
                                <span class="result-catalog">${record.catalog_number || 'No catalog'}</span>
                                ${record.barcode ? `<span class="result-barcode"><i class="fas fa-barcode"></i> ${record.barcode}</span>` : ''}
                                <span>Status: ${getStatusText(record.status_id)}</span>
                                ${record.consignor_id ? `<span><i class="fas fa-user"></i> ${consignorInfo.username}</span>` : ''}
                            </div>
                        </div>
                        <div class="result-price">$${(record.store_price || 0).toFixed(2)}</div>
                        <div class="result-actions">
                            ${record.status_id === 3 ? 
                                '<span class="sold-badge"><i class="fas fa-check-circle"></i> Sold</span>' : 
                                record.status_id === 2 ?
                                (inCart ? 
                                    `<button class="btn btn-secondary btn-sm" onclick="removeFromCart(${record.id})">
                                        <i class="fas fa-minus"></i> Remove
                                    </button>` :
                                    `<button class="btn btn-cart btn-sm" onclick='addToCart(${JSON.stringify(record).replace(/'/g, "\\'")})'>
                                        <i class="fas fa-cart-plus"></i> Add to Cart
                                    </button>`
                                ) +
                                ` <button class="btn btn-square btn-sm" onclick='showTerminalSelection(${JSON.stringify(record).replace(/'/g, "\\'")})'>
                                    <i class="fas fa-square"></i> Square
                                </button>` :
                                '<span class="inactive-badge">Not Active</span>'
                            }
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Show/hide cart section based on cart contents
            updateCartDisplay();
        }
        
        // Shopping Cart Functions
        function addToCart(record) {
            // Check if already in cart
            if (checkoutCart.some(item => item.id === record.id)) {
                showCheckoutStatus('Item already in cart', 'info');
                return;
            }
            
            // Add to cart
            checkoutCart.push(record);
            updateCartDisplay();
            renderSearchResults(currentSearchResults); // Refresh search results to update button states
            showCheckoutStatus(`Added "${record.title}" to cart`, 'success');
        }
        
        function removeFromCart(recordId) {
            const recordIndex = checkoutCart.findIndex(item => item.id === recordId);
            if (recordIndex !== -1) {
                const removed = checkoutCart.splice(recordIndex, 1)[0];
                updateCartDisplay();
                renderSearchResults(currentSearchResults); // Refresh search results to update button states
                showCheckoutStatus(`Removed "${removed.title}" from cart`, 'info');
            }
        }
        
        function clearCart() {
            if (checkoutCart.length === 0) return;
            
            if (confirm('Are you sure you want to clear the cart?')) {
                checkoutCart = [];
                updateCartDisplay();
                renderSearchResults(currentSearchResults);
                showCheckoutStatus('Cart cleared', 'info');
            }
        }
        
        function updateCartDisplay() {
            const cartSection = document.getElementById('shopping-cart-section');
            const cartItems = document.getElementById('cart-items');
            const cartCount = document.getElementById('cart-item-count');
            const cartSubtotal = document.getElementById('cart-subtotal');
            const cartTax = document.getElementById('cart-tax');
            const cartTotal = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-cash-btn');
            
            if (checkoutCart.length === 0) {
                cartSection.style.display = 'none';
                checkoutBtn.disabled = true;
                return;
            }
            
            cartSection.style.display = 'block';
            cartCount.textContent = `${checkoutCart.length} item${checkoutCart.length !== 1 ? 's' : ''}`;
            
            // Calculate totals
            const subtotal = checkoutCart.reduce((sum, item) => sum + (parseFloat(item.store_price) || 0), 0);
            const taxRate = adminConfig.taxEnabled ? (adminConfig.taxRate / 100) : 0;
            const tax = subtotal * taxRate;
            const total = subtotal + tax;
            
            cartSubtotal.textContent = `$${subtotal.toFixed(2)}`;
            cartTax.textContent = `$${tax.toFixed(2)}`;
            cartTotal.textContent = `$${total.toFixed(2)}`;
            
            // Enable checkout button if cart has items
            checkoutBtn.disabled = false;
            
            // Render cart items
            let cartHtml = '';
            checkoutCart.forEach(item => {
                cartHtml += `
                    <div class="cart-item">
                        <div class="cart-item-details">
                            <div class="cart-item-artist">${item.artist || 'Unknown Artist'}</div>
                            <div class="cart-item-title">${item.title || 'Unknown Title'}</div>
                            <div class="cart-item-meta">${item.catalog_number || 'No catalog'}</div>
                        </div>
                        <div class="cart-item-price">$${(item.store_price || 0).toFixed(2)}</div>
                        <div class="cart-item-remove" onclick="removeFromCart(${item.id})">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                `;
            });
            
            cartItems.innerHTML = cartHtml;
        }
        
        // Tender Modal Functions
        function showTenderModal() {
            if (checkoutCart.length === 0) {
                showCheckoutStatus('Cart is empty', 'error');
                return;
            }
            
            // Calculate total
            const subtotal = checkoutCart.reduce((sum, item) => sum + (parseFloat(item.store_price) || 0), 0);
            const taxRate = adminConfig.taxEnabled ? (adminConfig.taxRate / 100) : 0;
            const tax = subtotal * taxRate;
            const total = subtotal + tax;
            
            document.getElementById('tender-total-due').textContent = `$${total.toFixed(2)}`;
            document.getElementById('tender-amount').value = '';
            document.getElementById('change-display-container').style.display = 'none';
            document.getElementById('complete-payment-btn').disabled = true;
            
            document.getElementById('tender-modal').style.display = 'flex';
            document.getElementById('tender-amount').focus();
            
            // Add input event listener for change calculation
            document.getElementById('tender-amount').addEventListener('input', function(e) {
                const tendered = parseFloat(e.target.value) || 0;
                const total = parseFloat(document.getElementById('tender-total-due').textContent.replace('$', ''));
                
                if (tendered >= total) {
                    const change = tendered - total;
                    document.getElementById('change-amount').textContent = `$${change.toFixed(2)}`;
                    document.getElementById('change-display-container').style.display = 'block';
                    document.getElementById('complete-payment-btn').disabled = false;
                } else {
                    document.getElementById('change-display-container').style.display = 'none';
                    document.getElementById('complete-payment-btn').disabled = true;
                }
            });
        }
        
        function closeTenderModal() {
            document.getElementById('tender-modal').style.display = 'none';
        }
        
        async function processCashPayment() {
            const tendered = parseFloat(document.getElementById('tender-amount').value) || 0;
            const subtotal = checkoutCart.reduce((sum, item) => sum + (parseFloat(item.store_price) || 0), 0);
            const taxRate = adminConfig.taxEnabled ? (adminConfig.taxRate / 100) : 0;
            const tax = subtotal * taxRate;
            const total = subtotal + tax;
            
            if (tendered < total) {
                showCheckoutStatus('Insufficient payment', 'error');
                return;
            }
            
            const change = tendered - total;
            
            closeTenderModal();
            showCheckoutLoading(true);
            
            try {
                // Mark all items in cart as sold and track consignor payments
                let successCount = 0;
                let errorCount = 0;
                const soldRecords = [];
                const consignorPayments = {}; // Track payments per consignor
                
                for (const record of checkoutCart) {
                    try {
                        const response = await fetch(`${AppConfig.baseUrl}/records/${record.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                status_id: 3 // Sold status
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.status === 'success') {
                                successCount++;
                                soldRecords.push(record);
                                
                                // Calculate consignor payment (if record has consignor)
                                if (record.consignor_id) {
                                    const commissionRate = (adminConfig.commissionRate || 10) / 100;
                                    const consignorShare = record.store_price * (1 - commissionRate);
                                    
                                    if (!consignorPayments[record.consignor_id]) {
                                        consignorPayments[record.consignor_id] = 0;
                                    }
                                    consignorPayments[record.consignor_id] += consignorShare;
                                }
                                
                                // Update local record status
                                const recordIndex = allRecords.findIndex(r => r.id === record.id);
                                if (recordIndex !== -1) {
                                    allRecords[recordIndex].status_id = 3;
                                }
                                
                                // Update in current search results
                                const searchIndex = currentSearchResults.findIndex(r => r.id === record.id);
                                if (searchIndex !== -1) {
                                    currentSearchResults[searchIndex].status_id = 3;
                                }
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error(`Error updating record ${record.id}:`, error);
                        errorCount++;
                    }
                }
                
                // Add consignor payments to localStorage
                if (Object.keys(consignorPayments).length > 0) {
                    let storedOwed = JSON.parse(localStorage.getItem('consignor_owed') || '{}');
                    for (const [consignorId, amount] of Object.entries(consignorPayments)) {
                        storedOwed[consignorId] = (storedOwed[consignorId] || 0) + amount;
                    }
                    localStorage.setItem('consignor_owed', JSON.stringify(storedOwed));
                    
                    // Update consignorOwedAmounts global
                    consignorOwedAmounts = storedOwed;
                }
                
                if (successCount > 0) {
                    // Get cashier name from user data if available
                    let cashierName = 'Admin';
                    try {
                        const userData = localStorage.getItem('user');
                        if (userData) {
                            const user = JSON.parse(userData);
                            cashierName = user.username || 'Admin';
                        }
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                    
                    // Create transaction object for receipt
                    const transaction = {
                        id: `CASH-${Date.now()}`,
                        date: new Date(),
                        items: [...soldRecords],
                        subtotal: subtotal,
                        tax: tax,
                        taxRate: adminConfig.taxRate,
                        total: total,
                        tendered: tendered,
                        change: change,
                        paymentMethod: 'Cash',
                        cashier: cashierName,
                        storeName: adminConfig.storeName,
                        storeAddress: adminConfig.storeAddress,
                        storePhone: adminConfig.storePhone,
                        footer: adminConfig.receiptFooter,
                        consignorPayments: consignorPayments // Store payment breakdown
                    };
                    
                    // Save receipt to localStorage
                    saveReceipt(transaction);
                    
                    // Show receipt
                    showReceipt(transaction);
                    
                    // Clear cart
                    checkoutCart = [];
                    updateCartDisplay();
                    
                    // Refresh search results
                    renderSearchResults(currentSearchResults);
                    
                    showCheckoutStatus(`Successfully sold ${successCount} items${errorCount > 0 ? ` (${errorCount} failed)` : ''}`, 'success');
                } else {
                    showCheckoutStatus(`Failed to process sale: ${errorCount} errors`, 'error');
                }
                
            } catch (error) {
                console.error('Error processing cash payment:', error);
                showCheckoutStatus(`Error: ${error.message}`, 'error');
            } finally {
                showCheckoutLoading(false);
            }
        }
        
        // Receipt Functions
        function showReceipt(transaction) {
            const receiptContent = document.getElementById('receipt-content');
            
            const dateStr = transaction.date.toLocaleDateString() + ' ' + 
                           transaction.date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            let itemsHtml = '';
            transaction.items.forEach(item => {
                itemsHtml += `
                    <div class="receipt-item">
                        <div class="receipt-item-desc">${item.artist || 'Unknown'} - ${item.title || 'Unknown'}</div>
                        <div class="receipt-item-price">$${(item.store_price || 0).toFixed(2)}</div>
                    </div>
                `;
            });
            
            receiptContent.innerHTML = `
                <div class="receipt-header">
                    <div class="receipt-store-name">${transaction.storeName || adminConfig.storeName}</div>
                    <div class="receipt-store-info">${transaction.storeAddress || adminConfig.storeAddress}</div>
                    <div class="receipt-store-info">${transaction.storePhone || adminConfig.storePhone}</div>
                </div>
                
                <div class="receipt-transaction-info">
                    <div>Receipt #: ${transaction.id}</div>
                    <div>Date: ${dateStr}</div>
                    <div>Cashier: ${transaction.cashier || 'Admin'}</div>
                </div>
                
                <div class="receipt-items">
                    ${itemsHtml}
                </div>
                
                <div class="receipt-summary">
                    <div class="receipt-summary-row">
                        <span>Subtotal:</span>
                        <span>$${(transaction.subtotal || 0).toFixed(2)}</span>
                    </div>
                    <div class="receipt-summary-row">
                        <span>Tax (${transaction.taxRate || adminConfig.taxRate}%):</span>
                        <span>$${(transaction.tax || 0).toFixed(2)}</span>
                    </div>
                    <div class="receipt-summary-row receipt-total">
                        <span>TOTAL:</span>
                        <span>$${(transaction.total || 0).toFixed(2)}</span>
                    </div>
                </div>
                
                <div class="receipt-payment">
                    <div class="receipt-summary-row">
                        <span>Tendered:</span>
                        <span>$${(transaction.tendered || 0).toFixed(2)}</span>
                    </div>
                    <div class="receipt-summary-row">
                        <span>Change:</span>
                        <span>$${(transaction.change || 0).toFixed(2)}</span>
                    </div>
                </div>
                
                <div class="receipt-footer">
                    ${transaction.footer || adminConfig.receiptFooter}
                </div>
                
                <div class="receipt-actions">
                    <button class="btn btn-primary btn-sm" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Receipt
                    </button>
                    <button class="btn btn-success btn-sm" onclick="downloadCurrentReceiptPDF()">
                        <i class="fas fa-download"></i> Save PDF
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="closeReceipt()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;
            
            document.getElementById('receipt-modal').style.display = 'flex';
            
            // Auto-print if configured
            if (adminConfig.autoPrintReceipt) {
                setTimeout(() => {
                    window.print();
                }, 500);
            }
        }
        
        function closeReceipt() {
            document.getElementById('receipt-modal').style.display = 'none';
        }
        
        function downloadCurrentReceiptPDF() {
            // Get the current receipt from the modal
            const receiptId = document.querySelector('.receipt-transaction-info div:first-child').textContent.replace('Receipt #: ', '');
            downloadReceiptPDF(receiptId);
        }
        
        function showTerminalSelection(record) {
            if (availableTerminals.length === 0) {
                showCheckoutStatus('No Square Terminals available. Please check terminal status.', 'error');
                return;
            }
            
            // Filter online terminals
            const onlineTerminals = availableTerminals.filter(t => t.status === 'ONLINE');
            if (onlineTerminals.length === 0) {
                showCheckoutStatus('No online terminals available. Please check terminal connection.', 'error');
                return;
            }
            
            window.pendingTerminalSale = record;
            
            // Render terminal selection
            const selectionList = document.getElementById('terminal-selection-list');
            let html = '<h4>Select Terminal</h4>';
            
            onlineTerminals.forEach(terminal => {
                html += `
                    <div class="terminal-device" onclick="selectTerminalForCheckout('${terminal.id}')">
                        <input type="radio" name="terminal" value="${terminal.id}" ${selectedTerminalId === terminal.id ? 'checked' : ''}>
                        <div class="terminal-device-info">
                            <div class="terminal-device-name">${terminal.device_name || 'Square Terminal'}</div>
                            <div class="terminal-device-status online">Online</div>
                        </div>
                    </div>
                `;
            });
            
            selectionList.innerHTML = html;
            
            // Enable confirm button if a terminal is already selected
            if (selectedTerminalId && onlineTerminals.some(t => t.id === selectedTerminalId)) {
                document.getElementById('confirm-terminal-btn').disabled = false;
            } else {
                document.getElementById('confirm-terminal-btn').disabled = true;
            }
            
            document.getElementById('terminal-selection-modal').style.display = 'flex';
        }
        
        function selectTerminalForCheckout(terminalId) {
            selectedTerminalId = terminalId;
            
            // Update radio buttons
            document.querySelectorAll('input[name="terminal"]').forEach(radio => {
                radio.checked = radio.value === terminalId;
            });
            
            document.getElementById('confirm-terminal-btn').disabled = false;
        }
        
        function closeTerminalSelectionModal() {
            document.getElementById('terminal-selection-modal').style.display = 'none';
            window.pendingTerminalSale = null;
        }
        
        async function initiateTerminalCheckout() {
            if (!window.pendingTerminalSale) {
                showCheckoutStatus('No record selected for checkout', 'error');
                closeTerminalSelectionModal();
                return;
            }
            
            if (!selectedTerminalId) {
                showCheckoutStatus('Please select a terminal', 'error');
                return;
            }
            
            const record = window.pendingTerminalSale;
            const amountCents = Math.round(record.store_price * 100);
            const recordIds = [record.id];
            const recordTitles = [record.title];
            
            closeTerminalSelectionModal();
            
            // Show processing modal
            const modalBody = document.getElementById('terminal-checkout-body');
            modalBody.innerHTML = `
                <div class="payment-status">
                    <div class="payment-status-icon processing">
                        <i class="fas fa-spinner fa-pulse"></i>
                    </div>
                    <div class="payment-status-message">Creating Terminal Checkout...</div>
                    <div class="payment-status-detail">Please wait while we prepare the terminal</div>
                    <div class="payment-progress">
                        <div class="payment-progress-bar" style="animation: progress 30s linear;"></div>
                    </div>
                </div>
            `;
            document.getElementById('terminal-checkout-modal').style.display = 'flex';
            
            try {
                // Create terminal checkout
                const response = await fetch(`${AppConfig.baseUrl}/square/terminal/checkout`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount_cents: amountCents,
                        record_ids: recordIds,
                        record_titles: recordTitles,
                        device_id: selectedTerminalId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const checkout = data.checkout;
                    activeCheckoutId = checkout.id;
                    
                    // Update modal to show waiting for payment
                    modalBody.innerHTML = `
                        <div class="payment-status">
                            <div class="payment-status-icon processing">
                                <i class="fas fa-credit-card fa-pulse"></i>
                            </div>
                            <div class="payment-status-message">Waiting for payment on terminal</div>
                            <div class="payment-status-detail">Amount: $${(amountCents / 100).toFixed(2)}</div>
                            <div class="payment-status-detail">Please present card to the terminal</div>
                            <div class="payment-progress">
                                <div class="payment-progress-bar" style="animation: progress 30s linear;"></div>
                            </div>
                            <button class="btn btn-warning" onclick="cancelTerminalCheckout()" style="margin-top: 20px;">
                                <i class="fas fa-times"></i> Cancel Payment
                            </button>
                        </div>
                    `;
                    
                    // Start polling for status
                    startCheckoutPolling(checkout.id, record);
                    
                } else {
                    throw new Error(data.message || 'Failed to create checkout');
                }
                
            } catch (error) {
                console.error('Error creating terminal checkout:', error);
                modalBody.innerHTML = `
                    <div class="payment-status">
                        <div class="payment-status-icon error">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="payment-status-message">Checkout Failed</div>
                        <div class="payment-status-detail">${error.message}</div>
                        <button class="btn btn-primary" onclick="closeTerminalCheckoutModal()" style="margin-top: 20px;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                `;
            }
        }
        
        function startCheckoutPolling(checkoutId, record) {
            // Clear any existing interval
            if (checkoutPollInterval) {
                clearInterval(checkoutPollInterval);
            }
            
            let pollCount = 0;
            const maxPolls = 60; // Poll for 5 minutes (5 seconds * 60)
            
            checkoutPollInterval = setInterval(async () => {
                pollCount++;
                
                try {
                    const response = await fetch(`${AppConfig.baseUrl}/square/terminal/checkout/${checkoutId}/status`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        const checkout = data.checkout;
                        const checkoutStatus = checkout.status;
                        
                        // Update based on status
                        if (checkoutStatus === 'COMPLETED') {
                            // Payment successful
                            clearInterval(checkoutPollInterval);
                            
                            // Mark record as sold
                            await markRecordAsSold(record.id);
                            
                            const modalBody = document.getElementById('terminal-checkout-body');
                            modalBody.innerHTML = `
                                <div class="payment-status">
                                    <div class="payment-status-icon success">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="payment-status-message">Payment Successful!</div>
                                    <div class="payment-status-detail">Amount: $${(record.store_price).toFixed(2)}</div>
                                    <div class="payment-status-detail">Thank you for your purchase</div>
                                    <button class="btn btn-success" onclick="closeTerminalCheckoutModal()" style="margin-top: 20px;">
                                        <i class="fas fa-check"></i> Done
                                    </button>
                                </div>
                            `;
                            
                            // Refresh search results
                            const searchIndex = currentSearchResults.findIndex(r => r.id === record.id);
                            if (searchIndex !== -1) {
                                currentSearchResults[searchIndex].status_id = 3;
                                renderSearchResults(currentSearchResults);
                            }
                            
                            showCheckoutStatus('Payment completed successfully!', 'success');
                            
                        } else if (checkoutStatus === 'CANCELED' || checkoutStatus === 'FAILED') {
                            // Payment failed or cancelled
                            clearInterval(checkoutPollInterval);
                            
                            const modalBody = document.getElementById('terminal-checkout-body');
                            modalBody.innerHTML = `
                                <div class="payment-status">
                                    <div class="payment-status-icon error">
                                        <i class="fas fa-times-circle"></i>
                                    </div>
                                    <div class="payment-status-message">Payment ${checkoutStatus}</div>
                                    <div class="payment-status-detail">The transaction was ${checkoutStatus.toLowerCase()}</div>
                                    <button class="btn btn-primary" onclick="closeTerminalCheckoutModal()" style="margin-top: 20px;">
                                        <i class="fas fa-times"></i> Close
                                    </button>
                                </div>
                            `;
                            
                            showCheckoutStatus(`Payment ${checkoutStatus.toLowerCase()}`, 'error');
                        }
                        
                        // Stop polling after max attempts
                        if (pollCount >= maxPolls) {
                            clearInterval(checkoutPollInterval);
                            
                            const modalBody = document.getElementById('terminal-checkout-body');
                            modalBody.innerHTML = `
                                <div class="payment-status">
                                    <div class="payment-status-icon error">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="payment-status-message">Checkout Timed Out</div>
                                    <div class="payment-status-detail">The terminal did not respond in time</div>
                                    <button class="btn btn-primary" onclick="closeTerminalCheckoutModal()" style="margin-top: 20px;">
                                        <i class="fas fa-times"></i> Close
                                    </button>
                                </div>
                            `;
                        }
                    }
                    
                } catch (error) {
                    console.error('Error polling checkout status:', error);
                }
                
            }, 5000); // Poll every 5 seconds
        }
        
        async function cancelTerminalCheckout() {
            if (!activeCheckoutId) return;
            
            try {
                const response = await fetch(`${AppConfig.baseUrl}/square/terminal/checkout/${activeCheckoutId}/cancel`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        showCheckoutStatus('Checkout cancelled', 'info');
                        
                        const modalBody = document.getElementById('terminal-checkout-body');
                        modalBody.innerHTML = `
                            <div class="payment-status">
                                <div class="payment-status-icon error">
                                    <i class="fas fa-ban"></i>
                                </div>
                                <div class="payment-status-message">Checkout Cancelled</div>
                                <button class="btn btn-primary" onclick="closeTerminalCheckoutModal()" style="margin-top: 20px;">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error cancelling checkout:', error);
            } finally {
                if (checkoutPollInterval) {
                    clearInterval(checkoutPollInterval);
                }
                activeCheckoutId = null;
            }
        }
        
        async function markRecordAsSold(recordId) {
            try {
                const response = await fetch(`${AppConfig.baseUrl}/records/${recordId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        status_id: 3 // Sold status
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        // Update local record status
                        const recordIndex = allRecords.findIndex(r => r.id === recordId);
                        if (recordIndex !== -1) {
                            allRecords[recordIndex].status_id = 3;
                        }
                    }
                }
            } catch (error) {
                console.error('Error marking record as sold:', error);
            }
        }
        
        function closeTerminalCheckoutModal() {
            document.getElementById('terminal-checkout-modal').style.display = 'none';
            if (checkoutPollInterval) {
                clearInterval(checkoutPollInterval);
                checkoutPollInterval = null;
            }
            activeCheckoutId = null;
        }
        
        // ========== CONSIGNOR MANAGEMENT FUNCTIONS ==========
        async function loadConsignors() {
            const tbody = document.getElementById('consignors-body');
            const loading = document.getElementById('consignors-loading');
            loading.style.display = 'block';
            try {
                const url = `${AppConfig.baseUrl}/users`;
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    let users = data.users || [];
                    
                    // Get owed amounts from localStorage
                    let storedOwed = JSON.parse(localStorage.getItem('consignor_owed') || '{}');
                    consignorOwedAmounts = storedOwed;
                    
                    // Get total admin commission from all sales
                    let totalAdminCommission = 0;
                    savedReceipts.forEach(receipt => {
                        if (receipt.consignorPayments) {
                            // Admin commission is the difference between sale price and consignor payment
                            receipt.items.forEach(item => {
                                if (item.consignor_id) {
                                    const commissionRate = (adminConfig.commissionRate || 10) / 100;
                                    totalAdminCommission += item.store_price * commissionRate;
                                }
                            });
                        }
                    });
                    
                    consignorsList = users.map(u => ({
                        id: u.id,
                        username: u.username || 'Unknown',
                        initials: u.initials || (u.username ? u.username.substring(0,2).toUpperCase() : '??'),
                        owed: storedOwed[u.id] || 0,
                        recordsSold: allRecords.filter(r => r.consignor_id == u.id && r.status_id === 3).length
                    }));
                    
                    renderConsignors(consignorsList);
                    updateConsignorStats(totalAdminCommission);
                } else {
                    tbody.innerHTML = `<tr><td colspan="6" style="color:red;">Error loading users</td></tr>`;
                }
            } catch (e) {
                console.error('loadConsignors error', e);
                tbody.innerHTML = `<tr><td colspan="6" style="color:red;">${e.message}</td></tr>`;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        function renderConsignors(consignors) {
            const tbody = document.getElementById('consignors-body');
            if (!consignors.length) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No consignors found</td></tr>`;
                return;
            }
            let html = '';
            consignors.forEach(c => {
                html += `<tr>
                    <td>${c.id}</td>
                    <td>${c.username}</td>
                    <td>${c.initials}</td>
                    <td>$${c.owed.toFixed(2)}</td>
                    <td>${c.recordsSold}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="showPaymentModal('${c.id}', '${c.username}', ${c.owed})">
                            <i class="fas fa-dollar-sign"></i> Clear
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteConsignor('${c.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }
        
        function updateConsignorStats(totalAdminCommission) {
            document.getElementById('total-consignors').textContent = consignorsList.length;
            const totalOwed = consignorsList.reduce((acc, c) => acc + (c.owed || 0), 0);
            document.getElementById('total-credit').textContent = `$${totalOwed.toFixed(2)}`;
            document.getElementById('admin-total-commission').textContent = `$${totalAdminCommission.toFixed(2)}`;
        }
        
        let currentPaymentUserId = null;
        let currentPaymentAmount = 0;
        
        function showPaymentModal(userId, username, amount) {
            if (amount <= 0) {
                alert('This consignor has no owed amount to clear.');
                return;
            }
            currentPaymentUserId = userId;
            currentPaymentAmount = amount;
            document.getElementById('payment-consignor-name').textContent = username;
            document.getElementById('payment-amount').textContent = `$${amount.toFixed(2)}`;
            document.getElementById('payment-modal').style.display = 'flex';
        }
        
        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
            currentPaymentUserId = null;
            currentPaymentAmount = 0;
        }
        
        async function processPayment() {
            if (!currentPaymentUserId) return;
            
            // Update localStorage to clear the owed amount
            let storedOwed = JSON.parse(localStorage.getItem('consignor_owed') || '{}');
            delete storedOwed[currentPaymentUserId];
            localStorage.setItem('consignor_owed', JSON.stringify(storedOwed));
            
            // Update local data
            consignorOwedAmounts = storedOwed;
            const consignor = consignorsList.find(c => c.id == currentPaymentUserId);
            if (consignor) {
                consignor.owed = 0;
            }
            
            renderConsignors(consignorsList);
            
            // Recalculate admin commission total
            let totalAdminCommission = 0;
            savedReceipts.forEach(receipt => {
                if (receipt.consignorPayments) {
                    receipt.items.forEach(item => {
                        if (item.consignor_id) {
                            const commissionRate = (adminConfig.commissionRate || 10) / 100;
                            totalAdminCommission += item.store_price * commissionRate;
                        }
                    });
                }
            });
            updateConsignorStats(totalAdminCommission);
            
            closePaymentModal();
            showStatus(`Payment cleared for ${consignor?.username}`, 'success');
        }
        
        async function deleteConsignor(userId) {
            if (!confirm('Are you sure you want to delete this consignor? This action cannot be undone.')) return;
            
            // Check if consignor has any records
            const hasRecords = allRecords.some(r => r.consignor_id == userId);
            if (hasRecords) {
                alert('Cannot delete consignor with existing records. Please reassign or delete records first.');
                return;
            }
            
            const loading = document.getElementById('consignors-loading');
            loading.style.display = 'block';
            try {
                // Since we're using mock/localStorage for users, we'll simulate deletion
                // In a real app, you'd call the API
                consignorsList = consignorsList.filter(c => c.id != userId);
                renderConsignors(consignorsList);
                
                // Remove from owed amounts if present
                let storedOwed = JSON.parse(localStorage.getItem('consignor_owed') || '{}');
                delete storedOwed[userId];
                localStorage.setItem('consignor_owed', JSON.stringify(storedOwed));
                
                updateConsignorStats(0);
                showStatus('Consignor deleted', 'success');
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            const userData = localStorage.getItem('user');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    if (user.role !== 'admin') {
                        window.location.href = '/';
                        return;
                    }
                } catch {
                    window.location.href = '/';
                    return;
                }
            } else {
                window.location.href = '/';
                return;
            }
            
            // Initialize selected records set
            window.selectedRecords = new Set();
            
            // Load admin config
            loadAdminConfig();
            
            // Load saved receipts
            loadSavedReceipts();
            
            // Fetch configuration values first
            await fetchConfigValues();
            
            // Initialize UI components
            $('#user-select').select2({
                placeholder: "Select a user...",
                allowClear: true
            }).on('change', loadRecords);
            
            // Load data
            loadUsers();
            loadRecords();
            refreshTerminals(); // Load terminals on startup
            
            // Set up search on enter key
            document.getElementById('search-query').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchRecords();
                }
            });
            
            // Set today's date as default for receipt search
            const today = new Date().toISOString().split('T')[0];
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('receipt-start-date').value = thirtyDaysAgo;
            document.getElementById('receipt-end-date').value = today;
        });
    </script>
</body>
</html>