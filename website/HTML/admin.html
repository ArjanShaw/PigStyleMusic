<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - PigStyle Music</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/admin.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="/static/js/app-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <style>
        body, .admin-container, .tab-content, .config-section, 
        .stat-card, .stat-card h3, .stat-number,
        .records-table, .records-table th, .records-table td,
        .input-group label, .status-message,
        .btn, .expandable-header, .code-block,
        .tooltip, .tooltip-text, 
        .page-layout-preview, .preview-label,
        .tag-preview, .tag-preview-content,
        .tag-price, .tag-info, .tag-initials {
            color: #000000 !important;
        }
        
        .status-success { color: #155724 !important; }
        .status-error { color: #721c24 !important; }
        .status-info { color: #0c5460 !important; }
        
        .records-table th { color: #000000 !important; }
        .records-table td { color: #333333 !important; }
        
        .btn-primary, .btn-success, .btn-secondary, .btn-warning {
            color: #ffffff !important;
        }
        
        .btn-primary:hover, .btn-success:hover, .btn-secondary:hover, .btn-warning:hover {
            color: #ffffff !important;
        }
        
        .btn:disabled {
            color: #666666 !important;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            color: #000000;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            font-weight: 500;
            color: #000000;
        }
        
        .tab.active {
            background: #3498db;
            color: #ffffff !important;
            border-color: #3498db;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 0 0 8px 8px;
            color: #000000;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .records-table-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 20px 0;
        }
        
        .records-table {
            width: 100%;
            border-collapse: collapse;
            color: #000000;
        }
        
        .records-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
            position: sticky;
            top: 0;
            font-size: 14px;
            color: #000000 !important;
        }
        
        .records-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            color: #333333 !important;
        }
        
        .records-table tr:hover {
            background: #f9f9f9;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            color: #666666 !important;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            text-align: center;
            color: #000000;
        }
        
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666666 !important;
            font-size: 14px;
            font-weight: 600;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50 !important;
            margin: 0;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724 !important;
            border: 1px solid #c3e6cb;
            display: block;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24 !important;
            border: 1px solid #f5c6cb;
            display: block;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460 !important;
            border: 1px solid #bee5eb;
            display: block;
        }
        
        .select2-container {
            width: 100% !important;
        }
        
        .select2-selection {
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            min-height: 38px !important;
            color: #000000;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #000000 !important;
        }
        
        .input-group small {
            display: block;
            margin-top: 5px;
            color: #666666;
            font-size: 12px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .condition-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            color: #ffffff !important;
        }
        
        .condition-mint { background: #4CAF50; }
        .condition-nm { background: #8BC34A; }
        .condition-vgplus { background: #FFC107; color: #333333 !important; }
        .condition-vg { background: #FF9800; }
        .condition-gplus { background: #FF5722; }
        .condition-g { background: #795548; }
        
        .consignor-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            background: #6c757d;
            color: #ffffff !important;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            min-width: 150px;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 10px;
        }
        
        .pagination-info {
            font-size: 14px;
            color: #666;
            margin: 0 10px;
        }
        
        .page-btn {
            padding: 8px 16px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .page-btn:hover:not(:disabled) {
            background: #e9e9e9;
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-input {
            width: 60px;
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .records-per-page {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        .records-per-page select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
        }
        
        /* Confirmation Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: #000000;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .print-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .print-summary h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .print-summary ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .print-summary li {
            margin-bottom: 5px;
        }
        
        .confirmation-check {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 4px;
        }
        
        .confirmation-check input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        .confirmation-check label {
            font-weight: 500;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="/">PigStyle Music</a>
        </div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/catalog">Catalog</a>
            <a href="/streaming">Streaming</a>
            <a href="/consignment">Consignment</a>
            <a href="/dashboard">Dashboard</a>
            <div id="auth-section">
                <!-- Populated by app-config.js -->
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <h1><i class="fas fa-cogs"></i> Admin Panel</h1>
        
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('price-tags')">
                <i class="fas fa-tags"></i> Print Price Tags
            </div>
        </div>
        
        <!-- Price Tags Tab -->
        <div id="price-tags-tab" class="tab-content active">
            <h2><i class="fas fa-tags"></i> Print Price Tags</h2>
            
            <!-- Filter Controls -->
            <div class="filter-controls">
                <!-- User Selection -->
                <div class="filter-group">
                    <label for="user-select"><i class="fas fa-user"></i> Select User:</label>
                    <select id="user-select" class="select2 filter-select" style="width: 250px;">
                        <option value="all">All Users</option>
                    </select>
                </div>
                
                <!-- Status Filter -->
                <div class="filter-group">
                    <label for="status-filter"><i class="fas fa-filter"></i> Filter by Status:</label>
                    <select id="status-filter" class="filter-select" onchange="filterRecords()">
                        <option value="all">All Statuses</option>
                        <option value="inactive">Inactive Only</option>
                        <option value="active">Active Only</option>
                        <option value="sold">Sold Only</option>
                    </select>
                </div>
                
                <!-- Refresh Button -->
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="loadRecords()" style="height: 38px;">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <!-- Records Section -->
            <div id="records-section">
                <h3><i class="fas fa-list"></i> Records</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Records</h3>
                        <p class="stat-number" id="total-records">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Inactive Records</h3>
                        <p class="stat-number" id="inactive-records">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Active Records</h3>
                        <p class="stat-number" id="active-records">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Sold Records</h3>
                        <p class="stat-number" id="sold-records">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Selected Tags</h3>
                        <p class="stat-number" id="selected-tags">0</p>
                    </div>
                </div>
                
                <!-- Batch Size Input -->
                <div class="input-group">
                    <label for="batch-size"><i class="fas fa-sort-numeric-down"></i> Number of tags to print:</label>
                    <input type="number" id="batch-size" min="1" value="10" style="width: 200px; padding: 8px;">
                    <small>Most recent inactive records will be selected (sorted by creation date descending)</small>
                </div>
                
                <!-- Pagination Controls -->
                <div class="pagination" id="pagination-controls">
                    <button class="page-btn" onclick="goToFirstPage()" id="first-page-btn" disabled>
                        <i class="fas fa-angle-double-left"></i>
                    </button>
                    <button class="page-btn" onclick="goToPreviousPage()" id="prev-page-btn" disabled>
                        <i class="fas fa-angle-left"></i>
                    </button>
                    
                    <span class="pagination-info">
                        Page <input type="number" class="page-input" id="current-page" min="1" value="1" 
                               onchange="goToPage(parseInt(this.value))" onblur="goToPage(parseInt(this.value))"> 
                        of <span id="total-pages">1</span>
                    </span>
                    
                    <button class="page-btn" onclick="goToNextPage()" id="next-page-btn" disabled>
                        <i class="fas fa-angle-right"></i>
                    </button>
                    <button class="page-btn" onclick="goToLastPage()" id="last-page-btn" disabled>
                        <i class="fas fa-angle-double-right"></i>
                    </button>
                    
                    <div class="records-per-page">
                        <span>Show:</span>
                        <select id="page-size" onchange="changePageSize(parseInt(this.value))">
                            <option value="50">50</option>
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                        <span>records per page</span>
                    </div>
                </div>
                
                <!-- Records Table -->
                <div class="records-table-container">
                    <table class="records-table" id="records-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all"></th>
                                <th>#</th>
                                <th>Created Date <i class="fas fa-sort-down"></i></th>
                                <th>Artist</th>
                                <th>Title</th>
                                <th>Price</th>
                                <th>Catalog #</th>
                                <th>Genre</th>
                                <th>Barcode</th>
                                <th>Consignor</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="records-body">
                            <!-- Records will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Footer -->
                <div class="pagination" id="pagination-footer">
                    <span class="pagination-info">
                        Showing <span id="showing-start">0</span>-<span id="showing-end">0</span> 
                        of <span id="total-filtered">0</span> records
                        (<span id="selected-count">0</span> selected)
                    </span>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="loadRecords()">
                        <i class="fas fa-sync-alt"></i> Refresh Records
                    </button>
                    <button class="btn btn-success" onclick="showPrintConfirmation()" id="print-btn" disabled>
                        <i class="fas fa-print"></i> Print Price Tags
                    </button>
                    <button class="btn btn-warning" onclick="showMarkActiveConfirmation()" id="mark-active-btn" disabled>
                        <i class="fas fa-check-circle"></i> Mark as Active
                    </button>
                    <button class="btn btn-secondary" onclick="selectInactiveRecords()" id="select-inactive-btn">
                        <i class="fas fa-check-square"></i> Select Inactive Records
                    </button>
                    <button class="btn btn-secondary" onclick="selectAllOnPage()">
                        <i class="fas fa-check-double"></i> Select All on Page
                    </button>
                    <button class="btn btn-secondary" onclick="clearSelection()">
                        <i class="fas fa-times-circle"></i> Clear Selection
                    </button>
                </div>
                
                <!-- Status Messages -->
                <div id="status-message" class="status-message"></div>
                
                <!-- Loading Indicator -->
                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p>Processing...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Confirmation Modal -->
    <div id="print-confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-print"></i> Print Price Tags</h3>
                <button class="modal-close" onclick="closePrintConfirmation()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="print-summary">
                    <h4>Print Summary</h4>
                    <p>You are about to print price tags for <strong id="print-count">0</strong> selected records.</p>
                    <ul id="print-summary-list">
                        <!-- Will be populated dynamically -->
                    </ul>
                    <p>After printing successfully, you should mark these records as <strong>Active</strong> using the "Mark as Active" button.</p>
                </div>
                <div class="confirmation-check">
                    <input type="checkbox" id="print-confirmation-check">
                    <label for="print-confirmation-check">I have confirmed the print settings and am ready to print</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePrintConfirmation()">Cancel</button>
                <button class="btn btn-success" onclick="confirmPrint()" id="confirm-print-btn" disabled>
                    <i class="fas fa-print"></i> Print Now
                </button>
            </div>
        </div>
    </div>

    <!-- Mark Active Confirmation Modal -->
    <div id="mark-active-confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-check-circle"></i> Mark as Active</h3>
                <button class="modal-close" onclick="closeMarkActiveConfirmation()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="print-summary">
                    <h4>Confirmation Required</h4>
                    <p>You are about to mark <strong id="mark-active-count">0</strong> selected records as <strong>Active</strong>.</p>
                    <ul id="mark-active-summary-list">
                        <!-- Will be populated dynamically -->
                    </ul>
                    <p><strong>Important:</strong> Only mark records as Active <em>after</em> you have successfully printed their price tags.</p>
                    <p>This will change their status from "Inactive" to "Active" in the system.</p>
                </div>
                <div class="confirmation-check">
                    <input type="checkbox" id="mark-active-confirmation-check">
                    <label for="mark-active-confirmation-check">I have successfully printed price tags for these records</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMarkActiveConfirmation()">Cancel</button>
                <button class="btn btn-warning" onclick="confirmMarkActive()" id="confirm-mark-active-btn" disabled>
                    <i class="fas fa-check-circle"></i> Mark as Active
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let consignorCache = {};
        let allRecords = [];
        let filteredRecords = [];
        let currentPage = 1;
        let pageSize = 100;
        let totalPages = 1;
        let configValues = {};
        let recentlyPrintedIds = new Set(); // Track recently printed records
        
        // Configuration fetching functions
        async function fetchConfigValues() {
            try {
                const response = await fetch(`${AppConfig.baseUrl}/config`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        configValues = data.config || {};
                        console.log('Loaded config values:', configValues);
                        return configValues;
                    }
                }
                // Return default values if API fails
                return getDefaultConfig();
            } catch (error) {
                console.error('Error fetching config:', error);
                return getDefaultConfig();
            }
        }
        
        function getDefaultConfig() {
            return {
                LABEL_WIDTH_MM: 45.0,
                LABEL_HEIGHT_MM: 16.8,
                LEFT_MARGIN_MM: 6.5,
                GUTTER_SPACING_MM: 6.5,
                TOP_MARGIN_MM: 14.0,
                FONT_SIZE: 7,
                PRICE_FONT_SIZE: 10,
                PRICE_Y_POS: 2.0,
                TEXT_FONT_SIZE: 6,
                BARCODE_Y_POS: 2.0,
                BARCODE_HEIGHT: 6.0,
                PRINT_BORDERS: false
            };
        }
        
        async function getConfigValue(key, defaultValue) {
            if (Object.keys(configValues).length === 0) {
                await fetchConfigValues();
            }
            return configValues[key] !== undefined ? configValues[key] : defaultValue;
        }
        
        // Helper functions
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength - 1) + 'â€¦' : text;
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (e) {
                return dateString.split('T')[0] || 'Unknown';
            }
        }
        
        function getStatusClass(statusId) {
            switch(statusId) {
                case 1: return 'condition-gplus';
                case 2: return 'condition-vgplus';
                case 3: return 'condition-mint';
                default: return 'condition-g';
            }
        }
        
        function getStatusText(statusId) {
            switch(statusId) {
                case 1: return 'Inactive';
                case 2: return 'Active';
                case 3: return 'Sold';
                default: return `Status ${statusId || '?'}`;
            }
        }
        
        function getStatusIdFromFilter(filterValue) {
            switch(filterValue) {
                case 'inactive': return 1;
                case 'active': return 2;
                case 'sold': return 3;
                default: return null;
            }
        }
        
        async function getConsignorInfo(consignorId) {
            if (!consignorId) return { username: 'None', initials: '' };
            
            if (consignorCache[consignorId]) {
                return consignorCache[consignorId];
            }
            
            try {
                const url = `${AppConfig.baseUrl}/users/${consignorId}`;
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        const user = data.user || {};
                        const consignorInfo = {
                            username: user.username || `User ${consignorId}`,
                            initials: user.initials || (user.username ? user.username.substring(0, 2).toUpperCase() : '')
                        };
                        consignorCache[consignorId] = consignorInfo;
                        return consignorInfo;
                    }
                }
            } catch (error) {
                console.log('Error fetching consignor:', error);
            }
            
            return { username: `User ${consignorId}`, initials: '' };
        }
        
        async function loadUsers() {
            try {
                const url = `${AppConfig.baseUrl}/users`;
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        const users = data.users || [];
                        const userSelect = $('#user-select');
                        userSelect.empty();
                        userSelect.append('<option value="all">All Users</option>');
                        
                        users.forEach(user => {
                            userSelect.append(`<option value="${user.id}">${user.username} (ID: ${user.id})</option>`);
                        });
                        
                        users.forEach(user => {
                            consignorCache[user.id] = {
                                username: user.username || `User ${user.id}`,
                                initials: user.initials || (user.username ? user.username.substring(0, 2).toUpperCase() : '')
                            };
                        });
                    }
                }
            } catch (error) {
                showStatus('Error loading users', 'error');
            }
        }
        
        async function loadRecords() {
            showLoading(true);
            
            try {
                const userSelect = document.getElementById('user-select');
                const selectedUserId = userSelect.value === 'all' ? null : userSelect.value;
                
                let url;
                if (selectedUserId) {
                    url = `${AppConfig.baseUrl}/records/user/${selectedUserId}`;
                } else {
                    url = `${AppConfig.baseUrl}/records`;
                }
                
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        allRecords = data.records || [];
                        
                        // Sort by created_at descending (newest first)
                        allRecords.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                        
                        // Update counts
                        document.getElementById('total-records').textContent = allRecords.length;
                        const inactiveCount = allRecords.filter(r => r.status_id === 1).length;
                        const activeCount = allRecords.filter(r => r.status_id === 2).length;
                        const soldCount = allRecords.filter(r => r.status_id === 3).length;
                        
                        document.getElementById('inactive-records').textContent = inactiveCount;
                        document.getElementById('active-records').textContent = activeCount;
                        document.getElementById('sold-records').textContent = soldCount;
                        
                        // Update batch size
                        const batchSizeInput = document.getElementById('batch-size');
                        batchSizeInput.max = inactiveCount;
                        batchSizeInput.value = Math.min(parseInt(batchSizeInput.value), inactiveCount);
                        
                        // Pre-fetch consignor data
                        const consignorIds = new Set();
                        allRecords.forEach(r => { if (r.consignor_id) consignorIds.add(r.consignor_id); });
                        const fetchPromises = Array.from(consignorIds).map(id => getConsignorInfo(id));
                        await Promise.all(fetchPromises);
                        
                        // Apply current filter
                        filterRecords();
                        
                        showStatus(`Loaded ${allRecords.length} records (${inactiveCount} inactive, ${activeCount} active, ${soldCount} sold)`, 'success');
                    }
                }
            } catch (error) {
                showStatus('Error loading records', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function filterRecords() {
            const statusFilter = document.getElementById('status-filter').value;
            const statusId = getStatusIdFromFilter(statusFilter);
            
            if (statusId) {
                filteredRecords = allRecords.filter(r => r.status_id === statusId);
            } else {
                filteredRecords = [...allRecords];
            }
            
            // Sort by created_at descending (newest first)
            filteredRecords.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Reset to first page when filtering
            currentPage = 1;
            updatePagination();
            renderCurrentPage();
            
            // Update status message
            const statusText = statusFilter === 'all' ? 'All records' : 
                              statusFilter === 'inactive' ? 'Inactive records' :
                              statusFilter === 'active' ? 'Active records' : 'Sold records';
            
            showStatus(`Showing ${filteredRecords.length} ${statusText}`, 'info');
        }
        
        function updatePagination() {
            totalPages = Math.ceil(filteredRecords.length / pageSize);
            if (totalPages === 0) totalPages = 1;
            
            // Update page controls
            document.getElementById('total-pages').textContent = totalPages;
            document.getElementById('current-page').value = currentPage;
            document.getElementById('total-filtered').textContent = filteredRecords.length;
            
            // Update button states
            document.getElementById('first-page-btn').disabled = currentPage === 1;
            document.getElementById('prev-page-btn').disabled = currentPage === 1;
            document.getElementById('next-page-btn').disabled = currentPage === totalPages;
            document.getElementById('last-page-btn').disabled = currentPage === totalPages;
            
            // Update showing info
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, filteredRecords.length);
            
            document.getElementById('showing-start').textContent = startIndex;
            document.getElementById('showing-end').textContent = endIndex;
            document.getElementById('total-filtered').textContent = filteredRecords.length;
            
            // Update selected count
            const selectedCount = window.selectedRecords ? window.selectedRecords.size : 0;
            document.getElementById('selected-count').textContent = selectedCount;
            
            // Update button states based on selection
            updateButtonStates();
        }
        
        function updateButtonStates() {
            const selectedCount = window.selectedRecords ? window.selectedRecords.size : 0;
            const hasSelection = selectedCount > 0;
            
            document.getElementById('print-btn').disabled = !hasSelection;
            document.getElementById('mark-active-btn').disabled = !hasSelection;
        }
        
        function renderCurrentPage() {
            const tbody = document.getElementById('records-body');
            tbody.innerHTML = '';
            
            if (filteredRecords.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align: center; padding: 20px; color: #666;">No records found</td></tr>`;
                updatePagination();
                return;
            }
            
            // Calculate slice for current page
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredRecords.length);
            const pageRecords = filteredRecords.slice(startIndex, endIndex);
            
            pageRecords.forEach((record, index) => {
                const globalIndex = startIndex + index;
                const consignorInfo = consignorCache[record.consignor_id] || { username: 'None', initials: '' };
                
                // Check if this record was recently printed
                const isRecentlyPrinted = recentlyPrintedIds.has(record.id.toString());
                const rowClass = isRecentlyPrinted ? 'recently-printed' : '';
                
                const tr = document.createElement('tr');
                if (isRecentlyPrinted) {
                    tr.style.backgroundColor = '#f0fff0';
                    tr.style.borderLeft = '3px solid #27ae60';
                }
                
                tr.innerHTML = `
                    <td><input type="checkbox" class="record-checkbox" data-id="${record.id}" ${window.selectedRecords && window.selectedRecords.has(record.id.toString()) ? 'checked' : ''}></td>
                    <td>${globalIndex + 1}</td>
                    <td><strong>${formatDate(record.created_at)}</strong></td>
                    <td>${truncateText(record.artist || 'Unknown', 25)}</td>
                    <td>${truncateText(record.title || 'Unknown', 30)}</td>
                    <td>$${(record.store_price || 0).toFixed(2)}</td>
                    <td>${truncateText(record.catalog_number || 'N/A', 15)}</td>
                    <td>${truncateText(record.genre_name || record.genre || 'Unknown', 20)}</td>
                    <td>${record.barcode || 'N/A'}</td>
                    <td>
                        ${record.consignor_id ? 
                            `<span class="consignor-badge" title="${consignorInfo.username}">${consignorInfo.initials || consignorInfo.username.substring(0, 2)}</span>` : 
                            '<span style="color: #999;">None</span>'}
                    </td>
                    <td>
                        <span class="condition-badge ${getStatusClass(record.status_id)}">
                            ${getStatusText(record.status_id)}
                        </span>
                        ${isRecentlyPrinted ? '<br><small style="color: #27ae60; font-size: 10px;">(Printed)</small>' : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Add checkbox event listeners
            document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const recordId = this.getAttribute('data-id');
                    if (this.checked) {
                        window.selectedRecords.add(recordId);
                    } else {
                        window.selectedRecords.delete(recordId);
                    }
                    updateButtonStates();
                    updatePagination();
                });
            });
            
            // Select all checkbox
            const selectAllCheckbox = document.getElementById('select-all');
            selectAllCheckbox.checked = false;
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.record-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    const recordId = checkbox.getAttribute('data-id');
                    if (this.checked) {
                        window.selectedRecords.add(recordId);
                    } else {
                        window.selectedRecords.delete(recordId);
                    }
                });
                updateButtonStates();
                updatePagination();
            });
            
            updatePagination();
        }
        
        function goToPage(page) {
            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;
            
            currentPage = page;
            renderCurrentPage();
            updatePagination();
        }
        
        function goToFirstPage() {
            goToPage(1);
        }
        
        function goToPreviousPage() {
            goToPage(currentPage - 1);
        }
        
        function goToNextPage() {
            goToPage(currentPage + 1);
        }
        
        function goToLastPage() {
            goToPage(totalPages);
        }
        
        function changePageSize(newSize) {
            pageSize = newSize;
            currentPage = 1;
            updatePagination();
            renderCurrentPage();
        }
        
        function updateSelectionUI() {
            const count = window.selectedRecords ? window.selectedRecords.size : 0;
            document.getElementById('selected-tags').textContent = count;
            updateButtonStates();
        }
        
        function selectInactiveRecords() {
            // Get all inactive records from the current page
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredRecords.length);
            const pageRecords = filteredRecords.slice(startIndex, endIndex);
            
            let selectedCount = 0;
            
            pageRecords.forEach((record, index) => {
                if (record.status_id === 1) { // Inactive
                    const recordId = record.id.toString();
                    window.selectedRecords.add(recordId);
                    selectedCount++;
                }
            });
            
            // Re-render to update checkboxes
            renderCurrentPage();
            
            if (selectedCount > 0) {
                showStatus(`Selected ${selectedCount} inactive records on this page`, 'success');
            } else {
                showStatus('No inactive records on this page', 'info');
            }
        }
        
        function selectAllOnPage() {
            // Select all records on current page
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredRecords.length);
            const pageRecords = filteredRecords.slice(startIndex, endIndex);
            
            pageRecords.forEach((record) => {
                const recordId = record.id.toString();
                window.selectedRecords.add(recordId);
            });
            
            // Re-render to update checkboxes
            renderCurrentPage();
            
            showStatus(`Selected all ${pageRecords.length} records on this page`, 'success');
        }
        
        function clearSelection() {
            window.selectedRecords.clear();
            renderCurrentPage();
            showStatus('Selection cleared', 'info');
        }
        
        // Modal Functions
        function showPrintConfirmation() {
            const selectedIds = Array.from(window.selectedRecords);
            if (selectedIds.length === 0) {
                showStatus('No records selected for printing', 'error');
                return;
            }
            
            const selectedRecords = allRecords.filter(r => selectedIds.includes(r.id.toString()));
            const inactiveRecords = selectedRecords.filter(r => r.status_id === 1);
            const activeRecords = selectedRecords.filter(r => r.status_id === 2);
            const soldRecords = selectedRecords.filter(r => r.status_id === 3);
            
            // Update modal content
            document.getElementById('print-count').textContent = selectedRecords.length;
            
            const summaryList = document.getElementById('print-summary-list');
            summaryList.innerHTML = `
                <li>Total selected: ${selectedRecords.length} records</li>
                <li>Inactive records: ${inactiveRecords.length} (will be printed)</li>
                <li>Active records: ${activeRecords.length} (already active)</li>
                <li>Sold records: ${soldRecords.length} (won't be printed)</li>
            `;
            
            // Reset confirmation checkbox
            document.getElementById('print-confirmation-check').checked = false;
            document.getElementById('confirm-print-btn').disabled = true;
            
            // Show modal
            document.getElementById('print-confirmation-modal').style.display = 'flex';
            
            // Add event listener for confirmation checkbox
            document.getElementById('print-confirmation-check').addEventListener('change', function() {
                document.getElementById('confirm-print-btn').disabled = !this.checked;
            });
        }
        
        function closePrintConfirmation() {
            document.getElementById('print-confirmation-modal').style.display = 'none';
        }
        
        async function confirmPrint() {
            const selectedIds = Array.from(window.selectedRecords);
            const batchSize = parseInt(document.getElementById('batch-size').value);
            
            closePrintConfirmation();
            showLoading(true);
            
            // Get selected inactive records (already sorted by date)
            const selectedRecords = allRecords
                .filter(r => selectedIds.includes(r.id.toString()) && r.status_id === 1)
                .slice(0, batchSize);
                
            if (selectedRecords.length === 0) {
                showStatus('No inactive records selected', 'error');
                showLoading(false);
                return;
            }
            
            try {
                // Fetch configuration values
                await fetchConfigValues();
                
                // Generate PDF
                const pdfBlob = await generatePDF(selectedRecords);
                
                // Download PDF
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `price_tags_${new Date().toISOString().slice(0, 10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Add to recently printed set
                selectedRecords.forEach(record => {
                    recentlyPrintedIds.add(record.id.toString());
                });
                
                // Clear selection after successful print
                window.selectedRecords.clear();
                
                showStatus(`PDF generated for ${selectedRecords.length} records. Now mark them as Active.`, 'success');
                
                // Refresh the display to show "Printed" indicator
                renderCurrentPage();
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                showStatus(`Error generating PDF: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function showMarkActiveConfirmation() {
            const selectedIds = Array.from(window.selectedRecords);
            if (selectedIds.length === 0) {
                showStatus('No records selected', 'error');
                return;
            }
            
            const selectedRecords = allRecords.filter(r => selectedIds.includes(r.id.toString()));
            const inactiveRecords = selectedRecords.filter(r => r.status_id === 1);
            const activeRecords = selectedRecords.filter(r => r.status_id === 2);
            const soldRecords = selectedRecords.filter(r => r.status_id === 3);
            
            // Update modal content
            document.getElementById('mark-active-count').textContent = selectedRecords.length;
            
            const summaryList = document.getElementById('mark-active-summary-list');
            summaryList.innerHTML = `
                <li>Total selected: ${selectedRecords.length} records</li>
                <li>Inactive records: ${inactiveRecords.length} (will be marked as Active)</li>
                <li>Active records: ${activeRecords.length} (already active - no change)</li>
                <li>Sold records: ${soldRecords.length} (won't be changed)</li>
            `;
            
            // Reset confirmation checkbox
            document.getElementById('mark-active-confirmation-check').checked = false;
            document.getElementById('confirm-mark-active-btn').disabled = true;
            
            // Show modal
            document.getElementById('mark-active-confirmation-modal').style.display = 'flex';
            
            // Add event listener for confirmation checkbox
            document.getElementById('mark-active-confirmation-check').addEventListener('change', function() {
                document.getElementById('confirm-mark-active-btn').disabled = !this.checked;
            });
        }
        
        function closeMarkActiveConfirmation() {
            document.getElementById('mark-active-confirmation-modal').style.display = 'none';
        }
        
        async function confirmMarkActive() {
            const selectedIds = Array.from(window.selectedRecords);
            
            closeMarkActiveConfirmation();
            showLoading(true);
            
            try {
                // Filter for inactive records only
                const inactiveRecordIds = selectedIds.filter(id => {
                    const record = allRecords.find(r => r.id.toString() === id);
                    return record && record.status_id === 1;
                });
                
                if (inactiveRecordIds.length === 0) {
                    showStatus('No inactive records to mark as active', 'info');
                    showLoading(false);
                    return;
                }
                
                // Update each record's status
                let successCount = 0;
                let errorCount = 0;
                
                for (const recordId of inactiveRecordIds) {
                    try {
                        const response = await fetch(`${AppConfig.baseUrl}/records/${recordId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                status_id: 2 // Active status
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.status === 'success') {
                                successCount++;
                                
                                // Update local record status
                                const recordIndex = allRecords.findIndex(r => r.id.toString() === recordId);
                                if (recordIndex !== -1) {
                                    allRecords[recordIndex].status_id = 2;
                                }
                            } else {
                                errorCount++;
                            }
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error(`Error updating record ${recordId}:`, error);
                        errorCount++;
                    }
                }
                
                // Clear selection
                window.selectedRecords.clear();
                
                // Clear recently printed indicators for these records
                inactiveRecordIds.forEach(id => {
                    recentlyPrintedIds.delete(id);
                });
                
                // Refresh data
                await loadRecords();
                
                if (successCount > 0) {
                    showStatus(`Successfully marked ${successCount} records as Active${errorCount > 0 ? ` (${errorCount} failed)` : ''}`, 'success');
                } else {
                    showStatus(`Failed to mark records as Active: ${errorCount} errors`, 'error');
                }
                
            } catch (error) {
                console.error('Error marking records as active:', error);
                showStatus(`Error: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function generatePDF(records) {
            return new Promise(async (resolve) => {
                const { jsPDF } = window.jspdf;
                
                // Load configuration values
                const config = await fetchConfigValues();
                
                // Extract configuration values with defaults
                const labelWidthMM = config.LABEL_WIDTH_MM || 45.0;
                const labelHeightMM = config.LABEL_HEIGHT_MM || 16.8;
                const leftMarginMM = config.LEFT_MARGIN_MM || 6.5;
                const gutterSpacingMM = config.GUTTER_SPACING_MM || 6.5;
                const topMarginMM = config.TOP_MARGIN_MM || 14.0;
                const priceFontSize = config.PRICE_FONT_SIZE || 10;
                const textFontSize = config.TEXT_FONT_SIZE || 6;
                const barcodeHeightMM = config.BARCODE_HEIGHT || 6.0;
                const printBorders = config.PRINT_BORDERS === 'true' || config.PRINT_BORDERS === true;
                
                // Convert mm to points for jsPDF (1 mm = 2.83465 points)
                const mmToPt = 2.83465;
                const labelWidthPt = labelWidthMM * mmToPt;
                const labelHeightPt = labelHeightMM * mmToPt;
                const leftMarginPt = leftMarginMM * mmToPt;
                const gutterSpacingPt = gutterSpacingMM * mmToPt;
                const topMarginPt = topMarginMM * mmToPt;
                const barcodeHeightPt = barcodeHeightMM * mmToPt;
                
                const doc = new jsPDF({
                    unit: 'pt',
                    format: 'letter'
                });
                
                // Layout calculations
                const pageWidthPt = doc.internal.pageSize.getWidth();
                const pageHeightPt = doc.internal.pageSize.getHeight();
                const rows = 15;
                const cols = 4;
                const labelsPerPage = rows * cols;
                
                let currentLabel = 0;
                
                // Pre-fetch consignor data
                const consignorCache = {};
                const consignorIds = new Set();
                records.forEach(r => { 
                    if (r.consignor_id) consignorIds.add(r.consignor_id); 
                });
                
                // Fetch consignor data
                for (const consignorId of consignorIds) {
                    const consignorInfo = await getConsignorInfo(consignorId);
                    consignorCache[consignorId] = consignorInfo.initials || '';
                }
                
                // Generate labels
                for (const record of records) {
                    // Add new page if needed
                    if (currentLabel > 0 && currentLabel % labelsPerPage === 0) {
                        doc.addPage();
                    }
                    
                    // Calculate position
                    const pageIndex = currentLabel % labelsPerPage;
                    const row = Math.floor(pageIndex / cols);
                    const col = pageIndex % cols;
                    
                    const x = leftMarginPt + (col * (labelWidthPt + gutterSpacingPt));
                    const y = topMarginPt + (row * labelHeightPt);
                    
                    // Draw border if enabled
                    if (printBorders) {
                        doc.setDrawColor(0);
                        doc.setLineWidth(0.5);
                        doc.rect(x, y, labelWidthPt, labelHeightPt);
                    }
                    
                    // Get consignor initials
                    const consignorId = record.consignor_id;
                    const consignorInitials = consignorCache[consignorId] || '';
                    
                    // Draw price
                    const price = record.store_price || 0;
                    const priceText = `$${price.toFixed(2)}`;
                    doc.setFontSize(priceFontSize);
                    doc.setFont('helvetica', 'bold');
                    
                    const priceWidth = doc.getTextWidth(priceText);
                    const priceX = x + (labelWidthPt - priceWidth) / 2;
                    const priceY = y + labelHeightPt - (4 * mmToPt); // Position from top
                    
                    doc.text(priceText, priceX, priceY);
                    
                    // Draw artist, genre, and consignor initials
                    const artist = record.artist || 'Unknown';
                    const genre = record.genre_name || record.genre || 'Unknown';
                    
                    let infoText = genre;
                    if (artist !== 'Unknown') {
                        infoText += ` | ${artist}`;
                    }
                    if (consignorInitials) {
                        infoText += ` | (${consignorInitials})`;
                    }
                    
                    // Truncate if too long
                    const maxLength = 35;
                    if (infoText.length > maxLength) {
                        infoText = infoText.substring(0, maxLength - 1) + 'â€¦';
                    }
                    
                    doc.setFontSize(textFontSize);
                    doc.setFont('helvetica', 'normal');
                    
                    const infoWidth = doc.getTextWidth(infoText);
                    const infoX = x + (labelWidthPt - infoWidth) / 2;
                    const infoY = priceY - (3 * mmToPt);
                    
                    doc.text(infoText, infoX, infoY);
                    
                    // Draw barcode if available
                    const barcodeNum = record.barcode;
                    if (barcodeNum) {
                        const canvas = document.createElement('canvas');
                        JsBarcode(canvas, barcodeNum, {
                            format: "CODE128",
                            displayValue: false,
                            height: 20,
                            margin: 0,
                            width: 2
                        });
                        
                        const barcodeData = canvas.toDataURL('image/png');
                        const barcodeX = x + (labelWidthPt - (25 * mmToPt)) / 2;
                        const barcodeY = y + (2 * mmToPt);
                        
                        doc.addImage(barcodeData, 'PNG', barcodeX, barcodeY, 25 * mmToPt, barcodeHeightPt);
                    }
                    
                    currentLabel++;
                }
                
                const pdfBlob = doc.output('blob');
                resolve(pdfBlob);
            });
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            const userData = localStorage.getItem('user');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    if (user.role !== 'admin') {
                        window.location.href = '/';
                        return;
                    }
                } catch {
                    window.location.href = '/';
                    return;
                }
            } else {
                window.location.href = '/';
                return;
            }
            
            // Initialize selected records set
            window.selectedRecords = new Set();
            
            // Fetch configuration values first
            await fetchConfigValues();
            
            // Initialize UI components
            $('#user-select').select2({
                placeholder: "Select a user...",
                allowClear: true
            }).on('change', loadRecords);
            
            // Load data
            loadUsers();
            loadRecords();
        });
    </script>
</body>
</html>