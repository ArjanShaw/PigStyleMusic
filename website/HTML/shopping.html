<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel="icon" href="/static/images/PigStyle.ico">
    <title>Inventory - PigStyle Records</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-03HFDR9PV7"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-03HFDR9PV7');
    </script>
    
    <link rel="stylesheet" href="/static/css/catalog.css">
    <script src="/static/js/app-config.js"></script>
    
    <style>
        /* Additional styles for copy count and price range */
        .copy-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0 5px 0;
            font-size: 13px;
            color: #666;
        }
        
        .copy-count {
            background: #ff6b6b;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .price-range {
            font-weight: 600;
            color: #28a745;
            font-size: 13px;
        }
        
        .condition-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 4px;
        }
        
        .condition-mint { background: #d4edda; color: #155724; }
        .condition-near-mint { background: #cce5ff; color: #004085; }
        .condition-very-good-plus { background: #d1ecf1; color: #0c5460; }
        .condition-very-good { background: #fff3cd; color: #856404; }
        .condition-good-plus { background: #f8d7da; color: #721c24; }
        .condition-good { background: #f8d7da; color: #721c24; }
        .condition-fair { background: #e2e3e5; color: #383d41; }
        .condition-poor { background: #e2e3e5; color: #383d41; }
        
        .conditions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 5px;
        }
        
        .card:hover .conditions-list {
            opacity: 1;
        }
        
        /* Tooltip for additional copies */
        .more-copies {
            font-size: 11px;
            color: #999;
            margin-left: 4px;
        }

        /* Popup/Modal styles */
        .copies-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .copies-modal {
            background: white;
            border-radius: 8px;
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .copies-modal-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 2px solid #ff6b6b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copies-modal-header h3 {
            margin: 0;
            color: #000000;
            font-size: 16px;
            font-weight: 600;
        }

        .copies-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #000000;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .copies-modal-close:hover {
            opacity: 1;
            color: #ff6b6b;
        }

        /* New styles for album image in popup */
        .copies-modal-content {
            display: flex;
            flex-direction: row;
            max-height: calc(80vh - 120px);
        }

        .modal-album-image {
            width: 150px;
            flex-shrink: 0;
            padding: 20px 0 20px 20px;
        }

        .modal-album-image img {
            width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .copies-list-with-image {
            flex: 1;
            padding: 20px 20px 20px 10px;
            max-height: calc(80vh - 120px);
            overflow-y: auto;
            background: white;
        }

        /* Simplified filter section - only date buttons */
        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .date-presets {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .date-preset-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            color: #333;
            transition: all 0.2s;
            font-weight: 500;
        }

        .date-preset-btn:hover {
            background: #ff6b6b;
            border-color: #ff6b6b;
            color: white;
        }

        .date-preset-btn.active {
            background: #ff6b6b;
            border-color: #ff6b6b;
            color: white;
        }

        /* New arrivals badge */
        .new-arrival-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .card {
            position: relative;
        }

        /* Search box */
        .search-wrapper {
            margin-bottom: 20px;
        }

        #searchBox {
            width: 100%;
            max-width: 400px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }

        #searchBox:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 2px rgba(255,107,107,0.1);
        }

        /* Cart Styles */
        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }

        .cart-drawer {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 2000;
            display: flex;
            flex-direction: column;
        }

        .cart-drawer.open {
            right: 0;
        }

        .cart-drawer-header {
            padding: 20px;
            border-bottom: 2px solid #ff6b6b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .cart-drawer-header h3 {
            margin: 0;
            color: #000;
            font-size: 18px;
        }

        .cart-drawer-header h3 i {
            color: #ff6b6b;
            margin-right: 8px;
        }

        .cart-drawer-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            line-height: 1;
            padding: 0;
            transition: color 0.2s;
        }

        .cart-drawer-close:hover {
            color: #ff6b6b;
        }

        .cart-drawer-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: white;
        }

        .empty-cart-message {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-cart-message i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ddd;
        }

        .empty-cart-message p {
            margin: 0;
            font-size: 16px;
        }

        .cart-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            position: relative;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
            padding-right: 20px;
        }

        .cart-item-artist {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .cart-item-condition {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-bottom: 5px;
        }

        .cart-item-price {
            color: #28a745;
            font-weight: 600;
            font-size: 14px;
        }

        .cart-item-remove {
            position: absolute;
            top: 15px;
            right: 0;
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 14px;
            padding: 5px;
            transition: color 0.2s;
        }

        .cart-item-remove:hover {
            color: #ff6b6b;
        }

        .cart-drawer-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 16px;
        }

        .checkout-btn {
            width: 100%;
            padding: 12px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 16px;
        }

        .checkout-btn:hover {
            background: #ff5252;
        }

        .cart-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1999;
            display: none;
        }

        .cart-overlay.active {
            display: block;
        }

        /* Add to cart button in modal */
        .copy-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .copy-item:hover {
            background: #f8f9fa;
        }

        .copy-item-content {
            flex: 1;
        }

        .add-to-cart-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.2s;
            margin-left: 10px;
            white-space: nowrap;
        }

        .add-to-cart-btn:hover {
            background: #ff5252;
        }

        .add-to-cart-btn i {
            margin-right: 4px;
        }

        .add-to-cart-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background: #28a745;
            color: white;
            border-radius: 6px;
            z-index: 3000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .notification.error {
            background: #ff6b6b;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Disabled add to cart button when item is already in cart */
        .add-to-cart-btn.in-cart {
            background: #28a745;
            cursor: default;
        }

        .add-to-cart-btn.in-cart:hover {
            background: #28a745;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav style="background: #000; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; border-bottom: 2px solid #ff6b6b;">
        <a href="/" style="color: white; text-decoration: none; font-size: 20px; font-weight: bold; display: flex; align-items: center; gap: 10px;">
            <img src="/static/images/PigStyle.ico" alt="PigStyle" style="height: 30px; width: 30px;">
        </a>
        <div style="display: flex; gap: 20px; align-items: center;">
            <a href="/inventory" style="color: white; text-decoration: none;">Inventory</a>
            <a href="/streaming" style="color: white; text-decoration: none;">Streaming</a>
            <a href="/consignment" style="color: white; text-decoration: none;">Consignment</a>
            <div id="auth-section"></div>
            
            <!-- Cart drawer toggle button - only shows when items exist -->
            <div id="cartToggleContainer" style="display: none;">
                <div class="cart-icon-wrapper" id="cartToggle" style="position: relative; cursor: pointer;">
                    <i class="fas fa-shopping-cart" style="color: white; font-size: 20px;"></i>
                    <span id="cartBadge" class="cart-badge">0</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Add padding to account for fixed navbar -->
    <div style="padding-top: 60px;"></div>

    <!-- Background Image -->
    <div class="background-container">
        <img src="/static/images/background.png" alt="Background" class="background-image">
        <div class="background-overlay"></div>
    </div>

    <div class="header-section">
        <div class='search-wrapper'>
            <input type='text' id='searchBox' placeholder='Search artist or record...'>
        </div>
        
        <div class="filter-section">
            <div class="filter-label"><i class="far fa-calendar-alt"></i> Date Added</div>
            <div class="date-presets">
                <button type="button" class="date-preset-btn active" data-days="7">Last 7 days</button>
                <button type="button" class="date-preset-btn" data-days="30">Last 30 days</button>
                <button type="button" class="date-preset-btn" data-days="90">Last 90 days</button>
                <button type="button" class="date-preset-btn" data-days="365">Last year</button>
                <button type="button" class="date-preset-btn" id="clearDates">Clear</button>
            </div>
        </div>
    </div>
    
    <div class='catalog-container' id='catalogContainer'>
        <div id='loading'>
            <div class="loading-dots">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
            <p>Loading inventory...</p>
        </div>
    </div>

    <!-- Cart Drawer - Hidden by default -->
    <div class="cart-drawer" id="cartDrawer">
        <div class="cart-drawer-header">
            <h3><i class="fas fa-shopping-cart"></i> Your Cart</h3>
            <button class="cart-drawer-close" id="closeCartDrawer">&times;</button>
        </div>
        <div class="cart-drawer-items" id="cartItems">
            <!-- Cart items will be dynamically inserted here -->
            <div class="empty-cart-message">
                <i class="fas fa-shopping-bag"></i>
                <p>Your cart is empty</p>
            </div>
        </div>
        <div class="cart-drawer-footer" id="cartFooter" style="display: none;">
            <div class="cart-total">
                <span>Total:</span>
                <span id="cartTotal">$0.00</span>
            </div>
            <button class="checkout-btn" id="checkoutBtn">Proceed to Checkout</button>
        </div>
    </div>

    <!-- Cart Overlay (click to close) -->
    <div class="cart-overlay" id="cartOverlay"></div>

    <script>
        // Store all releases globally
        let allReleases = [];
        
        // Cart state
        let cart = {
            items: [],
            total: 0
        };

        // Load cart from localStorage on page load
        function loadCart() {
            const savedCart = localStorage.getItem('pigstyle_cart');
            if (savedCart) {
                try {
                    cart = JSON.parse(savedCart);
                    updateCartDisplay();
                } catch (e) {
                    console.error('Error loading cart:', e);
                }
            }
        }

        // Save cart to localStorage
        function saveCart() {
            localStorage.setItem('pigstyle_cart', JSON.stringify(cart));
            updateCartDisplay();
        }

        // Update cart display (badge, toggle visibility, drawer)
        function updateCartDisplay() {
            const cartToggleContainer = document.getElementById('cartToggleContainer');
            const cartBadge = document.getElementById('cartBadge');
            
            // Update badge count
            const itemCount = cart.items.reduce((sum, item) => sum + item.quantity, 0);
            cartBadge.textContent = itemCount;
            
            // Show/hide cart toggle based on items
            if (itemCount > 0) {
                cartToggleContainer.style.display = 'block';
            } else {
                cartToggleContainer.style.display = 'none';
            }
            
            // Update cart drawer if it's open
            updateCartDrawer();
        }

        // Update cart drawer contents
        function updateCartDrawer() {
            const cartItems = document.getElementById('cartItems');
            const cartFooter = document.getElementById('cartFooter');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cart.items.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-cart-message">
                        <i class="fas fa-shopping-bag"></i>
                        <p>Your cart is empty</p>
                    </div>
                `;
                cartFooter.style.display = 'none';
            } else {
                // Calculate total
                cart.total = cart.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                // Build items HTML
                let itemsHtml = '';
                cart.items.forEach((item, index) => {
                    const conditionClass = getConditionClass(item.condition);
                    itemsHtml += `
                        <div class="cart-item" data-cart-index="${index}">
                            <img src="${item.image_url || '/static/images/default-record.jpg'}" alt="${item.title}" class="cart-item-image" onerror="this.src='/static/images/default-record.jpg'">
                            <div class="cart-item-details">
                                <div class="cart-item-title">${escapeHtml(item.title)}</div>
                                <div class="cart-item-artist">${escapeHtml(item.artist)}</div>
                                <span class="cart-item-condition ${conditionClass}">${item.condition || 'Unknown'}</span>
                                <div class="cart-item-price">$${item.price.toFixed(2)}</div>
                            </div>
                            <button class="cart-item-remove" onclick="removeFromCart(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                });
                
                cartItems.innerHTML = itemsHtml;
                cartFooter.style.display = 'block';
                cartTotal.textContent = `$${cart.total.toFixed(2)}`;
            }
        }

        // Check if a copy is already in cart
        function isInCart(copyId) {
            return cart.items.some(item => item.copyId === copyId);
        }

        // Add item to cart
        function addToCart(copy, release) {
            // Check if item is already in cart
            if (isInCart(copy.id)) {
                showNotification('This item is already in your cart!', 'error');
                return false;
            }
            
            // Add new item
            cart.items.push({
                copyId: copy.id,
                title: release.title,
                artist: release.artist,
                condition: copy.condition,
                price: copy.store_price,
                image_url: release.image_url,
                quantity: 1
            });
            
            saveCart();
            showNotification('Item added to cart!', 'success');
            return true;
        }

        // Remove item from cart
        function removeFromCart(index) {
            cart.items.splice(index, 1);
            saveCart();
            showNotification('Item removed from cart', 'success');
            
            // If cart becomes empty, close the drawer
            if (cart.items.length === 0) {
                closeCartDrawer();
            }
        }

        // Clear entire cart
        function clearCart() {
            cart.items = [];
            cart.total = 0;
            saveCart();
            closeCartDrawer();
            showNotification('Cart cleared', 'success');
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type === 'error' ? 'error' : ''}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Open cart drawer
        function openCartDrawer() {
            document.getElementById('cartDrawer').classList.add('open');
            document.getElementById('cartOverlay').classList.add('active');
            updateCartDrawer(); // Refresh contents when opening
        }

        // Close cart drawer
        function closeCartDrawer() {
            document.getElementById('cartDrawer').classList.remove('open');
            document.getElementById('cartOverlay').classList.remove('active');
        }

        // Load data from new grouped API endpoint
        async function loadCatalogData() {
            try {
                console.log('Loading grouped catalog data from API...');
                const response = await fetch(`${AppConfig.baseUrl}/catalog/grouped-by-release`);
                const data = await response.json();
                
                console.log('API Response:', data);
                
                if (data.status === 'success') {
                    allReleases = data.groups || [];
                    console.log(`Loaded ${allReleases.length} unique releases with ${data.total_copies} total copies`);
                    displayReleases(allReleases);
                } else {
                    throw new Error('Invalid response from server');
                }
                
            } catch (error) {
                console.error('Error loading catalog data:', error);
                // Fallback to original endpoint if new one fails
                loadCatalogDataFallback();
            }
        }

        // Fallback to original endpoint
        async function loadCatalogDataFallback() {
            try {
                console.log('Falling back to original catalog endpoint...');
                // Assuming pigstyleAPI is available from app-config.js
                const response = await window.pigstyleAPI?.loadCatalogGroupedRecords?.() || [];
                
                let catalogData;
                if (Array.isArray(response)) {
                    catalogData = {
                        groups: [{
                            label: 'All Records',
                            records: response
                        }]
                    };
                } else if (response && response.groups) {
                    catalogData = response;
                } else {
                    throw new Error('Invalid response format');
                }
                
                // Convert flat records to grouped format
                const records = catalogData.groups.flatMap(g => g.records || []);
                const grouped = groupRecordsByRelease(records);
                allReleases = grouped;
                
                displayReleases(grouped);
                
            } catch (error) {
                console.error('Error loading fallback data:', error);
                document.getElementById('catalogContainer').innerHTML = 
                    '<div class="error-message">Error loading catalog. Please try again later.<br>' + 
                    error.message + '</div>';
            }
        }

        // Helper function to group flat records by release
        function groupRecordsByRelease(records) {
            const groups = {};
            const conditionOrder = {
                'Mint (M)': 1,
                'Near Mint (NM or M-)': 2,
                'Very Good Plus (VG+)': 3,
                'Very Good (VG)': 4,
                'Good Plus (G+)': 5,
                'Good (G)': 6,
                'Fair (F)': 7,
                'Poor (P)': 8
            };
            
            records.forEach(record => {
                const artist = (record.artist || '').trim();
                const title = (record.title || '').trim();
                const key = `${artist.toLowerCase()}|${title.toLowerCase()}`;
                
                if (!groups[key]) {
                    groups[key] = {
                        artist: artist,
                        title: title,
                        genre_name: record.genre_name,
                        image_url: record.image_url,
                        total_copies: 0,
                        price_range: { min: Infinity, max: 0 },
                        copies: [],
                        // Track the earliest created_at date for this release
                        created_at: record.created_at
                    };
                }
                
                const copy = {
                    id: record.id,
                    condition: record.condition,
                    condition_rank: conditionOrder[record.condition] || 99,
                    store_price: parseFloat(record.store_price) || 0,
                    barcode: record.barcode,
                    catalog_number: record.catalog_number,
                    youtube_url: record.youtube_url,
                    created_at: record.created_at
                };
                
                groups[key].copies.push(copy);
                groups[key].total_copies++;
                
                // Track the earliest creation date for the release
                if (record.created_at && (!groups[key].created_at || record.created_at < groups[key].created_at)) {
                    groups[key].created_at = record.created_at;
                }
                
                if (copy.store_price > 0) {
                    groups[key].price_range.min = Math.min(groups[key].price_range.min, copy.store_price);
                    groups[key].price_range.max = Math.max(groups[key].price_range.max, copy.store_price);
                }
            });
            
            // Clean up price ranges
            Object.values(groups).forEach(group => {
                if (group.price_range.min === Infinity) {
                    group.price_range = { min: 0, max: 0 };
                }
            });
            
            return Object.values(groups).sort((a, b) => 
                (a.artist || '').localeCompare(b.artist || '')
            );
        }

        // Display releases (keeps same tile layout)
        function displayReleases(releases) {
            const container = document.getElementById('catalogContainer');
            container.innerHTML = ''; // Clear loading message

            if (!releases || releases.length === 0) {
                container.innerHTML = '<div class="no-records">No records found in the database.</div>';
                return;
            }

            console.log(`Displaying ${releases.length} releases`);

            // Create a gallery container to maintain same layout
            const gallery = document.createElement('div');
            gallery.className = 'group-gallery';
            gallery.style.display = 'grid';
            gallery.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
            gallery.style.gap = '20px';
            gallery.style.padding = '20px';

            releases.forEach(release => {
                const card = createReleaseCard(release);
                gallery.appendChild(card);
            });

            container.appendChild(gallery);
            
            // Apply the default 7-day filter after loading
            setTimeout(() => {
                applyDateFilter(7);
            }, 100);
        }

        // Create a card for a release
        function createReleaseCard(release) {
            const card = document.createElement('div');
            card.className = 'card';
            
            // Set data attributes for filtering
            card.setAttribute('data-artist', (release.artist || '').toLowerCase());
            card.setAttribute('data-title', (release.title || '').toLowerCase());
            
            // Set date attribute for filtering (earliest creation date)
            if (release.created_at) {
                card.setAttribute('data-created', release.created_at);
                
                // Add "New Arrival" badge for items added in the last 30 days
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const createdDate = new Date(release.created_at);
                
                if (createdDate >= thirtyDaysAgo) {
                    const badge = document.createElement('div');
                    badge.className = 'new-arrival-badge';
                    badge.textContent = 'NEW';
                    card.appendChild(badge);
                }
            }
            
            // Get the best image (first copy with image, or default)
            const imageUrl = release.image_url || '/static/images/default-record.jpg';
            
            // Get genre
            const genre = release.genre_name || 'Unknown Genre';
            
            // Calculate price range display
            const priceRange = release.price_range;
            let priceDisplay = '';
            if (priceRange.min > 0 && priceRange.max > 0) {
                if (priceRange.min === priceRange.max) {
                    priceDisplay = `$${priceRange.min.toFixed(2)}`;
                } else {
                    priceDisplay = `$${priceRange.min.toFixed(2)} - $${priceRange.max.toFixed(2)}`;
                }
            } else if (priceRange.min > 0) {
                priceDisplay = `$${priceRange.min.toFixed(2)}`;
            } else {
                priceDisplay = 'Price varies';
            }
            
            // Get all unique conditions from copies
            const conditions = [...new Set(release.copies.map(c => c.condition).filter(Boolean))];
            const conditionCounts = {};
            release.copies.forEach(copy => {
                if (copy.condition) {
                    conditionCounts[copy.condition] = (conditionCounts[copy.condition] || 0) + 1;
                }
            });
            
            // Sort conditions by grade
            const conditionOrder = {
                'Mint (M)': 1,
                'Near Mint (NM or M-)': 2,
                'Very Good Plus (VG+)': 3,
                'Very Good (VG)': 4,
                'Good Plus (G+)': 5,
                'Good (G)': 6,
                'Fair (F)': 7,
                'Poor (P)': 8
            };
            
            const sortedConditions = conditions.sort((a, b) => 
                (conditionOrder[a] || 99) - (conditionOrder[b] || 99)
            );
            
            // Build conditions HTML
            let conditionsHtml = '';
            if (sortedConditions.length > 0) {
                conditionsHtml = '<div class="conditions-list">';
                sortedConditions.slice(0, 3).forEach(condition => {
                    if (!condition) return;
                    const conditionClass = getConditionClass(condition);
                    const count = conditionCounts[condition] || '';
                    const countDisplay = count > 1 ? ` (${count})` : '';
                    conditionsHtml += `<span class="condition-indicator ${conditionClass}">${condition}${countDisplay}</span>`;
                });
                if (sortedConditions.length > 3) {
                    conditionsHtml += `<span class="more-copies">+${sortedConditions.length - 3} more</span>`;
                }
                conditionsHtml += '</div>';
            }
            
            // Copy count display - only show if more than 1 copy
            let copyCountHtml = '';
            if (release.total_copies > 1) {
                const copyCountText = `${release.total_copies} copies`;
                copyCountHtml = `<span class="copy-count">${copyCountText}</span>`;
            }
            
            card.innerHTML = `
                <div class="card-image">
                    <img src="${imageUrl}" alt="${release.title}" onerror="this.src='/static/images/default-record.jpg'">
                </div>
                <div class="card-info">
                    <h3>${escapeHtml(release.title)}</h3>
                    <p class="artist">${escapeHtml(release.artist)}</p>
                    
                    <div class="copy-info">
                        ${copyCountHtml}
                        <span class="price-range">${priceDisplay}</span>
                    </div>
                    
                    <p class="genre">${escapeHtml(genre)}</p>
                    
                    ${conditionsHtml}
                    
                    ${release.copies.some(c => c.youtube_url) ? `
                        <a href="#" class="youtube-link" onclick="handleYouTubeClick('${release.copies.find(c => c.youtube_url)?.youtube_url || ''}', '${escapeHtml(release.artist)} - ${escapeHtml(release.title)}'); return false;">
                            ðŸŽµ Watch Video
                        </a>
                    ` : ''}
                </div>
            `;
            
            // Add click handler to show all copies popup
            card.addEventListener('click', function(e) {
                // Don't trigger if clicking on YouTube link
                if (e.target.closest('.youtube-link')) return;
                
                // Show popup with all copies
                showCopiesPopup(release);
            });
            
            return card;
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper function to get CSS class for condition
        function getConditionClass(condition) {
            const conditionLower = (condition || '').toLowerCase();
            if (conditionLower.includes('mint') && !conditionLower.includes('near')) {
                return 'condition-mint';
            } else if (conditionLower.includes('near mint')) {
                return 'condition-near-mint';
            } else if (conditionLower.includes('very good plus')) {
                return 'condition-very-good-plus';
            } else if (conditionLower.includes('very good')) {
                return 'condition-very-good';
            } else if (conditionLower.includes('good plus')) {
                return 'condition-good-plus';
            } else if (conditionLower.includes('good')) {
                return 'condition-good';
            } else if (conditionLower.includes('fair')) {
                return 'condition-fair';
            } else if (conditionLower.includes('poor')) {
                return 'condition-poor';
            }
            return '';
        }

        // Show popup with all copies (with album image and add to cart buttons)
        function showCopiesPopup(release) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'copies-modal-overlay';
            
            // Sort copies by condition (best first)
            const conditionOrder = {
                'Mint (M)': 1,
                'Near Mint (NM or M-)': 2,
                'Very Good Plus (VG+)': 3,
                'Very Good (VG)': 4,
                'Good Plus (G+)': 5,
                'Good (G)': 6,
                'Fair (F)': 7,
                'Poor (P)': 8
            };
            
            const sortedCopies = [...release.copies].sort((a, b) => {
                const orderA = conditionOrder[a.condition] || 99;
                const orderB = conditionOrder[b.condition] || 99;
                if (orderA !== orderB) return orderA - orderB;
                return b.store_price - a.store_price; // Higher price first for same condition
            });
            
            // Get album image
            const imageUrl = release.image_url || '/static/images/default-record.jpg';
            
            // Build footer HTML - only show if more than 1 copy
            let footerHtml = '';
            if (release.total_copies > 1) {
                footerHtml = `
                    <div class="copies-modal-footer">
                        <span class="footer-total">Total Copies: ${release.total_copies}</span>
                    </div>
                `;
            }
            
            // Create modal content with image
            modal.innerHTML = `
                <div class="copies-modal">
                    <div class="copies-modal-header">
                        <h3>${escapeHtml(release.artist)} - ${escapeHtml(release.title)}</h3>
                        <button class="copies-modal-close">&times;</button>
                    </div>
                    <div class="copies-modal-content">
                        <div class="modal-album-image">
                            <img src="${imageUrl}" alt="${escapeHtml(release.title)}" onerror="this.src='/static/images/default-record.jpg'">
                        </div>
                        <div class="copies-list-with-image">
                            ${sortedCopies.map(copy => {
                                const conditionClass = getConditionClass(copy.condition);
                                const alreadyInCart = isInCart(copy.id);
                                return `
                                    <div class="copy-item">
                                        <div class="copy-item-content">
                                            <span class="copy-condition">
                                                <span class="condition-indicator ${conditionClass}">${copy.condition || 'Unknown'}</span>
                                            </span>
                                            <span class="copy-price">$${copy.store_price.toFixed(2)}</span>
                                        </div>
                                        <button class="add-to-cart-btn ${alreadyInCart ? 'in-cart' : ''}" 
                                                data-copy-id="${copy.id}" 
                                                data-copy-condition="${copy.condition}" 
                                                data-copy-price="${copy.store_price}"
                                                ${alreadyInCart ? 'disabled' : ''}>
                                            <i class="fas ${alreadyInCart ? 'fa-check' : 'fa-cart-plus'}"></i> 
                                            ${alreadyInCart ? 'In Cart' : 'Add to Cart'}
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    ${footerHtml}
                </div>
            `;
            
            // Add click handler to close button
            const closeBtn = modal.querySelector('.copies-modal-close');
            closeBtn.addEventListener('click', () => {
                modal.remove();
            });
            
            // Add click outside to close
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Add event listeners for add to cart buttons
            modal.querySelectorAll('.add-to-cart-btn:not([disabled])').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    
                    const copyId = btn.dataset.copyId;
                    
                    // Find the full copy object
                    const copy = release.copies.find(c => c.id == copyId);
                    
                    if (copy) {
                        const added = addToCart(copy, release);
                        
                        if (added) {
                            // Close the modal after adding to cart
                            modal.remove();
                        }
                    }
                });
            });
            
            document.body.appendChild(modal);
        }

        // Handle YouTube click
        function handleYouTubeClick(youtubeUrl, title) {
            const videoId = extractYouTubeId(youtubeUrl);
            if (!videoId) {
                alert('Invalid YouTube URL');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'youtube-modal-overlay';
            
            modal.innerHTML = `
                <div class="youtube-modal">
                    <div class="youtube-modal-header">
                        <h3>${title}</h3>
                        <button class="youtube-modal-close" onclick="this.closest('.youtube-modal-overlay').remove()">Ã—</button>
                    </div>
                    <div class="youtube-video-container">
                        <iframe 
                            src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen>
                        </iframe>
                    </div>
                </div>
            `;
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }

        // Extract YouTube ID
        function extractYouTubeId(url) {
            if (!url) return null;
            
            const patterns = [
                /youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/,
                /youtu\.be\/([a-zA-Z0-9_-]{11})/,
                /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
                /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }
            
            return null;
        }

        // Apply date filter based on days
        function applyDateFilter(days) {
            const container = document.getElementById('catalogContainer');
            const cards = container.querySelectorAll('.card');
            
            if (days === null || days === undefined) {
                // Show all cards
                cards.forEach(card => {
                    card.style.display = 'block';
                });
                return;
            }
            
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            cutoffDate.setHours(0, 0, 0, 0);
            
            let visibleCount = 0;
            
            cards.forEach(card => {
                const createdDate = card.getAttribute('data-created');
                
                if (!createdDate) {
                    card.style.display = 'none';
                    return;
                }
                
                const cardDate = new Date(createdDate);
                const shouldShow = cardDate >= cutoffDate;
                
                card.style.display = shouldShow ? 'block' : 'none';
                if (shouldShow) visibleCount++;
            });
            
            // Show no results message if needed
            const existingNoResults = container.querySelector('.no-records');
            if (visibleCount === 0) {
                if (!existingNoResults) {
                    const noResultsDiv = document.createElement('div');
                    noResultsDiv.className = 'no-records';
                    noResultsDiv.textContent = 'No records match the selected date range.';
                    container.appendChild(noResultsDiv);
                }
            } else if (existingNoResults) {
                existingNoResults.remove();
            }
        }

        // Initialize search and filter functionality
        function initializeFilters() {
            const searchBox = document.getElementById('searchBox');
            
            // Search functionality
            searchBox.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                const container = document.getElementById('catalogContainer');
                const cards = container.querySelectorAll('.card');
                
                // Get current active date filter
                const activeDateBtn = document.querySelector('.date-preset-btn.active');
                const activeDays = activeDateBtn && activeDateBtn.dataset.days ? parseInt(activeDateBtn.dataset.days) : null;
                
                let visibleCount = 0;
                
                cards.forEach(card => {
                    const artist = card.getAttribute('data-artist') || '';
                    const title = card.getAttribute('data-title') || '';
                    const createdDate = card.getAttribute('data-created');
                    
                    // Check date filter first
                    let dateMatch = true;
                    if (activeDays !== null && createdDate) {
                        const cutoffDate = new Date();
                        cutoffDate.setDate(cutoffDate.getDate() - activeDays);
                        cutoffDate.setHours(0, 0, 0, 0);
                        const cardDate = new Date(createdDate);
                        dateMatch = cardDate >= cutoffDate;
                    }
                    
                    // Then check search
                    const searchMatch = !searchTerm || 
                        artist.includes(searchTerm) || 
                        title.includes(searchTerm);
                    
                    const shouldShow = dateMatch && searchMatch;
                    
                    card.style.display = shouldShow ? 'block' : 'none';
                    if (shouldShow) visibleCount++;
                });
                
                // Show no results message if needed
                const existingNoResults = container.querySelector('.no-records');
                if (visibleCount === 0) {
                    if (!existingNoResults) {
                        const noResultsDiv = document.createElement('div');
                        noResultsDiv.className = 'no-records';
                        noResultsDiv.textContent = 'No records match your search criteria.';
                        container.appendChild(noResultsDiv);
                    }
                } else if (existingNoResults) {
                    existingNoResults.remove();
                }
            });
            
            // Setup date preset buttons
            document.querySelectorAll('.date-preset-btn[data-days]').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all preset buttons
                    document.querySelectorAll('.date-preset-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const days = parseInt(this.dataset.days);
                    applyDateFilter(days);
                    
                    // Also trigger search filter to reapply with new date range
                    const searchEvent = new Event('input');
                    document.getElementById('searchBox').dispatchEvent(searchEvent);
                });
            });
            
            // Clear dates button
            document.getElementById('clearDates').addEventListener('click', function() {
                // Remove active class from all preset buttons
                document.querySelectorAll('.date-preset-btn').forEach(b => b.classList.remove('active'));
                
                // Show all cards
                applyDateFilter(null);
                
                // Trigger search filter
                const searchEvent = new Event('input');
                document.getElementById('searchBox').dispatchEvent(searchEvent);
            });
        }

        // Initialize cart event listeners
        function initializeCart() {
            // Cart toggle click
            document.getElementById('cartToggle').addEventListener('click', openCartDrawer);
            
            // Close cart drawer
            document.getElementById('closeCartDrawer').addEventListener('click', closeCartDrawer);
            
            // Overlay click to close
            document.getElementById('cartOverlay').addEventListener('click', closeCartDrawer);
            
            // Checkout button
            document.getElementById('checkoutBtn').addEventListener('click', function() {
                if (cart.items.length > 0) {
                    alert('Checkout functionality coming soon!');
                    // In the future, this would redirect to checkout page
                    // window.location.href = '/checkout';
                }
            });
        }

        // Load the catalog data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadCart(); // Load cart from localStorage first
            loadCatalogData();
            initializeFilters();
            initializeCart();
            
            // Make removeFromCart function globally available
            window.removeFromCart = removeFromCart;
        });
    </script>
</body>
</html>